{% extends "base.html" %}

{% block title %}Recipe Recommendations - Pet Recipe Website{% endblock %}

{% block content %}
<style>
    /* =============================== 
        Âü∫Á°ÄÂèòÈáèÂíåÂÖ®Â±ÄÊ†∑Âºè
       =============================== */
    :root {
        --primary-color: #510B0B;
        --secondary-color: #B82F0D;
        --accent-color: #5580AD;
        --light-accent: #A1B4B2;
        --warm-accent: #EDBF9D;
        --success-color: #27ae60;
        --error-color: #e74c3c;
        --warning-color: #f39c12;
        --info-color: #3498db;
    }

    /* ‰∏ªÂÆπÂô®Ê†∑Âºè - ‰∏éÂàõÂª∫È°µÈù¢‰∏ÄËá¥ */
    .recommendations-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    /* È°µÈù¢Ê†áÈ¢òÂå∫Âüü - ‰∏éÂàõÂª∫È°µÈù¢Ê†∑Âºè‰∏ÄËá¥ */
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .page-header p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin: 0;
    }

    /* ËøîÂõûÊåâÈíÆÊ†∑Âºè */
    .back-button {
        background: linear-gradient(135deg, #A1B4B2 0%, #5580AD 100%);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0.8rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(85, 128, 173, 0.3);
        margin-bottom: 2rem;
        width: fit-content;
    }

    .back-button:hover {
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(85, 128, 173, 0.4);
    }

    /* Êé®ËçêÁÆóÊ≥ï‰ø°ÊÅØÂç°Áâá */
    .algorithm-info-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        border: 2px solid var(--warm-accent);
    }

    .algorithm-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--warm-accent);
    }

    .algorithm-title {
        font-size: 1.3rem;
        color: var(--primary-color);
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .processing-time {
        background: linear-gradient(135deg, var(--success-color) 0%, #2ecc71 100%);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .stat-item {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        border: 1px solid var(--light-accent);
        transition: all 0.3s ease;
    }

    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent-color);
        display: block;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.3rem;
    }

    /* ÈÄâ‰∏≠È£üÊùêÊëòË¶ÅÂç°Áâá */
    .ingredients-summary-card {
        background: linear-gradient(135deg, var(--warm-accent) 0%, var(--light-accent) 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .summary-title {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary-color);
    }

    .ingredients-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        margin-bottom: 1.5rem;
    }

    .ingredient-pill {
        background: rgba(255, 255, 255, 0.9);
        color: var(--primary-color);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 1px solid rgba(81, 11, 11, 0.2);
    }

    .ingredient-pill:hover {
        background: white;
        transform: scale(1.05);
    }

    .pet-info-summary {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
        border: 1px dashed rgba(81, 11, 11, 0.3);
    }

    .pet-info-title {
        font-size: 1.1rem;
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pet-info-details {
        color: var(--secondary-color);
        font-size: 0.95rem;
    }

    /* Êé®ËçêÈ£üË∞±ÁΩëÊ†º */
    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    /* Êé®ËçêÈ£üË∞±Âç°Áâá - ÂÆåÂÖ®ÈáçÊñ∞ËÆæËÆ° */
    .recommendation-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border: 2px solid var(--warm-accent);
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
    }

    .recommendation-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        border-color: var(--accent-color);
    }

    /* Âç°ÁâáÊ†áÈ¢òÂå∫Âüü */
    .card-header-section {
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--light-accent) 100%);
        padding: 1.5rem;
        position: relative;
        color: white;
    }

    .recipe-title {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .recipe-description {
        font-size: 0.9rem;
        opacity: 0.9;
        line-height: 1.4;
    }

    /* ÂåπÈÖçÂ∫¶ÂæΩÁ´† */
    .match-score-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: 25px;
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }

    /* ÁâπÊÆäÂæΩÁ´†Ê†∑Âºè */
    .special-badge {
        position: absolute;
        top: 50px;
        right: 15px;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
    }

    .popular-badge {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .new-badge {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    /* Âç°ÁâáÂÜÖÂÆπÂå∫Âüü */
    .card-content {
        padding: 1.5rem;
    }

    /* Êé®Ëçê‰∫ÆÁÇπÊòæÁ§∫ */
    .match-highlights-section {
        margin-bottom: 1.5rem;
    }

    .highlights-title {
        font-size: 1rem;
        color: var(--success-color);
        font-weight: bold;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .match-highlights {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .match-highlight {
        background: linear-gradient(45deg, var(--warm-accent), var(--light-accent));
        color: var(--primary-color);
        padding: 0.3rem 0.7rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        animation: highlight-glow 2s ease-in-out infinite alternate;
        border: 1px solid rgba(81, 11, 11, 0.2);
    }

    @keyframes highlight-glow {
        from { box-shadow: 0 0 3px rgba(237, 191, 157, 0.5); }
        to { box-shadow: 0 0 8px rgba(237, 191, 157, 0.8); }
    }

    /* ËØ¶ÁªÜËØÑÂàÜÂ±ïÁ§∫ */
    .score-breakdown {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .score-breakdown-title {
        font-size: 0.9rem;
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .score-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.6rem;
    }

    .score-label {
        min-width: 90px;
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
    }

    .score-bar {
        flex: 1;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        margin: 0 0.8rem;
        overflow: hidden;
        position: relative;
    }

    .score-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
        border-radius: 4px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .score-percent {
        min-width: 35px;
        text-align: right;
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--accent-color);
    }

    /* Ëê•ÂÖªÊëòË¶Å */
    .nutrition-summary {
        margin-bottom: 1.5rem;
    }

    .nutrition-title {
        font-size: 1rem;
        color: var(--accent-color);
        font-weight: bold;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nutrition-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.8rem;
        text-align: center;
    }

    .nutrition-item {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 0.8rem 0.5rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .nutrition-value {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary-color);
        display: block;
    }

    .nutrition-label {
        font-size: 0.7rem;
        color: #666;
        margin-top: 0.2rem;
    }

    /* È£üÊùêÂ±ïÁ§∫ */
    .ingredients-section {
        margin-bottom: 1.5rem;
    }

    .ingredients-title {
        font-size: 1rem;
        color: var(--light-accent);
        font-weight: bold;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .ingredients-pills-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .ingredient-badge {
        background: var(--light-accent);
        color: white;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .more-ingredients-badge {
        background: #6c757d;
        color: white;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    /* Á§æÂå∫ÁªüËÆ° */
    .community-stats {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0 0 0;
        margin-top: 1rem;
        border-top: 1px solid #e9ecef;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .stat-group {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    /* Êìç‰ΩúÊåâÈíÆÂå∫Âüü */
    .card-actions {
        background: #f8f9fa;
        padding: 1rem 1.5rem;
        display: flex;
        gap: 0.8rem;
        justify-content: flex-end;
    }

    .action-btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        text-decoration: none;
    }

    .btn-view {
        background: var(--info-color);
        color: white;
    }

    .btn-view:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    .btn-copy {
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        color: white;
    }

    .btn-copy:hover {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        transform: translateY(-1px);
    }

    /* Êó†Êé®ËçêÁªìÊûúÈ°µÈù¢ */
    .empty-recommendations {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        border: 2px solid var(--warm-accent);
    }

    .empty-icon {
        font-size: 5rem;
        color: var(--light-accent);
        margin-bottom: 1.5rem;
    }

    .empty-title {
        font-size: 1.8rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .empty-description {
        color: #7f8c8d;
        margin-bottom: 2rem;
        font-size: 1.1rem;
        line-height: 1.6;
    }

    .empty-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .empty-btn {
        padding: 1rem 2rem;
        border-radius: 25px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .empty-btn-primary {
        background: linear-gradient(135deg, var(--accent-color), var(--light-accent));
        color: white;
    }

    .empty-btn-secondary {
        background: transparent;
        color: var(--accent-color);
        border: 2px solid var(--accent-color);
    }

    .empty-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    /* Á§æÂå∫ÈìæÊé•Âå∫Âüü */
    .community-section {
        text-align: center;
        margin-top: 3rem;
        padding: 2rem;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .community-description {
        font-size: 1.1rem;
        margin-bottom: 2rem;
        opacity: 0.9;
    }

    .community-link {
        background: linear-gradient(135deg, var(--warm-accent), #f39c12);
        color: var(--primary-color);
        text-decoration: none;
        padding: 1rem 2.5rem;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: bold;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .community-link:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #f39c12, var(--warm-accent));
    }

    /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè - ‰∏éÂÖ∂‰ªñÈ°µÈù¢‰øùÊåÅ‰∏ÄËá¥ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
        display: flex;
        opacity: 1;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        max-width: 800px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        position: relative;
        transform: scale(0.7) translateY(-50px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-overlay.show .modal-content {
        transform: scale(1) translateY(0);
    }

    .modal-header {
        padding: 2rem 2rem 1rem 2rem;
        border-bottom: 2px solid var(--warm-accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.8rem;
        color: var(--primary-color);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 2rem;
        color: var(--secondary-color);
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: var(--secondary-color);
        color: white;
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1rem 2rem 2rem 2rem;
        border-top: 1px solid #f0f0f0;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-btn-secondary {
        background: var(--light-accent);
        color: white;
    }

    .modal-btn-primary {
        background: var(--secondary-color);
        color: white;
    }

    .modal-btn:hover {
        transform: translateY(-2px);
    }

    /* ÊàêÂäüÊ∂àÊÅØÊ†∑Âºè - ‰∏éÂÖ∂‰ªñÈ°µÈù¢‰∏ÄËá¥ */
    .success-message {
        position: fixed;
        top: -80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--warm-accent) 0%, var(--light-accent) 100%);
        color: var(--primary-color);
        padding: 1rem 2rem;
        min-width: 300px;
        max-width: 80vw;
        text-align: center;
        border-radius: 25px;
        box-shadow: 0 8px 32px rgba(81, 11, 11, 0.3);
        border: 2px solid var(--primary-color);
        z-index: 9999;
        font-weight: bold;
        font-size: 1rem;
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        opacity: 0;
        text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
    }

    .success-message.show {
        top: 20px;
        opacity: 1;
        transform: translateX(-50%) scale(1);
    }

    .success-message.hide {
        top: -80px;
        opacity: 0;
        transform: translateX(-50%) scale(0.8);
    }

    .success-message.type-error {
        background: linear-gradient(135deg, var(--error-color) 0%, #c0392b 100%);
        color: white;
        border-color: var(--error-color);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    .success-message.type-info {
        background: linear-gradient(135deg, var(--info-color) 0%, #2980b9 100%);
        color: white;
        border-color: var(--info-color);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 1200px) {
        .recommendations-grid {
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .recommendations-container {
            padding: 0.5rem;
        }

        .page-header {
            padding: 1.5rem;
        }

        .page-header h1 {
            font-size: 2rem;
        }

        .page-header p {
            font-size: 1rem;
        }

        .recommendations-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .nutrition-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .ingredients-pills {
            gap: 0.5rem;
        }

        .ingredient-pill {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .card-actions {
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-btn {
            justify-content: center;
        }

        .empty-actions {
            flex-direction: column;
            align-items: center;
        }

        .modal-content {
            width: 95%;
            margin: 1rem;
        }

        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .page-header h1 {
            font-size: 1.8rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .nutrition-grid {
            grid-template-columns: 1fr;
        }

        .success-message {
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            min-width: 250px;
        }
    }
</style>

<div class="recommendations-container">
    <!-- ËøîÂõûÊåâÈíÆ -->
    <button class="back-button" onclick="handleBackNavigation()">
        <i class="fas fa-arrow-left"></i>
        <span id="backButtonText">Back to Recipe Creation</span>
    </button>

    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="page-header">
        <h1>ü§ñ Smart Recipe Recommendations</h1>
        <p>Personalized suggestions based on your ingredients and pet profile</p>
    </div>

    <!-- Êé®ËçêÁÆóÊ≥ï‰ø°ÊÅØÂ±ïÁ§∫ -->
    {% if recommendation_info %}
    <div class="algorithm-info-card">
        <div class="algorithm-header">
            <h3 class="algorithm-title">
                <i class="fas fa-brain"></i>
                AI Recommendation Engine v{{ recommendation_info.algorithm_version }}
            </h3>
            <div class="processing-time">
                <i class="fas fa-stopwatch"></i>
                {{ recommendation_info.processing_time }}
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-number">{{ recommendation_info.total_analyzed }}</span>
                <div class="stat-label">Recipes Analyzed</div>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ "%.1f"|format(recommendation_info.avg_score * 100) }}%</span>
                <div class="stat-label">Avg Match Score</div>
            </div>
            <div class="stat-item">
                <span class="stat-number">{{ recommendation_info.score_distribution.excellent }}</span>
                <div class="stat-label">Excellent Matches</div>
            </div>
            <div class="stat-item">
                <span class="stat-number">{% if recommendation_info.diversity_ensured %}‚úì{% else %}‚óã{% endif %}</span>
                <div class="stat-label">Diversity Ensured</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ÈÄâÊã©ÁöÑÈ£üÊùêÊëòË¶Å -->
    {% if selected_ingredients %}
    <div class="ingredients-summary-card">
        <h2 class="summary-title">
            <i class="fas fa-utensils"></i>Your Selected Ingredients ({{ selected_ingredients|length }})
        </h2>
        <div class="ingredients-pills">
            {% for ingredient in selected_ingredients %}
            <span class="ingredient-pill">{{ ingredient.name }}</span>
            {% endfor %}
        </div>
        
        {% if pet %}
        <div class="pet-info-summary">
            <div class="pet-info-title">
                <i class="fas fa-paw"></i>Customized for {{ pet.name }}
            </div>
            <div class="pet-info-details">
                {{ pet.species.title() }}, {{ pet.age }} years old, {{ pet.weight }}kg
                {% if pet.special_needs %}
                ‚Ä¢ Special needs: {{ pet.special_needs }}
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Êé®ËçêÁªìÊûú -->
    {% if recommendations %}
    <div class="recommendations-grid">
        {% for rec in recommendations %}
        <div class="recommendation-card">
            <!-- Âç°ÁâáÊ†áÈ¢òÂå∫Âüü -->
            <div class="card-header-section">
                <div class="match-score-badge">{{ "%.0f"|format(rec.recommendation_score * 100) }}% Match</div>
                
                {% if rec.community_stats.likes_count >= 20 %}
                <div class="special-badge popular-badge">
                    <i class="fas fa-fire"></i> Popular
                </div>
                {% endif %}
                
                {% if rec.community_stats.created_days_ago is not none and rec.community_stats.created_days_ago <= 7 %}
                <div class="special-badge new-badge">
                    <i class="fas fa-star"></i> New
                </div>
                {% endif %}

                <h3 class="recipe-title">{{ rec.name }}</h3>
                <p class="recipe-description">
                    {{ rec.description[:120] }}{% if rec.description|length > 120 %}...{% endif %}
                </p>
            </div>

            <!-- Âç°ÁâáÂÜÖÂÆπÂå∫Âüü -->
            <div class="card-content">
                <!-- Êé®Ëçê‰∫ÆÁÇπÊòæÁ§∫ -->
                <div class="match-highlights-section">
                    <div class="highlights-title">
                        <i class="fas fa-star"></i> Why We Recommend:
                    </div>
                    <div class="match-highlights">
                        {% for highlight in rec.match_highlights %}
                        <span class="match-highlight">{{ highlight }}</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- ËØ¶ÁªÜËØÑÂàÜÂ±ïÁ§∫ -->
                <div class="score-breakdown">
                    <div class="score-breakdown-title">
                        <i class="fas fa-chart-bar"></i> Match Analysis
                    </div>
                    
                    <div class="score-item">
                        <div class="score-label">Ingredients</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: {{ rec.score_breakdown.ingredient_similarity * 100 }}%"></div>
                        </div>
                        <div class="score-percent">{{ "%.0f"|format(rec.score_breakdown.ingredient_similarity * 100) }}%</div>
                    </div>
                    
                    <div class="score-item">
                        <div class="score-label">Nutrition</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: {{ rec.score_breakdown.nutrition_match * 100 }}%"></div>
                        </div>
                        <div class="score-percent">{{ "%.0f"|format(rec.score_breakdown.nutrition_match * 100) }}%</div>
                    </div>
                    
                    <div class="score-item">
                        <div class="score-label">Pet Fit</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: {{ rec.score_breakdown.pet_suitability * 100 }}%"></div>
                        </div>
                        <div class="score-percent">{{ "%.0f"|format(rec.score_breakdown.pet_suitability * 100) }}%</div>
                    </div>
                    
                    {% if rec.score_breakdown.popularity_score > 0 %}
                    <div class="score-item">
                        <div class="score-label">Community</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: {{ rec.score_breakdown.popularity_score * 100 }}%"></div>
                        </div>
                        <div class="score-percent">{{ "%.0f"|format(rec.score_breakdown.popularity_score * 100) }}%</div>
                    </div>
                    {% endif %}
                </div>

                <!-- Ëê•ÂÖª‰ø°ÊÅØÊëòË¶Å -->
                <div class="nutrition-summary">
                    <div class="nutrition-title">
                        <i class="fas fa-chart-pie"></i> Nutrition Profile (per 100g)
                    </div>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <span class="nutrition-value">{{ rec.nutrition_ratios.protein_percent }}%</span>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-value">{{ rec.nutrition_ratios.fat_percent }}%</span>
                            <div class="nutrition-label">Fat</div>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-value">{{ rec.nutrition_ratios.carb_percent }}%</span>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-value">{{ rec.nutrition_ratios.calories_per_100g }}</span>
                            <div class="nutrition-label">Calories</div>
                        </div>
                    </div>
                </div>

                <!-- ‰∏ªË¶ÅÈ£üÊùêÂ±ïÁ§∫ -->
                <div class="ingredients-section">
                    <div class="ingredients-title">
                        <i class="fas fa-list"></i> Main Ingredients
                    </div>
                    <div class="ingredients-pills-list">
                        {% for ingredient in rec.ingredients[:6] %}
                        <span class="ingredient-badge">{{ ingredient.name }} ({{ ingredient.percentage }}%)</span>
                        {% endfor %}
                        {% if rec.ingredients|length > 6 %}
                        <span class="more-ingredients-badge">+{{ rec.ingredients|length - 6 }} more</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Á§æÂå∫ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="community-stats">
                    <div class="stat-group">
                        <i class="fas fa-heart text-danger"></i>
                        <span>{{ rec.community_stats.likes_count }}</span>
                    </div>
                    <div class="stat-group">
                        <i class="fas fa-copy text-info"></i>
                        <span>{{ rec.community_stats.usage_count }} uses</span>
                    </div>
                    {% if rec.community_stats.created_days_ago is not none %}
                    <div class="stat-group">
                        <i class="fas fa-clock"></i>
                        <span>{{ rec.community_stats.created_days_ago }} days ago</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="card-actions">
                <button class="action-btn btn-view" onclick="viewRecipeDetails({{ rec.recipe_id }})">
                    <i class="fas fa-eye"></i>View Details
                </button>
                <button class="action-btn btn-copy" onclick="copyRecipeToAccount({{ rec.recipe_id }}, '{{ rec.name|replace("'", "\\'") }}')">
                    <i class="fas fa-copy"></i>Copy Recipe
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Á§æÂå∫ÈìæÊé•Âå∫Âüü -->
    <div class="community-section">
        <p class="community-description">
            <strong>Want more recipe inspiration?</strong><br>
            Explore our vibrant community for thousands of pet recipes shared by fellow pet owners!
        </p>
        <a href="{{ url_for('main.community') }}" class="community-link">
            <i class="fas fa-users"></i>Browse Community Recipes
        </a>
    </div>

    {% else %}
    <!-- Êó†Êé®ËçêÁªìÊûúÈ°µÈù¢ -->
    <div class="empty-recommendations">
        <div class="empty-icon">
            <i class="fas fa-search"></i>
        </div>
        <h3 class="empty-title">No Matching Recipes Found</h3>
        <p class="empty-description">
            We couldn't find recipes that perfectly match your selected ingredients and pet's needs.<br>
            Try adjusting your ingredient selection or explore our community for more options.
        </p>
        
        <div class="empty-actions">
            <button class="empty-btn empty-btn-primary" onclick="history.back()">
                <i class="fas fa-arrow-left"></i>Back to Selection
            </button>
            <a href="{{ url_for('main.community') }}" class="empty-btn empty-btn-secondary">
                <i class="fas fa-users"></i>Browse Community
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- È£üË∞±ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div class="modal-overlay" id="recipeDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="recipeDetailsModalTitle">Recipe Details</h3>
            <button class="modal-close" onclick="closePlanDetail()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="recipeDetailsContent">
            <div style="text-align: center; padding: 2rem;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                <span style="color: #666;">Loading recipe details...</span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="closePlanDetail()">Close</button>
            <button class="modal-btn modal-btn-primary" id="copyFromModal" onclick="copyCurrentRecipe()">
                <i class="fas fa-copy"></i>Copy This Recipe
            </button>
        </div>
    </div>
</div>

<!-- Â§çÂà∂Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
<div class="modal-overlay" id="copyConfirmModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Copy Recipe to Your Account</h3>
            <button class="modal-close" onclick="closeCopyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="copyRecipeForm">
                <div class="form-group">
                    <label for="newRecipeName">Recipe Name:</label>
                    <input type="text" class="form-control" id="newRecipeName" required style="width: 100%; padding: 0.8rem; border: 2px solid #A1B4B2; border-radius: 8px; font-size: 1rem;">
                </div>
                
                {% if pet %}
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="associateWithPet" checked style="margin-right: 0.5rem;">
                        Associate with {{ pet.name }} ({{ pet.species.title() }})
                    </label>
                </div>
                {% endif %}
                
                <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                    <i class="fas fa-info-circle" style="color: #2196f3; margin-right: 0.5rem;"></i>
                    This recipe will be copied to your personal collection as a draft. You can modify it as needed.
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="closeCopyModal()">Cancel</button>
            <button class="modal-btn modal-btn-primary" onclick="confirmCopyRecipe()">
                <i class="fas fa-copy"></i>Copy Recipe
            </button>
        </div>
    </div>
</div>

<script>
// ÂÖ®Â±ÄÂèòÈáè
let currentRecipeId = null;

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
});

// ÂàùÂßãÂåñÈ°µÈù¢ÂäüËÉΩ
function initializePage() {
    // ËÆæÁΩÆËøîÂõûÊåâÈíÆÊñáÊú¨
    setBackButtonText();
    
    // ‰∏∫ËØÑÂàÜÊù°Ê∑ªÂä†Âä®ÁîªÊïàÊûú
    animateScoreBars();
    
    // ‰∏∫Êé®ËçêÂç°ÁâáÊ∑ªÂä†Ê∏êÂÖ•Âä®Áîª
    animateRecommendationCards();
    
    // ‰∏∫ÁªüËÆ°Êï∞Â≠óÊ∑ªÂä†ËÆ°Êï∞Âä®Áîª
    animateStatNumbers();
    
    // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ
    addKeyboardSupport();
}

// ËÆæÁΩÆËøîÂõûÊåâÈíÆÊñáÊú¨
function setBackButtonText() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromPage = urlParams.get('from');
    const backButtonText = document.getElementById('backButtonText');
    
    if (fromPage === 'create_recipe' && backButtonText) {
        backButtonText.textContent = 'Back to Recipe Creation';
    } else {
        backButtonText.textContent = 'Back';
    }
}

// Êô∫ËÉΩËøîÂõûÂØºËà™Â§ÑÁêÜ
function handleBackNavigation() {
    const urlParams = new URLSearchParams(window.location.search);
    const fromPage = urlParams.get('from');
    
    if (fromPage === 'create_recipe') {
        // ‰ªéÂàõÂª∫È£üË∞±È°µÈù¢Êù•ÁöÑÔºåËøîÂõûÂàõÂª∫È°µÈù¢
        if (confirm('Return to recipe creation? Your selected ingredients and progress will be restored.')) {
            window.location.href = '/recipe/create_recipe';
        }
    } else {
        // ÂÖ∂‰ªñÊÉÖÂÜµÔºå‰ΩøÁî®ÊµèËßàÂô®ÂéÜÂè≤ËøîÂõû
        history.back();
    }
}

// ‰∏∫ËØÑÂàÜÊù°Ê∑ªÂä†Âä®ÁîªÊïàÊûú
function animateScoreBars() {
    const scoreItems = document.querySelectorAll('.score-fill');
    scoreItems.forEach((item, index) => {
        const width = item.style.width;
        item.style.width = '0%';
        setTimeout(() => {
            item.style.width = width;
        }, 300 + index * 100); // ÈîôÂºÄÂä®ÁîªÊó∂Èó¥
    });
}

// ‰∏∫Êé®ËçêÂç°ÁâáÊ∑ªÂä†Ê∏êÂÖ•Âä®Áîª
function animateRecommendationCards() {
    const cards = document.querySelectorAll('.recommendation-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150); // ÈîôÂºÄÂä®ÁîªÊó∂Èó¥
    });
}

// ‰∏∫ÁªüËÆ°Êï∞Â≠óÊ∑ªÂä†ËÆ°Êï∞Âä®Áîª
function animateStatNumbers() {
    const statNumbers = document.querySelectorAll('.stat-number');
    statNumbers.forEach(stat => {
        const finalValue = stat.textContent.trim();
        const isPercentage = finalValue.includes('%');
        const numValue = parseInt(finalValue.replace(/[^\d]/g, ''));
        
        if (!isNaN(numValue) && numValue > 0) {
            animateCounter(stat, 0, numValue, isPercentage ? '%' : '', 1500);
        }
    });
}

// Êï∞Â≠óËÆ°Êï∞Âô®Âä®Áîª
function animateCounter(element, start, end, suffix, duration) {
    const range = end - start;
    const increment = range / (duration / 16); // 60fps
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= end) {
            current = end;
            clearInterval(timer);
        }
        element.textContent = Math.floor(current) + suffix;
    }, 16);
}

// Êü•ÁúãÈ£üË∞±ËØ¶ÊÉÖÂäüËÉΩ
function viewRecipeDetails(recipeId) {
    currentRecipeId = recipeId;
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    const modal = document.getElementById('recipeDetailsModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // ÈáçÁΩÆÂÜÖÂÆπ‰∏∫Âä†ËΩΩÁä∂ÊÄÅ
    document.getElementById('recipeDetailsContent').innerHTML = `
        <div style="text-align: center; padding: 2rem;">
            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <span style="color: #666;">Loading recipe details...</span>
        </div>
    `;
    
    // Ëé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ
    fetch(`/api/recipe/${recipeId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRecipeDetails(data.recipe);
            } else {
                showErrorInModal(data.error || 'Failed to load recipe details');
            }
        })
        .catch(error => {
            console.error('Ëé∑ÂèñÈ£üË∞±ËØ¶ÊÉÖÂ§±Ë¥•:', error);
            showErrorInModal('Network error, please try again later');
        });
}

// Âú®Ê®°ÊÄÅÊ°Ü‰∏≠ÊòæÁ§∫ÈîôËØØ
function showErrorInModal(errorMessage) {
    document.getElementById('recipeDetailsContent').innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--error-color);">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>${escapeHtml(errorMessage)}</p>
        </div>
    `;
}

// ÊòæÁ§∫ËØ¶ÁªÜÈ£üË∞±‰ø°ÊÅØ
function displayRecipeDetails(recipe) {
    const title = document.getElementById('recipeDetailsModalTitle');
    const content = document.getElementById('recipeDetailsContent');
    
    title.textContent = recipe.name;
    
    let html = '';
    
    // È£üË∞±ÊèèËø∞Âå∫Âüü
    if (recipe.description) {
        html += `
            <div style="margin-bottom: 2rem;">
                <h4 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-info-circle"></i> Description
                </h4>
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid var(--accent-color);">
                    <p style="margin: 0; line-height: 1.6; color: #555;">${escapeHtml(recipe.description)}</p>
                </div>
            </div>
        `;
    }
    
    // È£üÊùêÂàóË°®Âå∫Âüü
    if (recipe.ingredients && recipe.ingredients.length > 0) {
        html += `
            <div style="margin-bottom: 2rem;">
                <h4 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-list"></i> Ingredients (${recipe.ingredients.length})
                </h4>
                <div style="background: #f8f9fa; border-radius: 10px; overflow: hidden; border: 1px solid #e9ecef;">
                    ${recipe.ingredients.map((ingredient, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; ${index < recipe.ingredients.length - 1 ? 'border-bottom: 1px solid #e9ecef;' : ''}">
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <span style="background: var(--accent-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">${index + 1}</span>
                                <span style="font-weight: 600; color: var(--primary-color);">${escapeHtml(ingredient.name)}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--accent-color); font-weight: 700; font-size: 1.1rem;">${ingredient.weight}g</div>
                                <div style="color: #666; font-size: 0.8rem;">${ingredient.percentage}%</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Ëê•ÂÖª‰ø°ÊÅØÂå∫Âüü
    if (recipe.nutrition) {
        html += `
            <div style="margin-bottom: 2rem;">
                <h4 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-pie"></i> Nutrition Information
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.2rem; border-radius: 10px; text-align: center; border: 1px solid var(--light-accent);">
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--error-color); margin-bottom: 0.3rem;">${recipe.nutrition.total_calories ? recipe.nutrition.total_calories.toFixed(1) : '0'}</div>
                        <div style="font-size: 0.85rem; color: #666; font-weight: 600;">Calories</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.2rem; border-radius: 10px; text-align: center; border: 1px solid var(--light-accent);">
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--success-color); margin-bottom: 0.3rem;">${recipe.nutrition.total_protein ? recipe.nutrition.total_protein.toFixed(1) : '0'}</div>
                        <div style="font-size: 0.85rem; color: #666; font-weight: 600;">Protein (g)</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.2rem; border-radius: 10px; text-align: center; border: 1px solid var(--light-accent);">
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--warning-color); margin-bottom: 0.3rem;">${recipe.nutrition.total_fat ? recipe.nutrition.total_fat.toFixed(1) : '0'}</div>
                        <div style="font-size: 0.85rem; color: #666; font-weight: 600;">Fat (g)</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.2rem; border-radius: 10px; text-align: center; border: 1px solid var(--light-accent);">
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--info-color); margin-bottom: 0.3rem;">${recipe.nutrition.total_carbs ? recipe.nutrition.total_carbs.toFixed(1) : '0'}</div>
                        <div style="font-size: 0.85rem; color: #666; font-weight: 600;">Carbs (g)</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Ëê•ÂÖªÂàÜÊûêËØÑ‰º∞ÔºàÂ¶ÇÊûúÊúâÔºâ
    if (recipe.nutrition_analysis) {
        html += `
            <div style="margin-bottom: 2rem;">
                <h4 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-microscope"></i> Nutrition Analysis
                </h4>
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); padding: 1.5rem; border-radius: 10px; border: 1px solid var(--success-color);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong style="color: var(--primary-color);">Calcium-Phosphorus Ratio:</strong><br>
                            <span style="color: var(--accent-color); font-size: 1.1rem; font-weight: bold;">${recipe.nutrition_analysis.calcium_phosphorus_ratio}</span>
                            <small style="display: block; color: #666; margin-top: 0.2rem;">${recipe.nutrition_analysis.calcium_phosphorus_status.message}</small>
                        </div>
                        <div>
                            <strong style="color: var(--primary-color);">Protein Quality:</strong><br>
                            <span style="color: var(--accent-color); font-size: 1.1rem; font-weight: bold;">${recipe.nutrition_analysis.protein_quality.level.toUpperCase()}</span>
                            <small style="display: block; color: #666; margin-top: 0.2rem;">${recipe.nutrition_analysis.protein_quality.message}</small>
                        </div>
                    </div>
                    <div style="text-align: center; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1);">
                        <strong style="color: var(--primary-color);">Overall Balance:</strong>
                        <span style="background: var(--success-color); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; margin-left: 0.5rem; font-weight: bold;">
                            ${recipe.nutrition_analysis.overall_balance.score.toUpperCase()}
                        </span>
                        <br><small style="color: #666; margin-top: 0.5rem; display: block;">${recipe.nutrition_analysis.overall_balance.message}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    content.innerHTML = html;
}

// Â§çÂà∂È£üË∞±Âà∞Ë¥¶Êà∑
function copyRecipeToAccount(recipeId, recipeName) {
    if (!checkLoginStatus()) {
        return;
    }
    
    currentRecipeId = recipeId;
    document.getElementById('newRecipeName').value = recipeName + ' (My Copy)';
    
    const modal = document.getElementById('copyConfirmModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// ‰ªéËØ¶ÊÉÖÊ®°ÊÄÅÊ°ÜÂ§çÂà∂
function copyCurrentRecipe() {
    if (currentRecipeId) {
        closePlanDetail();
        
        // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÈ£üË∞±ÂêçÁß∞
        const recipeName = document.getElementById('recipeDetailsModalTitle').textContent;
        copyRecipeToAccount(currentRecipeId, recipeName);
    }
}

// Á°ÆËÆ§Â§çÂà∂È£üË∞±
function confirmCopyRecipe() {
    const newName = document.getElementById('newRecipeName').value.trim();
    const associateWithPet = document.getElementById('associateWithPet')?.checked;
    
    if (!newName) {
        showSuccessMessage('Please enter a name for the recipe', 'type-error');
        return;
    }
    
    const requestData = {
        name: newName
    };
    
    {% if pet %}
    if (associateWithPet) {
        requestData.pet_id = {{ pet.id }};
    }
    {% endif %}
    
    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    const copyBtn = document.querySelector('#copyConfirmModal .modal-btn-primary');
    const originalText = copyBtn.innerHTML;
    copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
    copyBtn.disabled = true;
    
    fetch(`/api/recipe/${currentRecipeId}/copy`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Recipe copied successfully! Redirecting to your recipes...');
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeCopyModal();
            
            // 2ÁßíÂêéË∑≥ËΩ¨Âà∞‰∏™‰∫∫È£üË∞±È°µÈù¢
            setTimeout(() => {
                window.location.href = `/user_center?highlight=${data.recipe_id}`;
            }, 2000);
        } else {
            showSuccessMessage(data.error || 'Copy failed', 'type-error');
        }
    })
    .catch(error => {
        console.error('Â§çÂà∂È£üË∞±Â§±Ë¥•:', error);
        showSuccessMessage('Network error, please try again later', 'type-error');
    })
    .finally(() => {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        copyBtn.innerHTML = originalText;
        copyBtn.disabled = false;
    });
}

// ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
function closePlanDetail() {
    const modal = document.getElementById('recipeDetailsModal');
    modal.classList.remove('show');
    setTimeout(() => {
        document.body.style.overflow = '';
        currentRecipeId = null;
    }, 300);
}

// ÂÖ≥Èó≠Â§çÂà∂Ê®°ÊÄÅÊ°Ü
function closeCopyModal() {
    const modal = document.getElementById('copyConfirmModal');
    modal.classList.remove('show');
    setTimeout(() => {
        document.body.style.overflow = '';
    }, 300);
}

// Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
function checkLoginStatus() {
    {% if not session.user_id %}
    showSuccessMessage('Please log in first to copy recipes', 'type-info');
    setTimeout(() => {
        window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.href);
    }, 2000);
    return false;
    {% endif %}
    return true;
}

// ÊòæÁ§∫ÊàêÂäü/ÈîôËØØÊ∂àÊÅØ
function showSuccessMessage(message, type = 'type-success') {
    // ÁßªÈô§Áé∞ÊúâÊ∂àÊÅØ
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // ÂàõÂª∫Êñ∞Ê∂àÊÅØ
    const msgEl = document.createElement('div');
    msgEl.className = `success-message show ${type}`;
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // Ëá™Âä®ÈöêËóè
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, type.includes('error') ? 5000 : 3000);
}

// HTMLËΩ¨‰πâÂáΩÊï∞
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ
function addKeyboardSupport() {
    document.addEventListener('keydown', function(event) {
        // ESC ÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        if (event.key === 'Escape') {
            closePlanDetail();
            closeCopyModal();
        }
        
        // Ctrl/Cmd + Êï∞Â≠óÈîÆÂø´ÈÄüÂ§çÂà∂ÂØπÂ∫îÊé®Ëçê
        if ((event.ctrlKey || event.metaKey) && event.key >= '1' && event.key <= '9') {
            event.preventDefault();
            const index = parseInt(event.key) - 1;
            const copyButtons = document.querySelectorAll('.btn-copy');
            if (copyButtons[index]) {
                copyButtons[index].click();
            }
        }
    });
}

// ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal-overlay')) {
        closePlanDetail();
        closeCopyModal();
    }
});

// Ê∑ªÂä† CSS Âä®ÁîªÂÖ≥ÈîÆÂ∏ß
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}