{% extends "base.html" %}

{% block title %}Community - Pet Recipe Website{% endblock %}

{% block content %}
<style>
    /* ç»§æ‰¿åŸºç¡€æ ·å¼å˜é‡ */
    :root {
        --primary-color: #510B0B;
        --secondary-color: #B82F0D;
        --accent-color: #5580AD;
        --light-accent: #A1B4B2;
        --warm-accent: #EDBF9D;
        --success-color: #27ae60;
        --error-color: #e74c3c;
        --warning-color: #f39c12;
    }

    /* ç¤¾åŒºæ¬¢è¿åŒºåŸŸ */
    .community-hero {
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .community-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="paw" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="15" cy="5" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="15" r="3" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23paw)"/></svg>') repeat;
        opacity: 0.3;
        z-index: 0;
    }

    .community-hero-content {
        position: relative;
        z-index: 1;
    }

    .community-hero h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }

    .community-hero p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 1.5rem;
    }

    .community-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.15);
        padding: 1rem;
        border-radius: 12px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
        color: #EDBF9D;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 0.3rem;
    }

    /* æ§åˆ¶é¢æ¿åŒºåŸŸ */
    .community-controls {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        border: 2px solid var(--warm-accent);
    }

    .controls-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .controls-left {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex: 1;
    }

    .controls-right {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .search-box {
        flex: 1;
        max-width: 400px;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.8rem 1rem 0.8rem 2.5rem;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(85, 128, 173, 0.1);
        background: white;
    }

    .search-icon {
        position: absolute;
        left: 0.8rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 1rem;
    }

    .sort-select, .filter-select {
        padding: 0.6rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
    }

    .sort-select:focus, .filter-select:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .view-toggle {
        display: flex;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }

    .view-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6c757d;
    }

    .view-btn.active {
        background: var(--accent-color);
        color: white;
    }

    .view-btn:hover:not(.active) {
        background: #e9ecef;
    }

    /* é£Ÿè°±ç½‘æ ¼å¸ƒå±€ */
    .recipes-container {
        margin-bottom: 2rem;
    }

    .recipes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .recipes-grid.list-view {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    /* ç¤¾åŒºé£Ÿè°±å¡ç‰‡ */
    .recipe-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 2px solid var(--warm-accent);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        height: 380px;
        display: flex;
        flex-direction: column;
    }

    .recipe-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-color: var(--accent-color);
    }

    .recipe-card.list-view {
        height: auto;
        flex-direction: row;
        align-items: center;
        padding: 1.5rem;
    }

    /* é£Ÿè°±å¡ç‰‡å¤´éƒ¨ */
    .recipe-header {
        position: relative;
        background: linear-gradient(135deg, var(--warm-accent) 0%, var(--light-accent) 100%);
        padding: 1.5rem;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .recipe-card.list-view .recipe-header {
        width: 120px;
        height: 120px;
        border-radius: 12px;
        margin-right: 1.5rem;
        flex-shrink: 0;
    }

    .recipe-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .recipe-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 0.5rem;
        z-index: 10;
    }

    .action-btn {
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        backdrop-filter: blur(5px);
    }

    .action-btn:hover {
        background: white;
        transform: scale(1.1);
    }

    .like-btn.loved {
        color: #e74c3c;
    }

    .like-btn:not(.loved) {
        color: #bdc3c7;
    }

    .favorite-btn.favorited {
        color: #f1c40f;
    }

    .favorite-btn:not(.favorited) {
        color: #bdc3c7;
    }

    /* é£Ÿè°±å†…å®¹åŒºåŸŸ */
    .recipe-content {
        padding: 1.2rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .recipe-card.list-view .recipe-content {
        padding: 0;
        flex: 1;
    }

    .recipe-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.6rem;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .recipe-description {
        color: #7f8c8d;
        font-size: 0.9rem;
        line-height: 1.4;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        flex: 1;
    }

    .recipe-author {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.8rem;
        font-size: 0.85rem;
        color: var(--secondary-color);
    }

    .author-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--accent-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
    }

    .recipe-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: #95a5a6;
        border-top: 1px solid #ecf0f1;
        padding-top: 0.8rem;
    }

    .recipe-stats {
        display: flex;
        gap: 1rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .recipe-date {
        color: #95a5a6;
    }

    /* è¥å…»ä¿¡æ¯å±•ç¤º */
    .nutrition-preview {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.8rem;
    }

    .nutrition-item {
        background: #f8f9fa;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        color: #6c757d;
        border: 1px solid #e9ecef;
    }

    /* é£Ÿè°±è¯¦æƒ…æ¨¡æ€æ¡† */
    .recipe-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .recipe-modal-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
    }

    .recipe-modal-content {
        background: white;
        border-radius: 20px;
        padding: 0;
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        transform: scale(0.7) translateY(-50px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .recipe-modal-overlay.show .recipe-modal-content {
        transform: scale(1) translateY(0);
    }

    .recipe-modal-header {
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--light-accent) 100%);
        color: white;
        padding: 2rem;
        border-radius: 20px 20px 0 0;
        position: relative;
    }

    .recipe-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .recipe-modal-close:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .recipe-modal-title {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        padding-right: 3rem;
    }

    .recipe-modal-meta {
        display: flex;
        align-items: center;
        gap: 2rem;
        opacity: 0.9;
    }

    .recipe-modal-body {
        padding: 2rem;
    }

    .modal-section {
        margin-bottom: 2rem;
    }

    .modal-section:last-child {
        margin-bottom: 0;
    }

    .modal-section-title {
        font-size: 1.3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--warm-accent);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .ingredients-list {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 12px;
        border: 1px solid #e9ecef;
        overflow: hidden;
    }

    .ingredient-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .ingredient-item:last-child {
        border-bottom: none;
    }

    .ingredient-item:hover {
        background: linear-gradient(135deg, var(--warm-accent)10 0%, var(--warm-accent)20 100%);
    }

    .ingredient-name {
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .ingredient-weight {
        color: var(--accent-color);
        font-weight: 700;
        background: rgba(85, 128, 173, 0.1);
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        border: 1px solid var(--accent-color);
    }

    .nutrition-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .nutrition-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 1.2rem;
        border-radius: 12px;
        text-align: center;
        border: 2px solid var(--warm-accent);
        transition: all 0.3s ease;
    }

    .nutrition-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-color: var(--accent-color);
    }

    .nutrition-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--accent-color);
        margin-bottom: 0.3rem;
    }

    .nutrition-label {
        color: var(--primary-color);
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.2rem;
    }

    .nutrition-unit {
        color: var(--secondary-color);
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* é£Ÿè°±å¡ç‰‡çŠ¶æ€å›¾æ ‡ï¼ˆä¸å¯äº¤äº’ï¼‰ */
    .action-status {
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        backdrop-filter: blur(5px);
        pointer-events: none; /* ä¸å¯äº¤äº’ */
    }

    /* æ¨¡æ€æ¡†äº¤äº’æ“ä½œæ  */
    .recipe-interaction-bar {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 15px;
        padding: 1.5rem;
        border: 2px solid var(--warm-accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
        margin-bottom: 1rem;
    }

    .interaction-stats {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    .interaction-stats .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        color: var(--accent-color);
    }

    .interaction-stats .stat-item i {
        font-size: 1.2rem;
        margin-bottom: 0.2rem;
    }

    .interaction-stats .stat-item span {
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .interaction-stats .stat-item small {
        font-size: 0.8rem;
        color: #7f8c8d;
        font-weight: 500;
    }

    .interaction-buttons {
        display: flex;
        gap: 1rem;
    }

    /* äº¤äº’æŒ‰é’®æ ·å¼ */
    .interaction-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem 1.5rem;
        border: 2px solid;
        border-radius: 25px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 600;
        min-width: 100px;
        justify-content: center;
    }

    .interaction-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .interaction-btn i {
        font-size: 1rem;
    }

    /* ç‚¹èµæŒ‰é’®æ ·å¼ */
    .like-btn {
        border-color: #e9ecef;
        color: #6c757d;
    }

    .like-btn:hover:not(:disabled) {
        border-color: #e74c3c;
        color: #e74c3c;
        background: rgba(231, 76, 60, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
    }

    .like-btn.loved {
        border-color: #e74c3c;
        color: white;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .like-btn.loved:hover:not(:disabled) {
        background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    /* æ”¶è—æŒ‰é’®æ ·å¼ */
    .favorite-btn {
        border-color: #e9ecef;
        color: #6c757d;
    }

    .favorite-btn:hover:not(:disabled) {
        border-color: #f1c40f;
        color: #f39c12;
        background: rgba(241, 196, 15, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(241, 196, 15, 0.2);
    }

    .favorite-btn.favorited {
        border-color: #f1c40f;
        color: white;
        background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
    }

    .favorite-btn.favorited:hover:not(:disabled) {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(241, 196, 15, 0.3);
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading-state {
        text-align: center;
        padding: 3rem;
        color: #7f8c8d;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #7f8c8d;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #bdc3c7;
    }

    .empty-state h3 {
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .empty-state p {
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
    }

    /* åˆ†é¡µæ§ä»¶ */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .page-btn {
        padding: 0.6rem 1rem;
        border: 2px solid #dee2e6;
        background: white;
        color: #6c757d;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        min-width: 40px;
        text-align: center;
    }

    .page-btn:hover:not(.disabled) {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    .page-btn.active {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
    }

    .page-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-info {
        padding: 0.6rem 1rem;
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* Toast æ¶ˆæ¯æ ·å¼ */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 400px;
    }

    .toast-success {
        background: var(--success-color);
    }

    .toast-error {
        background: var(--error-color);
    }

    .toast-info {
        background: var(--accent-color);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .community-hero h1 {
            font-size: 2rem;
            flex-direction: column;
            gap: 0.5rem;
        }

        .community-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .controls-row {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .controls-left,
        .controls-right {
            flex-direction: column;
            gap: 0.8rem;
        }

        .search-box {
            max-width: none;
        }

        .recipes-grid {
            grid-template-columns: 1fr;
        }

        .recipe-card.list-view {
            flex-direction: column;
            height: auto;
        }

        .recipe-card.list-view .recipe-header {
            width: 100%;
            height: 120px;
            margin-right: 0;
            margin-bottom: 1rem;
        }

        .recipe-card.list-view .recipe-content {
            padding: 1.2rem;
        }

        .pagination {
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .recipe-modal-content {
            width: 95%;
            max-height: 95vh;
        }

        .recipe-modal-header {
            padding: 1.5rem;
        }

        .recipe-modal-title {
            font-size: 1.5rem;
        }

        .recipe-modal-body {
            padding: 1.5rem;
        }

        .nutrition-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
        }

        .recipe-interaction-bar {
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.2rem;
        }
        
        .interaction-stats {
            gap: 1.5rem;
        }
        
        .interaction-buttons {
            width: 100%;
            justify-content: space-around;
        }
        
        .interaction-btn {
            flex: 1;
            min-width: auto;
        }
    }

    @media (max-width: 480px) {
        .community-hero {
            padding: 1.5rem;
        }

        .community-controls {
            padding: 1rem;
        }

        .recipes-grid {
            gap: 1rem;
        }

        .recipe-card {
            height: 350px;
        }

        .community-stats {
            grid-template-columns: 1fr;
        }

        .nutrition-grid {
            grid-template-columns: 1fr;
        }

        .interaction-stats {
            gap: 1rem;
        }
        
        .interaction-stats .stat-item span {
            font-size: 1.2rem;
        }
        
        .interaction-btn {
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
        }
        
        .interaction-btn span {
            display: none;
        }
        
        .interaction-btn i {
            font-size: 1.1rem;
        }
    }

    /* åŠ¨ç”»å®šä¹‰ */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .recipe-card {
        animation: fadeInUp 0.6s ease forwards;
    }

    .recipe-card:nth-child(odd) {
        animation-delay: 0.1s;
    }

    .recipe-card:nth-child(even) {
        animation-delay: 0.2s;
    }
</style>

<!-- ç¤¾åŒºæ¬¢è¿åŒºåŸŸ -->
<div class="community-hero">
    <div class="community-hero-content">
        <h1>
            <i class="fas fa-users"></i>
            Community Recipe Hub
        </h1>
        <p>Discover amazing pet recipes shared by loving pet owners from around the world</p>
        
        <div class="community-stats" id="communityStats">
            <div class="stat-card">
                <span class="stat-number" id="totalRecipes">-</span>
                <span class="stat-label">Recipes</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="activeUsers">-</span>
                <span class="stat-label">Contributors</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalLikes">-</span>
                <span class="stat-label">Likes</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalFavorites">-</span>
                <span class="stat-label">Favorites</span>
            </div>
        </div>
    </div>
</div>

<!-- æ§åˆ¶é¢æ¿ -->
<div class="community-controls">
    <div class="controls-row">
        <div class="controls-left">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchInput" 
                    placeholder="Search recipes, authors, or ingredients...">
            </div>
        </div>
        
        <div class="controls-right">
            <select class="sort-select" id="sortSelect">
                <option value="hot">ğŸ”¥ Hot</option>
                <option value="newest">ğŸ†• Newest</option>
                <option value="oldest">â° Oldest</option>
                <option value="likes">â¤ï¸ Most Liked</option>
                <option value="name">ğŸ“ A-Z</option>
            </select>
            
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" id="gridViewBtn">
                    <i class="fas fa-th"></i>
                </button>
                <button class="view-btn" data-view="list" id="listViewBtn">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- é£Ÿè°±å®¹å™¨ -->
<div class="recipes-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading-state" id="loadingState">
        <div class="loading-spinner"></div>
        <p>Loading delicious recipes...</p>
    </div>
    
    <!-- é£Ÿè°±ç½‘æ ¼ -->
    <div class="recipes-grid" id="recipesGrid" style="display: none;">
        <!-- åŠ¨æ€åŠ è½½é£Ÿè°±å¡ç‰‡ -->
    </div>
    
    <!-- ç©ºçŠ¶æ€ -->
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">ğŸ½ï¸</div>
        <h3>No recipes found</h3>
        <p id="emptyMessage">No recipes match your current search criteria.</p>
        <button class="btn btn-primary" onclick="clearFilters()">
            <i class="fas fa-refresh"></i> Clear Filters
        </button>
    </div>
</div>

<!-- åˆ†é¡µæ§ä»¶ -->
<div class="pagination" id="pagination" style="display: none;">
    <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µæŒ‰é’® -->
</div>

<!-- é£Ÿè°±è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="recipe-modal-overlay" id="recipeModal">
    <div class="recipe-modal-content">
        <div class="recipe-modal-header">
            <button class="recipe-modal-close" onclick="closeRecipeModal()">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="recipe-modal-title" id="modalRecipeTitle">Recipe Title</h2>
            <div class="recipe-modal-meta" id="modalRecipeMeta">
                <!-- åŠ¨æ€åŠ è½½å…ƒä¿¡æ¯ -->
            </div>
        </div>
        
        <div class="recipe-modal-body" id="modalRecipeBody">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading recipe details...</p>
            </div>
        </div>
    </div>
</div>

<!-- ç™»å½•æç¤ºï¼ˆå¦‚æœæœªç™»å½•ï¼‰ -->
{% if not session.user_id %}
<div class="login-reminder" style="margin-top: 2rem; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
    <i class="fas fa-info-circle" style="color: #2196f3; font-size: 1.2rem;"></i>
    <div>
        <strong>Join our community!</strong> 
        <a href="{{ url_for('user_bp.login_page') }}" style="color: #2196f3; text-decoration: none; margin-left: 0.5rem;">Login</a> 
        or 
        <a href="{{ url_for('user_bp.register_page') }}" style="color: #2196f3; text-decoration: none;">register</a> 
        to like, favorite, and share your own recipes.
    </div>
</div>
{% endif %}

<script>
// ç¤¾åŒºåŠŸèƒ½JavaScriptå®ç°
class CommunityManager {
    constructor() {
        this.currentPage = 1;
        this.currentView = 'grid';
        this.currentSort = 'hot';
        this.currentSearch = '';
        this.loading = false;
        this.recipes = [];
        this.pagination = {};
        
        this.init();
    }

    // åˆå§‹åŒ–ç¤¾åŒºåŠŸèƒ½
    init() {
        this.bindEvents();
        this.loadCommunityStats();
        this.loadRecipes();
    }

    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    bindEvents() {
        // æœç´¢åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.currentSearch = e.target.value.trim();
                this.currentPage = 1;
                this.loadRecipes();
            }, 500);
        });

        // æ’åºåŠŸèƒ½
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            this.currentSort = e.target.value;
            this.currentPage = 1;
            this.loadRecipes();
        });

        // è§†å›¾åˆ‡æ¢
        document.getElementById('gridViewBtn').addEventListener('click', () => {
            this.switchView('grid');
        });

        document.getElementById('listViewBtn').addEventListener('click', () => {
            this.switchView('list');
        });

        // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.getElementById('recipeModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('recipe-modal-overlay')) {
                this.closeRecipeModal();
            }
        });

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeRecipeModal();
            }
        });
    }

    // åŠ è½½ç¤¾åŒºç»Ÿè®¡ä¿¡æ¯
    async loadCommunityStats() {
        try {
            const response = await fetch('/api/community/stats');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('totalRecipes').textContent = data.data.total_recipes;
                document.getElementById('activeUsers').textContent = data.data.active_users;
                document.getElementById('totalLikes').textContent = data.data.total_likes;
                document.getElementById('totalFavorites').textContent = data.data.total_favorites;
            }
        } catch (error) {
            console.error('åŠ è½½ç¤¾åŒºç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    // åŠ è½½é£Ÿè°±åˆ—è¡¨
    async loadRecipes() {
        if (this.loading) return;
        
        this.loading = true;
        this.showLoading();

        try {
            const params = new URLSearchParams({
                page: this.currentPage,
                per_page: 12,
                sort: this.currentSort,
                search: this.currentSearch
            });

            const response = await fetch(`/api/community/recipes?${params}`);
            const data = await response.json();

            if (data.success) {
                this.recipes = data.data.recipes;
                this.pagination = data.data.pagination;
                this.renderRecipes();
                this.renderPagination();
            } else {
                this.showError(data.message);
            }
        } catch (error) {
            console.error('åŠ è½½é£Ÿè°±å¤±è´¥:', error);
            this.showError('Failed to load recipes. Please try again.');
        } finally {
            this.loading = false;
            this.hideLoading();
        }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('recipesGrid').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
    }

    // éšè—åŠ è½½çŠ¶æ€
    hideLoading() {
        document.getElementById('loadingState').style.display = 'none';
    }

    // æ¸²æŸ“é£Ÿè°±åˆ—è¡¨
    renderRecipes() {
        const grid = document.getElementById('recipesGrid');
        const emptyState = document.getElementById('emptyState');

        if (this.recipes.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            
            const emptyMessage = document.getElementById('emptyMessage');
            if (this.currentSearch) {
                emptyMessage.textContent = `No recipes found for "${this.currentSearch}". Try different keywords.`;
            } else {
                emptyMessage.textContent = 'No recipes available. Be the first to share a recipe!';
            }
            return;
        }

        emptyState.style.display = 'none';
        grid.style.display = 'grid';
        
        // åº”ç”¨è§†å›¾æ ·å¼
        grid.className = `recipes-grid${this.currentView === 'list' ? ' list-view' : ''}`;

        // ç”Ÿæˆé£Ÿè°±å¡ç‰‡HTML
        const recipesHtml = this.recipes.map((recipe, index) => {
            const randomIcon = this.getRandomRecipeIcon(index);
            const authorInitial = recipe.author?.nickname?.charAt(0)?.toUpperCase() || '?';
            
            return `
                <div class="recipe-card${this.currentView === 'list' ? ' list-view' : ''}"
                    onclick="viewRecipeDetail(${recipe.id})" style="cursor: pointer;">
                    <div class="recipe-header">
                        <div class="recipe-icon">${randomIcon}</div>
                        <!-- æ”¹ä¸ºæ˜¾ç¤ºçŠ¶æ€çš„å›¾æ ‡ï¼Œä¸å¯äº¤äº’ -->
                        <div class="recipe-actions">
                            <div class="action-status like-status" title="Likes">
                                <i class="fas fa-heart" style="color: ${recipe.stats?.is_loved ? '#e74c3c' : '#bdc3c7'};"></i>
                            </div>
                            <div class="action-status favorite-status" title="Favorites">
                                <i class="fas fa-star" style="color: ${recipe.stats?.is_favorited ? '#f1c40f' : '#bdc3c7'};"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recipe-content">
                        <div class="recipe-author">
                            <div class="author-avatar">${authorInitial}</div>
                            <span>by ${this.escapeHtml(recipe.author?.nickname || 'Unknown')}</span>
                        </div>
                        
                        <h3 class="recipe-title">${this.escapeHtml(recipe.name || 'Untitled Recipe')}</h3>
                        <p class="recipe-description">${this.escapeHtml(recipe.description || '')}</p>
                        
                        <div class="nutrition-preview">
                            <span class="nutrition-item">ğŸ”¥ ${recipe.nutrition?.calories || 0}kcal</span>
                            <span class="nutrition-item">ğŸ’ª ${recipe.nutrition?.protein || 0}g protein</span>
                            <span class="nutrition-item">ğŸ¥‘ ${recipe.nutrition?.fat || 0}g fat</span>
                        </div>
                        
                        <div class="recipe-meta">
                            <div class="recipe-stats">
                                <span class="stat-item">
                                    <i class="fas fa-heart"></i>
                                    <span>${recipe.stats?.likes_count || 0}</span>
                                </span>
                                <span class="stat-item">
                                    <i class="fas fa-star"></i>
                                    <span>${recipe.stats?.favorites_count || 0}</span>
                                </span>
                                <span class="stat-item">
                                    <i class="fas fa-utensils"></i>
                                    <span>${recipe.stats?.usage_count || 0}</span>
                                </span>
                            </div>
                            <span class="recipe-date">${this.formatDate(recipe.created_at)}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        grid.innerHTML = recipesHtml;
    }

    // æ¸²æŸ“åˆ†é¡µæ§ä»¶
    renderPagination() {
        const paginationEl = document.getElementById('pagination');
        
        if (this.pagination.total_pages <= 1) {
            paginationEl.style.display = 'none';
            return;
        }

        paginationEl.style.display = 'flex';

        let paginationHtml = '';

        // ä¸Šä¸€é¡µæŒ‰é’®
        if (this.pagination.has_prev) {
            paginationHtml += `
                <a href="#" class="page-btn" onclick="communityManager.goToPage(${this.pagination.page - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            `;
        } else {
            paginationHtml += `<span class="page-btn disabled"><i class="fas fa-chevron-left"></i></span>`;
        }

        // é¡µç æŒ‰é’®
        const startPage = Math.max(1, this.pagination.page - 2);
        const endPage = Math.min(this.pagination.total_pages, this.pagination.page + 2);

        if (startPage > 1) {
            paginationHtml += `<a href="#" class="page-btn" onclick="communityManager.goToPage(1)">1</a>`;
            if (startPage > 2) {
                paginationHtml += `<span class="page-btn disabled">...</span>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHtml += `
                <a href="#" class="page-btn ${i === this.pagination.page ? 'active' : ''}"
                onclick="communityManager.goToPage(${i})">${i}</a>
            `;
        }

        if (endPage < this.pagination.total_pages) {
            if (endPage < this.pagination.total_pages - 1) {
                paginationHtml += `<span class="page-btn disabled">...</span>`;
            }
            paginationHtml += `
                <a href="#" class="page-btn" onclick="communityManager.goToPage(${this.pagination.total_pages})">
                    ${this.pagination.total_pages}
                </a>
            `;
        }

        // ä¸‹ä¸€é¡µæŒ‰é’®
        if (this.pagination.has_next) {
            paginationHtml += `
                <a href="#" class="page-btn" onclick="communityManager.goToPage(${this.pagination.page + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            `;
        } else {
            paginationHtml += `<span class="page-btn disabled"><i class="fas fa-chevron-right"></i></span>`;
        }

        // é¡µé¢ä¿¡æ¯
        paginationHtml += `
            <span class="page-info">
                Page ${this.pagination.page} of ${this.pagination.total_pages}
                (${this.pagination.total} recipes)
            </span>
        `;

        paginationEl.innerHTML = paginationHtml;
    }

    // åˆ‡æ¢è§†å›¾
    switchView(view) {
        if (this.currentView === view) return;
        
        this.currentView = view;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        // é‡æ–°æ¸²æŸ“é£Ÿè°±
        this.renderRecipes();
    }

    // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
    goToPage(page) {
        if (page === this.currentPage || page < 1 || page > this.pagination.total_pages) return;
        
        this.currentPage = page;
        this.loadRecipes();
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        document.querySelector('.recipes-container').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }

    // ã€ä¿®å¤ã€‘æ˜¾ç¤ºé£Ÿè°±è¯¦æƒ…æ¨¡æ€æ¡† - å¢å¼ºé”™è¯¯å¤„ç†å’Œè°ƒè¯•
    async showRecipeDetail(recipeId) {
        console.log(`ğŸ” å°è¯•è·å–é£Ÿè°±è¯¦æƒ…: ${recipeId}`);
        
        const modal = document.getElementById('recipeModal');
        const modalBody = document.getElementById('modalRecipeBody');
        
        if (!modal || !modalBody) {
            console.error('âŒ æ‰¾ä¸åˆ°æ¨¡æ€æ¡†å…ƒç´ ');
            this.showToast('Page error: modal not found', 'error');
            return;
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†å’ŒåŠ è½½çŠ¶æ€
        modal.classList.add('show');
        modalBody.innerHTML = `
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading recipe details...</p>
            </div>
        `;
        
        try {
            console.log(`ğŸ“¡ å‘é€APIè¯·æ±‚: /api/recipe/${recipeId}/detail`);
            
            const response = await fetch(`/api/recipe/${recipeId}/detail`);
            console.log(`ğŸ“¥ APIå“åº”çŠ¶æ€: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('ğŸ“‹ APIå“åº”æ•°æ®:', data);
            
            if (data.success) {
                console.log('âœ… æ•°æ®è·å–æˆåŠŸï¼Œå¼€å§‹æ¸²æŸ“');
                this.renderRecipeDetail(data.recipe);
            } else {
                console.error('âŒ APIè¿”å›é”™è¯¯:', data.message);
                this.showRecipeError(data.message || 'Failed to load recipe details');
            }
        } catch (error) {
            console.error('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥:', error);
            this.showRecipeError('Network error. Please check your connection and try again.');
        }
    }

    // ã€ä¿®å¤ã€‘æ¸²æŸ“é£Ÿè°±è¯¦æƒ… - æ·»åŠ é˜²å¾¡æ€§ç¼–ç¨‹å’Œå®‰å…¨æ£€æŸ¥
    renderRecipeDetail(recipe) {
        console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“é£Ÿè°±è¯¦æƒ…:', recipe);
        
        try {
            // å®‰å…¨åœ°è®¾ç½®æ ‡é¢˜å’Œå…ƒä¿¡æ¯
            const titleElement = document.getElementById('modalRecipeTitle');
            const metaElement = document.getElementById('modalRecipeMeta');
            
            if (titleElement) {
                titleElement.textContent = recipe.name || 'Untitled Recipe';
            }
            
            if (metaElement) {
                const authorName = recipe.author?.nickname || recipe.author?.username || 'Unknown User';
                const createdDate = recipe.created_at ? this.formatFullDate(recipe.created_at) : 'Unknown Date';
                
                metaElement.innerHTML = `
                    <span><i class="fas fa-user"></i> by ${this.escapeHtml(authorName)}</span>
                    <span><i class="fas fa-calendar-alt"></i> ${createdDate}</span>
                    ${recipe.pet_name ? `<span><i class="fas fa-paw"></i> For ${this.escapeHtml(recipe.pet_name)}</span>` : ''}
                `;
            }

            let bodyHtml = '';

            // ç‚¹èµæ”¶è—æ“ä½œåŒºåŸŸ - æ·»åŠ å®‰å…¨æ£€æŸ¥
            const stats = recipe.stats || {};
            bodyHtml += `
                <div class="modal-section">
                    <div class="recipe-interaction-bar">
                        <div class="interaction-stats">
                            <span class="stat-item">
                                <i class="fas fa-heart"></i>
                                <span id="modalLikesCount">${stats.likes_count || 0}</span>
                                <small>likes</small>
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-star"></i>
                                <span id="modalFavoritesCount">${stats.favorites_count || 0}</span>
                                <small>favorites</small>
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-utensils"></i>
                                <span>${stats.usage_count || 0}</span>
                                <small>uses</small>
                            </span>
                        </div>
                        <div class="interaction-buttons">
                            <button class="interaction-btn like-btn ${stats.is_loved ? 'loved' : ''}" 
                                    onclick="toggleLikeInModal(${recipe.id}, this)"
                                    title="${stats.is_loved ? 'Unlike' : 'Like'} Recipe">
                                <i class="fas fa-heart"></i>
                                <span>${stats.is_loved ? 'Liked' : 'Like'}</span>
                            </button>
                            <button class="interaction-btn favorite-btn ${stats.is_favorited ? 'favorited' : ''}" 
                                    onclick="toggleFavoriteInModal(${recipe.id}, this)"
                                    title="${stats.is_favorited ? 'Remove from favorites' : 'Add to favorites'}">
                                <i class="fas fa-star"></i>
                                <span>${stats.is_favorited ? 'Favorited' : 'Favorite'}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // é£Ÿè°±æè¿°
            if (recipe.description && recipe.description.trim()) {
                bodyHtml += `
                    <div class="modal-section">
                        <h3 class="modal-section-title">
                            <i class="fas fa-info-circle"></i>
                            Description
                        </h3>
                        <p>${this.escapeHtml(recipe.description)}</p>
                    </div>
                `;
            }

            // é£Ÿæåˆ—è¡¨ - æ·»åŠ å®‰å…¨æ£€æŸ¥
            if (recipe.ingredients && Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0) {
                bodyHtml += `
                    <div class="modal-section">
                        <h3 class="modal-section-title">
                            <i class="fas fa-list"></i>
                            Ingredients (${recipe.ingredients.length} items)
                        </h3>
                        <div class="ingredients-list">
                            ${recipe.ingredients.map(ingredient => `
                                <div class="ingredient-item">
                                    <span class="ingredient-name">
                                        ğŸ¥• ${this.escapeHtml(ingredient.name || 'Unknown Ingredient')}
                                    </span>
                                    <span class="ingredient-weight">${ingredient.weight || 0}g</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                bodyHtml += `
                    <div class="modal-section">
                        <h3 class="modal-section-title">
                            <i class="fas fa-list"></i>
                            Ingredients
                        </h3>
                        <p style="color: #7f8c8d; font-style: italic;">No ingredients information available.</p>
                    </div>
                `;
            }

            // è¥å…»åˆ†æ - æ·»åŠ å®‰å…¨æ£€æŸ¥
            if (recipe.nutrition) {
                const nutrition = recipe.nutrition;
                bodyHtml += `
                    <div class="modal-section">
                        <h3 class="modal-section-title">
                            <i class="fas fa-chart-pie"></i>
                            Nutrition Analysis
                        </h3>
                        <div class="nutrition-grid">
                            <div class="nutrition-card">
                                <div class="nutrition-value">${this.safeFloat(nutrition.total_calories).toFixed(1)}</div>
                                <div class="nutrition-label">Total Calories</div>
                                <div class="nutrition-unit">kcal</div>
                            </div>
                            <div class="nutrition-card">
                                <div class="nutrition-value">${this.safeFloat(nutrition.total_protein).toFixed(1)}</div>
                                <div class="nutrition-label">Protein</div>
                                <div class="nutrition-unit">g</div>
                            </div>
                            <div class="nutrition-card">
                                <div class="nutrition-value">${this.safeFloat(nutrition.total_fat).toFixed(1)}</div>
                                <div class="nutrition-label">Fat</div>
                                <div class="nutrition-unit">g</div>
                            </div>
                            <div class="nutrition-card">
                                <div class="nutrition-value">${this.safeFloat(nutrition.total_carbs).toFixed(1)}</div>
                                <div class="nutrition-label">Carbohydrates</div>
                                <div class="nutrition-unit">g</div>
                            </div>
                            <div class="nutrition-card">
                                <div class="nutrition-value">${this.safeFloat(nutrition.total_fiber).toFixed(1)}</div>
                                <div class="nutrition-label">Fiber</div>
                                <div class="nutrition-unit">g</div>
                            </div>
                            <div class="nutrition-card">
                                <div class="nutrition-value">${this.safeFloat(nutrition.total_calcium).toFixed(1)}</div>
                                <div class="nutrition-label">Calcium</div>
                                <div class="nutrition-unit">mg</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
            const modalBodyElement = document.getElementById('modalRecipeBody');
            if (modalBodyElement) {
                modalBodyElement.innerHTML = bodyHtml;
                console.log('âœ… é£Ÿè°±è¯¦æƒ…æ¸²æŸ“å®Œæˆ');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°modalRecipeBodyå…ƒç´ ');
                this.showRecipeError('Page error: cannot render content');
            }

        } catch (error) {
            console.error('âŒ æ¸²æŸ“é£Ÿè°±è¯¦æƒ…æ—¶å‡ºé”™:', error);
            this.showRecipeError('Failed to display recipe details');
        }
    }

    // ã€æ–°å¢ã€‘å®‰å…¨çš„æµ®ç‚¹æ•°è½¬æ¢
    safeFloat(value) {
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    // ã€ä¿®å¤ã€‘æ˜¾ç¤ºé£Ÿè°±åŠ è½½é”™è¯¯
    showRecipeError(message) {
        console.log('âš ï¸ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯:', message);
        
        const modalBodyElement = document.getElementById('modalRecipeBody');
        if (modalBodyElement) {
            modalBodyElement.innerHTML = `
                <div class="modal-section">
                    <div style="text-align: center; padding: 2rem; color: var(--error-color);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #e74c3c;"></i>
                        <h3 style="color: #510B0B; margin-bottom: 1rem;">Failed to load recipe</h3>
                        <p style="margin-bottom: 1rem;">${this.escapeHtml(message)}</p>
                        <button onclick="communityManager.closeRecipeModal()" class="btn btn-primary" style="margin-top: 1rem; background: #5580AD; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
        }
        
        // åŒæ—¶æ˜¾ç¤ºtoastæç¤º
        this.showToast(message, 'error');
    }

    // å…³é—­é£Ÿè°±è¯¦æƒ…æ¨¡æ€æ¡†
    closeRecipeModal() {
        const modal = document.getElementById('recipeModal');
        modal.classList.remove('show');
    }

    // è·å–éšæœºé£Ÿè°±å›¾æ ‡
    getRandomRecipeIcon(index) {
        const icons = [
            'ğŸ¥©', 'ğŸŸ', 'ğŸ—', 'ğŸ¥•', 'ğŸ¥¬', 'ğŸ ', 'ğŸŒ½', 'ğŸ', 'ğŸ¥“', 'ğŸ–',
            'ğŸ ', 'ğŸ¦', 'ğŸ¥¦', 'ğŸ¥’', 'ğŸ…', 'ğŸ¥”', 'ğŸƒ', 'ğŸŒ', 'ğŸ¥š', 'ğŸ§€'
        ];
        return icons[index % icons.length];
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    formatDate(dateString) {
        if (!dateString) return 'Unknown';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return 'Unknown';
        }
    }

    // æ ¼å¼åŒ–å®Œæ•´æ—¥æœŸ
    formatFullDate(dateString) {
        if (!dateString) return 'Unknown Date';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return 'Unknown Date';
        }
    }

    // HTMLè½¬ä¹‰
    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    showError(message) {
        this.showToast(message, 'error');
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    showToast(message, type = 'success') {
        // ç§»é™¤å·²å­˜åœ¨çš„toast
        const existingToasts = document.querySelectorAll('.toast');
        existingToasts.forEach(toast => toast.remove());

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icon = type === 'success' ? 'check-circle' :
                    type === 'error' ? 'exclamation-circle' :
                    'info-circle';

        toast.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span>${this.escapeHtml(message)}</span>
        `;

        document.body.appendChild(toast);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
}

// å…¨å±€å‡½æ•°
let communityManager;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    communityManager = new CommunityManager();
});

// ã€ä¿®å¤ã€‘æ¨¡æ€æ¡†ä¸­çš„ç‚¹èµåŠŸèƒ½ - å¢åŠ è°ƒè¯•ä¿¡æ¯
async function toggleLikeInModal(recipeId, element) {
    console.log(`ğŸ’– å°è¯•ç‚¹èµé£Ÿè°±: ${recipeId}`);
    
    {% if not session.user_id %}
    communityManager.showToast('Please login to like recipes', 'info');
    return;
    {% endif %}

    const isLoved = element.classList.contains('loved');
    const originalText = element.querySelector('span').textContent;
    
    try {
        element.disabled = true;
        element.querySelector('span').textContent = 'Processing...';
        
        const url = isLoved ?
            `/api/community/recipe/${recipeId}/unlike` :
            `/api/community/recipe/${recipeId}/like`;
        
        const method = isLoved ? 'DELETE' : 'POST';
        
        console.log(`ğŸ“¡ å‘é€ç‚¹èµè¯·æ±‚: ${method} ${url}`);
        
        const response = await fetch(url, { method });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“¥ ç‚¹èµå“åº”:', data);
        
        if (data.success) {
            if (isLoved) {
                element.classList.remove('loved');
                element.querySelector('span').textContent = 'Like';
                element.title = 'Like Recipe';
            } else {
                element.classList.add('loved');
                element.querySelector('span').textContent = 'Liked';
                element.title = 'Unlike Recipe';
            }
            
            // æ›´æ–°ç‚¹èµæ•°æ˜¾ç¤º
            const likesCountElement = document.getElementById('modalLikesCount');
            if (likesCountElement && data.data && typeof data.data.likes_count !== 'undefined') {
                likesCountElement.textContent = data.data.likes_count;
            }
            
            communityManager.showToast(data.message, 'success');
        } else {
            element.querySelector('span').textContent = originalText;
            communityManager.showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('âŒ ç‚¹èµæ“ä½œå¤±è´¥:', error);
        element.querySelector('span').textContent = originalText;
        communityManager.showToast('Operation failed, please try again', 'error');
    } finally {
        element.disabled = false;
    }
}

// ã€ä¿®å¤ã€‘æ¨¡æ€æ¡†ä¸­çš„æ”¶è—åŠŸèƒ½ - å¢åŠ è°ƒè¯•ä¿¡æ¯
async function toggleFavoriteInModal(recipeId, element) {
    console.log(`â­ å°è¯•æ”¶è—é£Ÿè°±: ${recipeId}`);
    
    {% if not session.user_id %}
    communityManager.showToast('Please login to favorite recipes', 'info');
    return;
    {% endif %}

    const isFavorited = element.classList.contains('favorited');
    const originalText = element.querySelector('span').textContent;
    
    try {
        element.disabled = true;
        element.querySelector('span').textContent = 'Processing...';
        
        const url = isFavorited ?
            `/api/recipe/favorite/${recipeId}` :
            '/api/recipe/favorite';
        
        const method = isFavorited ? 'DELETE' : 'POST';
        const body = isFavorited ? null : JSON.stringify({ recipe_id: recipeId });
        
        console.log(`ğŸ“¡ å‘é€æ”¶è—è¯·æ±‚: ${method} ${url}`);
        
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“¥ æ”¶è—å“åº”:', data);
        
        if (data.success) {
            if (isFavorited) {
                element.classList.remove('favorited');
                element.querySelector('span').textContent = 'Favorite';
                element.title = 'Add to favorites';
            } else {
                element.classList.add('favorited');
                element.querySelector('span').textContent = 'Favorited';
                element.title = 'Remove from favorites';
            }
            
            // æ›´æ–°æ”¶è—æ•°æ˜¾ç¤º
            const favoritesCountElement = document.getElementById('modalFavoritesCount');
            if (favoritesCountElement && data.data && typeof data.data.favorites_count !== 'undefined') {
                favoritesCountElement.textContent = data.data.favorites_count;
            }
            
            communityManager.showToast(data.message, 'success');
        } else {
            element.querySelector('span').textContent = originalText;
            communityManager.showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('âŒ æ”¶è—æ“ä½œå¤±è´¥:', error);
        element.querySelector('span').textContent = originalText;
        communityManager.showToast('Operation failed, please try again', 'error');
    } finally {
        element.disabled = false;
    }
}

// æŸ¥çœ‹é£Ÿè°±è¯¦æƒ…
function viewRecipeDetail(recipeId) {
    communityManager.showRecipeDetail(recipeId);
}

// å…³é—­é£Ÿè°±è¯¦æƒ…æ¨¡æ€æ¡†
function closeRecipeModal() {
    communityManager.closeRecipeModal();
}

// æ¸…é™¤ç­›é€‰æ¡ä»¶
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('sortSelect').value = 'hot';
    
    communityManager.currentSearch = '';
    communityManager.currentSort = 'hot';
    communityManager.currentPage = 1;
    communityManager.loadRecipes();
}
</script>
{% endblock %}