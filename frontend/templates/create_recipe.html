{% extends "base.html" %}

{% block title %}Create Recipe - Pet Recipe Website{% endblock %}

{% block content %}
<style>
    .create-recipe-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        color: white;
        border-radius: 15px;
    }

    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    /* æ­¥éª¤è¿›åº¦æ¡ */
    .progress-container {
        margin-bottom: 3rem;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 2rem;
    }

    .progress-line {
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 3px;
        background: #EDBF9D;
        z-index: 1;
    }

    .progress-line-active {
        height: 3px;
        background: #5580AD;
        transition: width 0.3s ease;
        z-index: 2;
        position: absolute;
        top: 0;
        left: 0;
    }

    .progress-step {
        background: white;
        border: 3px solid #EDBF9D;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #B82F0D;
        position: relative;
        z-index: 3;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .progress-step.completed {
        background: #EDBF9D;
        border-color: #EDBF9D;
        color: #510B0B;
    }

    .step-label {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.9rem;
        color: #510B0B;
        font-weight: 500;
    }

    /* æ­¥éª¤å†…å®¹ */
    .step-content {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 2px solid #A1B4B2;
        margin-bottom: 2rem;
    }

    .step-content.hidden {
        display: none;
    }

    .step-title {
        font-size: 1.8rem;
        color: #510B0B;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å® ç‰© */
    .pet-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .pet-option {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .pet-option:hover {
        border-color: #5580AD;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(85, 128, 173, 0.2);
    }

    .pet-option.selected {
        border-color: #B82F0D;
        background: #fff5f5;
    }

    .pet-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #EDBF9D;
    }

    .pet-info h3 {
        color: #510B0B;
        margin-bottom: 0.5rem;
        font-size: 1.3rem;
    }

    .pet-stats {
        color: #B82F0D;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* ç¬¬äºŒæ­¥ï¼šé€‰æ‹©é£Ÿæ */
    .category-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .category-tab {
        padding: 0.8rem 1.5rem;
        background: white;
        border: 2px solid #A1B4B2;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .category-tab:hover {
        border-color: #5580AD;
        transform: translateY(-1px);
    }

    .category-tab.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .category-count {
        background: rgba(0,0,0,0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }

    .category-tab.active .category-count {
        background: rgba(255,255,255,0.2);
    }

    .ingredients-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .ingredient-card {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        /* ç¡®ä¿å¡ç‰‡æœ‰è¶³å¤Ÿé«˜åº¦ */
        min-height: 240px;
        display: flex;
        flex-direction: column;
    }

    .ingredient-card:hover {
        border-color: #5580AD;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(85, 128, 173, 0.15);
    }

    .ingredient-card.selected {
        border-color: #B82F0D;
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        box-shadow: 0 8px 25px rgba(184, 47, 13, 0.2);
    }

    .ingredient-seasonality {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #EDBF9D;
        color: #510B0B;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .allergen-warning {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #ff4444;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .ingredient-image {
        width: 50%;
        /* ä½¿ç”¨aspect-ratioåˆ›å»ºæ­£æ–¹å½¢å®¹å™¨ */
        aspect-ratio: 1 / 1;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 1rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        overflow: hidden;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
        /* ç¡®ä¿å›¾ç‰‡å®¹å™¨åœ¨flexå¸ƒå±€ä¸­ä¸ä¼šè¢«å‹ç¼© */
        flex-shrink: 0;
    }

    .ingredient-card:hover .ingredient-image {
        border-color: #5580AD;
        box-shadow: 0 4px 12px rgba(85, 128, 173, 0.15);
    }

    /* å›¾ç‰‡æ ·å¼ - ä¿æŒå®Œæ•´æ˜¾ç¤º */
    .ingredient-image img {
        width: 100%;
        height: 100%;
        /* ä½¿ç”¨containç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼Œä¿æŒæ¯”ä¾‹ */
        object-fit: contain;
        transition: transform 0.3s ease;
        /* æ·»åŠ ä¸€äº›å†…è¾¹è·ï¼Œé¿å…å›¾ç‰‡è´´è¾¹ */
        padding: 8px;
        box-sizing: border-box;
    }

    .ingredient-card:hover .ingredient-image img {
        transform: scale(1.05);
    }

    /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æ ·å¼ */
    .ingredient-image div {
        font-style: italic;
        text-align: center;
        padding: 1rem;
        color: #999;
        font-size: 0.9rem;
    }

    /* é£Ÿæåç§°å’Œè¥å…»ä¿¡æ¯ - è°ƒæ•´ä¸ºflexå¸ƒå±€åº•éƒ¨å¯¹é½ */
    .ingredient-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #510B0B;
        margin-bottom: 0.5rem;
        text-align: center;
        /* åœ¨flexå®¹å™¨ä¸­å æ®å‰©ä½™ç©ºé—´ */
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ingredient-nutrition {
        font-size: 0.9rem;
        color: #B82F0D;
        text-align: center;
        line-height: 1.3;
        /* å›ºå®šåœ¨åº•éƒ¨ */
        margin-top: auto;
    }

    /* å“åº”å¼ä¼˜åŒ– - ä¸åŒå±å¹•å°ºå¯¸ä¸‹çš„ç½‘æ ¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .ingredients-grid {
            /* æ‰‹æœºç«¯ï¼šæœ€å°180px */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .ingredient-card {
            padding: 1rem;
            min-height: 220px;
        }
        
        .ingredient-image {
            margin: 0.8rem 0;
        }
        
        .ingredient-name {
            font-size: 1.1rem;
        }
        
        .ingredient-nutrition {
            font-size: 0.85rem;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .ingredients-grid {
            /* å¹³æ¿ç«¯ï¼šæœ€å°190px */
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
        .ingredients-grid {
            /* æ¡Œé¢ç«¯ï¼šæœ€å°200px */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }

    @media (min-width: 1441px) {
        .ingredients-grid {
            /* å¤§å±å¹•ï¼šæœ€å°210pxï¼Œæœ€å¤šä¸€è¡Œ5ä¸ª */
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            max-width: 1800px;
            margin: 0 auto 2rem auto;
        }
    }

    /* ä¸ºä¸æ”¯æŒaspect-ratioçš„æµè§ˆå™¨æä¾›å¤‡é€‰æ–¹æ¡ˆ */
    @supports not (aspect-ratio: 1 / 1) {
        .ingredient-image {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%; /* åˆ›å»ºæ­£æ–¹å½¢ */
        }
        
        .ingredient-image img,
        .ingredient-image div {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    }

    /* å·²é€‰é£Ÿææ˜¾ç¤º */
    .selected-ingredients-panel {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 2px solid #A1B4B2;
    }

    .selected-ingredients-panel h3 {
        color: #510B0B;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .selected-count {
        background: #B82F0D;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }

    .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
    }

    .selected-tag {
        background: #5580AD;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
    }

    /* ç¬¬ä¸‰æ­¥ï¼šé‡é‡è®¾ç½® */
    .weight-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .weight-table th {
        background: #5580AD;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    .weight-table td {
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }

    .weight-table tbody tr:hover {
        background: #f8f9fa;
    }

    .weight-input {
        width: 80px;
        padding: 0.5rem;
        border: 2px solid #A1B4B2;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        transition: border-color 0.3s ease;
    }

    .weight-input:focus {
        outline: none;
        border-color: #5580AD;
    }

    /* å¯¼èˆªæŒ‰é’® */
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .nav-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .prev-btn {
        background: #A1B4B2;
        color: white;
    }

    .prev-btn:hover:not(:disabled) {
        background: #8a9b99;
        transform: translateX(-2px);
    }

    .prev-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .next-btn {
        background: #B82F0D;
        color: white;
    }

    .next-btn:hover:not(:disabled) {
        background: #a0280b;
        transform: translateX(2px);
    }

    .next-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .step-info {
        color: #510B0B;
        font-weight: 500;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #A1B4B2;
        border-top: 4px solid #5580AD;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ------- æ–°å¢ï¼šæ¶ˆæ¯æç¤ºæ ·å¼ ------- */
    .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .success-message.show {
        opacity: 1;
        transform: translateX(0);
    }

    .success-message.hide {
        opacity: 0;
        transform: translateX(100%);
    }

    .success-message.type-warning {
        background: #ff4444;
    }

    .success-message.type-info {
        background: #2196F3;
    }

    /* è¥å…»æˆåˆ†åˆ†æ */
    .nutrition-plan-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid #EDBF9D;
    }

    .nutrition-plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .nutrition-plan-card {
        background: white;
        border: 2px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .nutrition-plan-card:hover {
        border-color: #5580AD;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(85, 128, 173, 0.15);
    }

    .nutrition-plan-card.selected {
        border-color: #B82F0D;
        background: #fff8f8;
        box-shadow: 0 5px 20px rgba(184, 47, 13, 0.2);
    }

    .nutrition-plan-card.recommended {
        border-color: #28a745;
        position: relative;
    }

    .nutrition-plan-card.recommended::before {
        content: "æ¨è";
        position: absolute;
        top: -8px;
        right: 15px;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .plan-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .plan-card-title {
        color: #510B0B;
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0;
    }

    .plan-card-icon {
        font-size: 1.5rem;
        color: #5580AD;
    }

    .plan-card-description {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
        margin-bottom: 1rem;
    }

    .plan-card-highlights {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .plan-highlight-tag {
        background: #f0f7ff;
        color: #5580AD;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        border: 1px solid #5580AD;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }

    .plan-detail-modal {
        background: white;
        border-radius: 15px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        color: #510B0B;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 2px solid #f0f0f0;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .ratio-chart {
        display: grid;
        gap: 0.75rem;
        margin: 1.5rem 0;
    }

    .ratio-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .ratio-label {
        min-width: 80px;
        font-weight: bold;
        color: #510B0B;
    }

    .ratio-bar {
        flex: 1;
        height: 25px;
        background: #f0f0f0;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    .ratio-fill {
        height: 100%;
        background: linear-gradient(90deg, #5580AD, #B82F0D);
        border-radius: 12px;
        transition: width 0.3s ease;
    }

    .ratio-percent {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.8rem;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #B82F0D;
        color: white;
    }

    .btn-primary:hover {
        background: #a02a0c;
    }

    .btn-secondary {
        background: #A1B4B2;
        color: white;
    }

    .btn-secondary:hover {
        background: #8a9a99;
    }
</style>

<div class="create-recipe-container">
    <div class="page-header">
        <h1>ğŸ½ï¸ Create a Pet Recipe</h1>
        <p>Customize a nutritious and delicious recipe for your beloved pet</p>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-active" id="progressLineActive" style="width: 20%;"></div>
            </div>
            <div class="progress-step active" data-step="1">
                <span>1</span>
                <div class="step-label">Select Pet</div>
            </div>
            <div class="progress-step" data-step="2">
                <span>2</span>
                <div class="step-label">Select Ingredients</div>
            </div>
            <div class="progress-step" data-step="3">
                <span>3</span>
                <div class="step-label">Set Weights</div>
            </div>
            <div class="progress-step" data-step="4">
                <span>4</span>
                <div class="step-label">Nutrition Analysis</div>
            </div>
            <div class="progress-step" data-step="5">
                <span>5</span>
                <div class="step-label">Save Recipe</div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å® ç‰© -->
    <div class="step-content" id="step1">
        <div class="step-title">
            <i class="fas fa-paw"></i>
            Select Target Pet
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Choose which pet you want to create a recipe for. We will provide personalized nutritional advice based on their information.</p>
        
        <div class="pet-selector">
            {% for pet in pets %}
            <div class="pet-option" data-pet-id="{{ pet.id }}">
                <img src="{{ url_for('static', filename='images/avatars/' + pet.avatar) }}" alt="{{ pet.name }}" class="pet-avatar">
                <div class="pet-info">
                    <h3>{{ pet.name }}</h3>
                    <div class="pet-stats">
                        {{ pet.species }} | {{ pet.weight }}kg | {{ pet.age }}years old
                        {% if pet.breed %}
                        <br>{{ pet.breed }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- æ–°å¢ï¼šè¥å…»é…æ¯”æ–¹æ¡ˆé€‰æ‹© -->
        <div class="nutrition-plan-section" id="nutritionPlanSection" style="display: none;">
            <h3 style="color: #510B0B; margin: 2rem 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-chart-pie"></i>
                é€‰æ‹©è¥å…»é…æ¯”æ–¹æ¡ˆ
            </h3>
            <p style="color: #B82F0D; margin-bottom: 1.5rem;">
                æ ¹æ®æ‚¨çš„å® ç‰©ç‰¹ç‚¹ï¼Œæˆ‘ä»¬æ¨èä»¥ä¸‹è¥å…»é…æ¯”æ–¹æ¡ˆã€‚ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦ç»†æ¯”ä¾‹ã€‚
            </p>
            
            <!-- é…æ¯”æ–¹æ¡ˆåŠ è½½çŠ¶æ€ -->
            <div class="nutrition-plans-loading" id="nutritionPlansLoading">
                <div class="loading">
                    <div class="spinner"></div>
                    <span style="margin-left: 1rem;">æ­£åœ¨åŠ è½½è¥å…»æ–¹æ¡ˆ...</span>
                </div>
            </div>
            
            <!-- é…æ¯”æ–¹æ¡ˆç½‘æ ¼ -->
            <div class="nutrition-plans-grid" id="nutritionPlansGrid" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„é…æ¯”æ–¹æ¡ˆå¡ç‰‡ -->
            </div>
        </div>
    </div>

    <!-- è¥å…»æ–¹æ¡ˆè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="planDetailModal" style="display: none;">
        <div class="modal-content plan-detail-modal">
            <div class="modal-header">
                <h3 id="planDetailTitle">è¥å…»é…æ¯”æ–¹æ¡ˆè¯¦æƒ…</h3>
                <button class="modal-close" onclick="closePlanDetail()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="planDetailContent">
                <!-- åŠ¨æ€ç”Ÿæˆçš„æ–¹æ¡ˆè¯¦æƒ… -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePlanDetail()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="selectPlanBtn" onclick="selectNutritionPlan()">é€‰æ‹©æ­¤æ–¹æ¡ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šé€‰æ‹©é£Ÿæ -->
    <div class="step-content hidden" id="step2">
        <div class="step-title">
            <i class="fas fa-carrot"></i>
            Select Ingredients
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Select your desired ingredients from various categories. It is recommended to combine multiple types to ensure a balanced diet.</p>
        
        <!-- åˆ†ç±»æ ‡ç­¾ -->
        <div class="category-tabs" id="categoryTabs">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading ingredient categories...</span>
            </div>
        </div>

        <!-- é£Ÿæç½‘æ ¼ -->
        <div class="ingredients-grid" id="ingredientsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading ingredients...</span>
            </div>
        </div>

        <!-- å·²é€‰é£Ÿææ˜¾ç¤º -->
        <div class="selected-ingredients-panel">
            <h3>
                <i class="fas fa-check-circle"></i>
                Selected Ingredients
                <span class="selected-count" id="selectedCount">0</span>
            </h3>
            <div class="selected-list" id="selectedList">
                <div style="color: #666; font-style: italic;">No ingredients selected yet</div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®é‡é‡ -->
    <div class="step-content hidden" id="step3">
        <div class="step-title">
            <i class="fas fa-weight"></i>
            Set Ingredient Weights
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Set the appropriate weight (in grams) for each ingredient. The system will calculate the nutritional content in real-time.</p>
        
        <!-- æ–°å¢ï¼šè¡¨æ ¼ä¸Šæ–¹çš„æ“ä½œåŒºåŸŸ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; border: 1px solid #A1B4B2;">
            <div style="color: #510B0B;">
                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                <strong>Weight Distribution</strong>
                <small style="display: block; color: #B82F0D; margin-top: 0.3rem;">
                    You can manually set weights or use auto-distribution based on your selected nutrition plan
                </small>
            </div>
            <button type="button"
                    id="autoDistributeBtn"
                    class="nav-btn"
                    style="background: #5580AD; margin: 0; padding: 0.8rem 1.5rem; font-size: 0.9rem;"
                    onclick="autoDistributeWeights()"
                    disabled>
                <i class="fas fa-magic" style="margin-right: 0.5rem;"></i>
                Auto-Distribute Weights
            </button>
        </div>
        
        <table class="weight-table">
            <thead>
                <tr>
                    <th>Ingredient Name</th>
                    <th>Weight (g)</th>
                    <th>Calories (kcal)</th>
                    <th>Protein (g)</th>
                    <th>Fat (g)</th>
                    <th>Carbs (g)</th>
                </tr>
            </thead>
            <tbody id="weightTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; color: #666; font-style: italic;">Please select ingredients first</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- ç¬¬å››æ­¥ï¼šè¥å…»åˆ†æ -->
    <div class="step-content hidden" id="step4">
        <div class="step-title">
            <i class="fas fa-chart-bar"></i>
            Nutritional Analysis
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Review the detailed nutritional information of the recipe to ensure it meets your pet's needs.</p>
        
        <div id="nutritionAnalysis">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Analyzing nutritional content...</span>
            </div>
        </div>
    </div>

    <!-- ç¬¬äº”æ­¥ï¼šä¿å­˜é£Ÿè°± -->
    <div class="step-content hidden" id="step5">
        <div class="step-title">
            <i class="fas fa-save"></i>
            Save Recipe
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Give your recipe a name and add a description.</p>
        
        <div style="max-width: 600px;">
            <div class="form-group">
                <label for="recipeName">Recipe Name *</label>
                <input type="text" id="recipeName" placeholder="e.g., Fluffy's Nutritional Feast" maxlength="50">
            </div>
            <div class="form-group">
                <label for="recipeDescription">Recipe Description</label>
                <textarea id="recipeDescription" rows="4" placeholder="Describe the features of this recipe, suitable occasions, etc..." maxlength="200"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="nav-btn" style="background: #A1B4B2;" onclick="saveRecipe(true)">
                    <i class="fas fa-edit"></i>
                    Save as Draft
                </button>
                <button class="nav-btn" style="background: #B82F0D;" onclick="saveRecipe(false)">
                    <i class="fas fa-check"></i>
                    Publish Recipe
                </button>
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªæŒ‰é’® -->
    <div class="navigation-buttons">
        <button class="nav-btn prev-btn" id="prevBtn" onclick="previousStep()" disabled>
            <i class="fas fa-chevron-left"></i>
            Previous Step
        </button>
        
        <div class="step-info">
            Step <span id="currentStepText">1</span> of 5
        </div>
        
        <button class="nav-btn next-btn" id="nextBtn" onclick="nextStep()" disabled>
            Next Step
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// å…¨å±€å˜é‡
let currentStep = 1;
let selectedPetId = null;
let selectedIngredients = [];
let ingredientWeights = {};
let nutritionData = null;
let categories = [];
let allIngredients = [];
let selectedNutritionPlan = null;
let nutritionPlans = [];
let currentPlanDetail = null;

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ä¸ºæ‰€æœ‰å® ç‰©é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('click', function(e) {
        const petOption = e.target.closest('.pet-option');
        if (petOption) {
            const petId = petOption.getAttribute('data-pet-id');
            selectPet(petId);
        }
    });
    
    loadCategories();
    updateStepVisibility();
    updateProgressBar();
    updatePrevButtonState();
});

// é€‰æ‹©å® ç‰©
function selectPet(petId) {
    selectedPetId = petId;
    
    // æ›´æ–°UI
    document.querySelectorAll('.pet-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`[data-pet-id="${petId}"]`).classList.add('selected');
    
    // æ˜¾ç¤ºè¥å…»é…æ¯”æ–¹æ¡ˆé€‰æ‹©
    showNutritionPlanSection(petId);
    
    showSuccessMessage('å® ç‰©å·²é€‰æ‹©ï¼Œè¯·é€‰æ‹©è¥å…»é…æ¯”æ–¹æ¡ˆ');
}

// æ˜¾ç¤ºè¥å…»é…æ¯”æ–¹æ¡ˆé€‰æ‹©
async function showNutritionPlanSection(petId) {
    const section = document.getElementById('nutritionPlanSection');
    const loading = document.getElementById('nutritionPlansLoading');
    const grid = document.getElementById('nutritionPlansGrid');
    
    section.style.display = 'block';
    loading.style.display = 'block';
    grid.style.display = 'none';
    
    try {
        const response = await fetch(`/api/nutrition/plans?pet_id=${petId}`);
        if (!response.ok) {
            throw new Error('Failed to load nutrition plans');
        }
        
        const data = await response.json();
        nutritionPlans = data.plans;
        
        renderNutritionPlans();
        
        loading.style.display = 'none';
        grid.style.display = 'grid';
        
    } catch (error) {
        console.error('Failed to load nutrition plans:', error);
        loading.innerHTML = '<div style="color: #dc3545; text-align: center;">åŠ è½½è¥å…»æ–¹æ¡ˆå¤±è´¥ï¼Œè¯·é‡è¯•</div>';
    }
}

// æ¸²æŸ“è¥å…»é…æ¯”æ–¹æ¡ˆ
function renderNutritionPlans() {
    const grid = document.getElementById('nutritionPlansGrid');
    
    const cardsHtml = nutritionPlans.map(plan => {
        const highlights = plan.special_notes.slice(0, 2); // åªæ˜¾ç¤ºå‰2ä¸ªç‰¹ç‚¹
        
        return `
            <div class="nutrition-plan-card ${plan.is_recommended ? 'recommended' : ''}" 
                data-plan-id="${plan.id}" onclick="showPlanDetail('${plan.id}')">
                <div class="plan-card-header">
                    <h4 class="plan-card-title">${plan.name}</h4>
                    <i class="fas fa-chart-pie plan-card-icon"></i>
                </div>
                <div class="plan-card-description">${plan.description}</div>
                <div class="plan-card-highlights">
                    ${highlights.map(note => `<span class="plan-highlight-tag">${note}</span>`).join('')}
                </div>
                <div style="margin-top: 1rem; text-align: center; color: #5580AD; font-size: 0.9rem;">
                    <i class="fas fa-eye"></i> ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†é…æ¯”
                </div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = cardsHtml;
}

// æ˜¾ç¤ºé…æ¯”æ–¹æ¡ˆè¯¦æƒ…
function showPlanDetail(planId) {
    const plan = nutritionPlans.find(p => p.id === planId);
    if (!plan) return;
    
    currentPlanDetail = plan;
    
    // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
    document.getElementById('planDetailTitle').textContent = plan.name;
    
    const ratioItems = [
        { label: 'çº¢è‚‰', key: 'red_meat', color: '#dc3545' },
        { label: 'ç™½è‚‰', key: 'white_meat', color: '#28a745' },
        { label: 'é±¼ç±»', key: 'fish', color: '#007bff' },
        { label: 'å†…è„', key: 'organs', color: '#6f42c1' },
        { label: 'è”¬èœ', key: 'vegetables', color: '#20c997' },
        { label: 'æ°´æœ', key: 'fruits', color: '#fd7e14' },
        { label: 'è°·ç‰©', key: 'grains', color: '#6c757d' }
    ].filter(item => plan.category_ratios[item.key] > 0);
    
    const ratioChartHtml = ratioItems.map(item => {
        const percent = Math.round(plan.category_ratios[item.key] * 100);
        return `
            <div class="ratio-item">
                <div class="ratio-label">${item.label}</div>
                <div class="ratio-bar">
                    <div class="ratio-fill" style="width: ${percent}%; background: ${item.color};"></div>
                    <div class="ratio-percent">${percent}%</div>
                </div>
            </div>
        `;
    }).join('');
    
    const contentHtml = `
        <div>
            <h4 style="color: #510B0B; margin-bottom: 1rem;">æ–¹æ¡ˆè¯´æ˜</h4>
            <p style="color: #666; line-height: 1.6;">${plan.description}</p>
        </div>
        
        <div>
            <h4 style="color: #510B0B; margin-bottom: 1rem;">é£Ÿæé…æ¯”</h4>
            <div class="ratio-chart">
                ${ratioChartHtml}
            </div>
        </div>
        
        <div>
            <h4 style="color: #510B0B; margin-bottom: 1rem;">ç‰¹ç‚¹è¯´æ˜</h4>
            <ul style="color: #666; line-height: 1.6;">
                ${plan.special_notes.map(note => `<li>${note}</li>`).join('')}
            </ul>
        </div>
    `;
    
    document.getElementById('planDetailContent').innerHTML = contentHtml;
    document.getElementById('planDetailModal').style.display = 'flex';
}

// å…³é—­é…æ¯”æ–¹æ¡ˆè¯¦æƒ…
function closePlanDetail() {
    document.getElementById('planDetailModal').style.display = 'none';
    currentPlanDetail = null;
}

// é€‰æ‹©è¥å…»é…æ¯”æ–¹æ¡ˆ
function selectNutritionPlan() {
    if (!currentPlanDetail) return;
    
    selectedNutritionPlan = currentPlanDetail;
    
    // æ›´æ–°UI
    document.querySelectorAll('.nutrition-plan-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-plan-id="${currentPlanDetail.id}"]`).classList.add('selected');
    
    // å…³é—­æ¨¡æ€æ¡†
    closePlanDetail();

    // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
    updateNextButtonState();
    
    showSuccessMessage('å·²é€‰æ‹© "${currentPlanDetail.name}" é…æ¯”æ–¹æ¡ˆ');
}

// åŠ è½½é£Ÿæåˆ†ç±»
async function loadCategories() {
    try {
        const response = await fetch('/recipe/api/categories');
        if (!response.ok) {
            throw new Error('Failed to load categories');
        }
        
        categories = await response.json();
        
        const tabsContainer = document.getElementById('categoryTabs');
        tabsContainer.innerHTML = '';
        
        // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
        const allTab = document.createElement('div');
        allTab.className = 'category-tab active';
        allTab.innerHTML = `
            <i class="fas fa-list"></i>
            All Ingredients
            <span class="category-count">${categories.reduce((sum, cat) => sum + cat.count, 0)}</span>
        `;
        allTab.onclick = () => selectCategory('all', allTab);
        tabsContainer.appendChild(allTab);
        
        // æ·»åŠ åˆ†ç±»é€‰é¡¹
        categories.forEach(category => {
            const tab = document.createElement('div');
            tab.className = 'category-tab';
            tab.innerHTML = `
                <i class="${category.icon}"></i>
                ${category.name}
                <span class="category-count">${category.count}</span>
            `;
            tab.onclick = () => selectCategory(category.value, tab);
            tabsContainer.appendChild(tab);
        });
        
        // é»˜è®¤åŠ è½½å…¨éƒ¨é£Ÿæ
        loadIngredients();
        
    } catch (error) {
        console.error('Failed to load categories:', error);
        showErrorMessage('Failed to load ingredient categories, please refresh the page and try again.');
    }
}

// ------- ä¿®æ”¹ï¼šä¿®å¤selectCategoryå‡½æ•°çš„äº‹ä»¶å¤„ç† -------
function selectCategory(categoryValue, tabElement) {
    // æ›´æ–°åˆ†ç±»æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    tabElement.classList.add('active');
    
    // åŠ è½½è¯¥åˆ†ç±»çš„é£Ÿæ
    loadIngredients(categoryValue === 'all' ? null : categoryValue);
}

// åŠ è½½é£Ÿæ
async function loadIngredients(category = null) {
    try {
        const url = new URL('/recipe/api/ingredients', window.location.origin);
        if (category) {
            url.searchParams.append('category', category);
        }
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Failed to load ingredients');
        }
        
        const ingredients = await response.json();
        
        const gridContainer = document.getElementById('ingredientsGrid');
        gridContainer.innerHTML = '';
        
        if (ingredients.length === 0) {
            gridContainer.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1/-1; padding: 2rem;">è¯¥åˆ†ç±»æš‚æ— å¯ç”¨é£Ÿæ</div>';
            return;
        }
        
        ingredients.forEach(ingredient => {
            const card = document.createElement('div');
            card.className = 'ingredient-card';
            if (selectedIngredients.some(item => item.id === ingredient.id)) {
                card.classList.add('selected');
            }
            
            card.innerHTML = `
                ${ingredient.seasonality ? `<div class="ingredient-seasonality">${getSeasonalityText(ingredient.seasonality)}</div>` : ''}
                ${ingredient.is_common_allergen ? '<div class="allergen-warning">Allergen</div>' : ''}
                <div class="ingredient-image">
                    ${ingredient.image_filename ?
                        `<img src="/static/images/ingredients/${ingredient.image_filename}" alt="${ingredient.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        'No Image'
                    }
                </div>
                <div class="ingredient-name">${ingredient.name}</div>
                <div class="ingredient-nutrition">${ingredient.nutrition_summary}</div>
            `;
            
            card.onclick = () => toggleIngredient(ingredient);
            gridContainer.appendChild(card);
        });
        
    } catch (error) {
        console.error('Failed to load ingredients:', error);
        showErrorMessage('Failed to load ingredients, please check your network connection.');
    }
}

// åˆ‡æ¢é£Ÿæé€‰æ‹©çŠ¶æ€
function toggleIngredient(ingredient) {
    const existingIndex = selectedIngredients.findIndex(item => item.id === ingredient.id);
    
    if (existingIndex >= 0) {
        // å–æ¶ˆé€‰æ‹©
        selectedIngredients.splice(existingIndex, 1);
        delete ingredientWeights[ingredient.id];
        showSuccessMessage(`Removed ingredient: ${ingredient.name}`);
    } else {
        // æ·»åŠ é€‰æ‹©
        selectedIngredients.push(ingredient);
        showSuccessMessage(`Added ingredient: ${ingredient.name}`);
    }
    
    // æ›´æ–°UI
    updateSelectedIngredientsDisplay();
    updateIngredientsGridSelection();
    updateNextButtonState();
}

// æ›´æ–°å·²é€‰é£Ÿææ˜¾ç¤º
function updateSelectedIngredientsDisplay() {
    const countEl = document.getElementById('selectedCount');
    const listEl = document.getElementById('selectedList');
    
    countEl.textContent = selectedIngredients.length;
    
    if (selectedIngredients.length === 0) {
        listEl.innerHTML = '<div style="color: #666; font-style: italic;">No ingredients selected yet</div>';
    } else {
        listEl.innerHTML = selectedIngredients.map(ingredient => `
            <div class="selected-tag">
                ${ingredient.name}
                <button class="remove-ingredient" onclick="removeIngredient(${ingredient.id})">Ã—</button>
            </div>
        `).join('');
    }
}

// ç§»é™¤é£Ÿæ
function removeIngredient(ingredientId) {
    const ingredient = selectedIngredients.find(item => item.id === ingredientId);
    const index = selectedIngredients.findIndex(item => item.id === ingredientId);
    if (index >= 0) {
        selectedIngredients.splice(index, 1);
        delete ingredientWeights[ingredientId];
        updateSelectedIngredientsDisplay();
        updateIngredientsGridSelection();
        updateNextButtonState();
        
        if (ingredient) {
            showSuccessMessage(`Removed ingredient: ${ingredient.name}`);
        }
        
        // å¦‚æœåœ¨é‡é‡è®¾ç½®æ­¥éª¤ï¼Œæ›´æ–°é‡é‡è¡¨æ ¼
        if (currentStep === 3) {
            updateWeightTable();
        }
    }
}

// æ›´æ–°é£Ÿæç½‘æ ¼é€‰æ‹©çŠ¶æ€
function updateIngredientsGridSelection() {
    document.querySelectorAll('.ingredient-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    selectedIngredients.forEach(ingredient => {
        const cards = document.querySelectorAll('.ingredient-card');
        cards.forEach(card => {
            const nameEl = card.querySelector('.ingredient-name');
            if (nameEl && nameEl.textContent === ingredient.name) {
                card.classList.add('selected');
            }
        });
    });
}

// è·å–å­£èŠ‚æ€§æ–‡æœ¬
function getSeasonalityText(seasonality) {
    const seasonMap = {
        'all_year': 'All Year',
        'spring': 'Spring',
        'summer': 'Summer',
        'autumn': 'Autumn',
        'winter': 'Winter',
        'spring,summer': 'Spring, Summer',
        'autumn,winter': 'Autumn, Winter'
    };
    return seasonMap[seasonality] || seasonality;
}

// ------- ä¿®æ”¹ï¼šè¡¥å…¨updateWeightTableå‡½æ•° -------
function updateWeightTable() {
    const tbody = document.getElementById('weightTableBody');
    
    if (selectedIngredients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; font-style: italic;">Please select ingredients first</td></tr>';
        return;
    }
    
    tbody.innerHTML = selectedIngredients.map(ingredient => {
        const weight = ingredientWeights[ingredient.id] || 0;
        const calories = (ingredient.calories * weight / 100).toFixed(1);
        const protein = (ingredient.protein * weight / 100).toFixed(1);
        const fat = (ingredient.fat * weight / 100).toFixed(1);
        const carbs = (ingredient.carbohydrate * weight / 100).toFixed(1);
        
        return `
            <tr>
                <td><strong>${ingredient.name}</strong></td>
                <td>
                    <input type="number" class="weight-input"
                        value="${weight}"
                        min="0" max="1000" step="1"
                        onchange="updateIngredientWeight(${ingredient.id}, this.value)"
                        placeholder="0">
                </td>
                <td>${calories}</td>
                <td>${protein}</td>
                <td>${fat}</td>
                <td>${carbs}</td>
            </tr>
        `;
    }).join('');
}

// ------- æ–°å¢ï¼šæ›´æ–°é£Ÿæé‡é‡å‡½æ•° -------
function updateIngredientWeight(ingredientId, weight) {
    const numWeight = parseFloat(weight) || 0;
    
    if (numWeight < 0) {
        showErrorMessage('Weight cannot be negative.');
        return;
    }
    
    if (numWeight > 1000) {
        showErrorMessage('Weight for a single ingredient cannot exceed 1000g.');
        return;
    }
    
    ingredientWeights[ingredientId] = numWeight;
    updateWeightTable(); // é‡æ–°è®¡ç®—è¥å…»æˆåˆ†
    updateNextButtonState();
    
    if (numWeight > 0) {
        const ingredient = selectedIngredients.find(item => item.id === ingredientId);
        if (ingredient) {
            showSuccessMessage(`Set weight for ${ingredient.name}: ${numWeight}g`);
        }
    }
}

// æ›´æ–°ä¸‹ä¸€æ­¥æŒ‰é’®çŠ¶æ€ï¼ŒåŒæ—¶æ§åˆ¶è‡ªåŠ¨åˆ†é…æŒ‰é’®
function updateNextButtonState() {
    const nextBtn = document.getElementById('nextBtn');
    const autoDistributeBtn = document.getElementById('autoDistributeBtn');
    
    if (currentStep === 1) {
        // ç¬¬ä¸€æ­¥éœ€è¦é€‰æ‹©å® ç‰©å’Œè¥å…»æ–¹æ¡ˆ
        if (selectedPetId && selectedNutritionPlan) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
    } else if (currentStep === 2) {
        // ç¬¬äºŒæ­¥éœ€è¦é€‰æ‹©é£Ÿæ
        if (selectedIngredients.length > 0) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
    } else if (currentStep === 3) {
        // ç¬¬ä¸‰æ­¥éœ€è¦è®¾ç½®é‡é‡
        const hasWeights = selectedIngredients.some(ing =>
            ingredientWeights[ing.id] && parseFloat(ingredientWeights[ing.id]) > 0
        );
        if (hasWeights) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
        // æ§åˆ¶è‡ªåŠ¨åˆ†é…æŒ‰é’®çŠ¶æ€
        if (autoDistributeBtn) {
            if (selectedIngredients.length > 0 && selectedNutritionPlan) {
                autoDistributeBtn.disabled = false;
                autoDistributeBtn.style.opacity = '1';
            } else {
                autoDistributeBtn.disabled = true;
                autoDistributeBtn.style.opacity = '0.5';
            }
        }
    } else if (currentStep === 4) {
        // ç¬¬å››æ­¥éœ€è¦å®Œæˆè¥å…»åˆ†æ
        if (nutritionData) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
    } else {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1';
    }
}

// ä¿®æ”¹ç¬¬ä¸‰æ­¥çš„ä¸€é”®åˆ†é…é‡é‡åŠŸèƒ½ï¼Œä½¿ç”¨é€‰æ‹©çš„è¥å…»æ–¹æ¡ˆ
async function autoDistributeWeights() {
    if (!selectedNutritionPlan || selectedIngredients.length === 0) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©è¥å…»æ–¹æ¡ˆå’Œé£Ÿæ');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const btn = document.getElementById('autoDistributeBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
    btn.disabled = true;

    try {
        const response = await fetch('/api/nutrition/suggest-weights', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ingredient_ids: selectedIngredients.map(ing => ing.id),
                nutrition_plan_id: selectedNutritionPlan.id,
                pet_id: selectedPetId,
                total_weight: 200 // é»˜è®¤200g
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to get weight suggestions');
        }
        
        const data = await response.json();
        
        // åº”ç”¨æ¨èé‡é‡
        data.suggested_weights.forEach(item => {
            ingredientWeights[item.ingredient_id] = item.suggested_weight;
        });
        
        // æ›´æ–°é‡é‡è¡¨æ ¼
        updateWeightTable();
        updateNextButtonState();
        
        showSuccessMessage(`å·²æ ¹æ® "${selectedNutritionPlan.name}" æ–¹æ¡ˆè‡ªåŠ¨åˆ†é…é‡é‡`);
        
    } catch (error) {
        console.error('Failed to get weight suggestions:', error);
        showErrorMessage('è·å–é‡é‡å»ºè®®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.innerHTML = originalText;
        if (selectedIngredients.length > 0 && selectedNutritionPlan) {
            btn.disabled = false;
        }
    }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('planDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePlanDetail();
    }
});

// ------- æ–°å¢ï¼šæ›´æ–°ä¸Šä¸€æ­¥æŒ‰é’®çŠ¶æ€å‡½æ•° -------
function updatePrevButtonState() {
    const prevBtn = document.getElementById('prevBtn');
    prevBtn.disabled = currentStep === 1;
}

// æ­¥éª¤å¯¼èˆª
function nextStep() {
    if (currentStep < 5) {
        currentStep++;
        updateStepVisibility();
        updateProgressBar();
        
        // ç‰¹æ®Šå¤„ç†
        if (currentStep === 3) {
            updateWeightTable();
        } else if (currentStep === 4) {
            // è‡ªåŠ¨è®¡ç®—è¥å…»æˆåˆ†
            calculateNutrition();
        }
        
        updateNextButtonState();
        updatePrevButtonState();
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepVisibility();
        updateProgressBar();
        updateNextButtonState();
        updatePrevButtonState();
    }
}

// æ›´æ–°æ­¥éª¤å¯è§æ€§
function updateStepVisibility() {
    for (let i = 1; i <= 5; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i === currentStep) {
            stepEl.classList.remove('hidden');
        } else {
            stepEl.classList.add('hidden');
        }
    }
    
    document.getElementById('currentStepText').textContent = currentStep;
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 5) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'block';
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgressBar() {
    const progressPercentage = (currentStep / 5) * 100;
    document.getElementById('progressLineActive').style.width = `${progressPercentage}%`;
    
    // æ›´æ–°æ­¥éª¤åœ†ç‚¹çŠ¶æ€
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
}

// ------- æ–°å¢ï¼šè®¡ç®—è¥å…»æˆåˆ†å‡½æ•° -------
async function calculateNutrition() {
    if (!selectedPetId) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©å® ç‰©');
        return;
    }
    
    if (selectedIngredients.length === 0) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©é£Ÿæ');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é£Ÿæéƒ½æœ‰é‡é‡
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,  // ä¿æŒåŸæœ‰å­—æ®µå
        weight: parseFloat(ingredientWeights[ingredient.id] || 0)
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('è¯·ä¸ºé£Ÿæè®¾ç½®é‡é‡');
        return;
    }
    
    console.log('å‘é€è¥å…»è®¡ç®—è¯·æ±‚:', {
        ingredients: ingredientsWithWeights,
        pet_id: selectedPetId
    });
    
    try {
        // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„APIè·¯å¾„
        const response = await fetch('/api/nutrition/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ingredients: ingredientsWithWeights,
                pet_id: selectedPetId
            })
        });
        
        console.log('å“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('APIé”™è¯¯:', errorData);
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        nutritionData = await response.json();
        console.log('è¥å…»è®¡ç®—ç»“æœ:', nutritionData);
        
        if (nutritionData.error) {
            throw new Error(nutritionData.error);
        }
        
        // æ˜¾ç¤ºè¥å…»åˆ†æç»“æœ
        displayNutritionAnalysis(nutritionData);
        updateNextButtonState();
        
    } catch (error) {
        console.error('è¥å…»è®¡ç®—å¤±è´¥:', error);
        showErrorMessage(`è¥å…»è®¡ç®—å¤±è´¥: ${error.message}`);
    }
}

// ------- æ–°å¢ï¼šæ˜¾ç¤ºè¥å…»åˆ†æç»“æœå‡½æ•° -------
function displayNutritionAnalysis(data) {
    const container = document.getElementById('nutritionAnalysis');
    
    // è¥å…»çŠ¶æ€é¢œè‰²æ˜ å°„
    const statusColors = {
        'excellent': '#28a745',
        'good': '#17a2b8',
        'calculated': '#ffc107',
        'needs_improvement': '#dc3545',
        'insufficient_data': '#6c757d'
    };
    
    const statusTexts = {
        'excellent': 'ä¼˜ç§€',
        'good': 'è‰¯å¥½',
        'calculated': 'å·²è®¡ç®—',
        'needs_improvement': 'éœ€è¦æ”¹å–„',
        'insufficient_data': 'æ•°æ®ä¸è¶³'
    };

    const analysis = data.nutrition_analysis || {};
    const statusColor = statusColors[analysis.status] || '#6c757d';
    const statusText = statusTexts[analysis.status] || 'æœªçŸ¥';

    // è®¡ç®—é’™ç£·æ¯”
    let calciumPhosphorusRatio = 0;
    let calciumPhosphorusStatus = 'unknown';
    let calciumPhosphorusNote = '';
    
    if (data.total_nutrition.calcium > 0 && data.total_nutrition.phosphorus > 0) {
        calciumPhosphorusRatio = data.total_nutrition.calcium / data.total_nutrition.phosphorus;
        
        // è¯„ä¼°é’™ç£·æ¯”çŠ¶æ€ï¼ˆç†æƒ³èŒƒå›´ 1.0-2.0ï¼‰
        if (calciumPhosphorusRatio >= 1.0 && calciumPhosphorusRatio <= 2.0) {
            calciumPhosphorusStatus = 'excellent';
            calciumPhosphorusNote = 'ç†æƒ³èŒƒå›´';
        } else if (calciumPhosphorusRatio >= 0.8 && calciumPhosphorusRatio < 1.0) {
            calciumPhosphorusStatus = 'warning';
            calciumPhosphorusNote = 'ç•¥ä½ï¼Œå»ºè®®å¢åŠ å«é’™é£Ÿæ';
        } else if (calciumPhosphorusRatio > 2.0 && calciumPhosphorusRatio <= 2.5) {
            calciumPhosphorusStatus = 'warning';
            calciumPhosphorusNote = 'ç•¥é«˜ï¼Œå»ºè®®å¹³è¡¡é’™ç£·æ‘„å…¥';
        } else if (calciumPhosphorusRatio < 0.8) {
            calciumPhosphorusStatus = 'danger';
            calciumPhosphorusNote = 'åä½ï¼Œéœ€è¦å¢åŠ é’™è´¨';
        } else {
            calciumPhosphorusStatus = 'danger';
            calciumPhosphorusNote = 'åé«˜ï¼Œå»ºè®®å‡å°‘é’™è´¨æˆ–å¢åŠ ç£·';
        }
    } else {
        calciumPhosphorusNote = 'æ•°æ®ä¸è¶³';
    }

    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
            <!-- åŸºç¡€è¥å…»ä¿¡æ¯ -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-info-circle"></i>
                    åŸºç¡€è¥å…»ä¿¡æ¯
                </h4>
                <div style="display: grid; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>æ€»é‡é‡:</span>
                        <strong style="color: #5580AD;">${data.total_nutrition.total_weight.toFixed(1)} g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>æ€»çƒ­é‡:</span>
                        <strong style="color: #B82F0D;">${data.total_nutrition.calories.toFixed(1)} kcal</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>è›‹ç™½è´¨:</span>
                        <strong style="color: #28a745;">${data.total_nutrition.protein.toFixed(1)} g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>è„‚è‚ª:</span>
                        <strong style="color: #fd7e14;">${data.total_nutrition.fat.toFixed(1)} g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ç¢³æ°´åŒ–åˆç‰©:</span>
                        <strong style="color: #20c997;">${data.total_nutrition.carbohydrate.toFixed(1)} g</strong>
                    </div>
                </div>
            </div>
            
            <!-- è¥å…»æ¯”ä¾‹ -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-pie"></i>
                    è¥å…»æ¯”ä¾‹
                </h4>
                <div style="display: grid; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>è›‹ç™½è´¨æ¯”ä¾‹:</span>
                        <strong style="color: #28a745;">${data.nutrition_ratios.protein_percent || 0}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>è„‚è‚ªæ¯”ä¾‹:</span>
                        <strong style="color: #fd7e14;">${data.nutrition_ratios.fat_percent || 0}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ç¢³æ°´æ¯”ä¾‹:</span>
                        <strong style="color: #20c997;">${data.nutrition_ratios.carbohydrate_percent || 0}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>çƒ­é‡å¯†åº¦:</span>
                        <strong style="color: #5580AD;">${data.nutrition_ratios.calories_per_100g || 0} kcal/100g</strong>
                    </div>
                    <!-- æ–°å¢ï¼šé’™ç£·æ¯”æ˜¾ç¤º -->
                    <div style="border-top: 1px solid #eee; padding-top: 0.75rem; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                é’™ç£·æ¯”:
                                <i class="fas fa-info-circle"
                                    style="color: #666; font-size: 0.8rem; cursor: help;" 
                                    title="ç†æƒ³é’™ç£·æ¯”ä¸º 1.0-2.0:1ï¼Œå¯¹éª¨éª¼å¥åº·å¾ˆé‡è¦"></i>
                            </span>
                            <div style="text-align: right;">
                                <strong style="color: ${statusColors[calciumPhosphorusStatus] || '#6c757d'};">
                                    ${calciumPhosphorusRatio > 0 ? calciumPhosphorusRatio.toFixed(2) + ':1' : 'æ— æ•°æ®'}
                                </strong>
                                ${calciumPhosphorusNote ? `<br><small style="color: ${statusColors[calciumPhosphorusStatus] || '#6c757d'}; font-size: 0.8rem;">${calciumPhosphorusNote}</small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¥å…»è¯„ä¼° -->
        <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid ${statusColor}; margin-bottom: 2rem;">
            <h4 style="color: ${statusColor}; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-clipboard-check"></i>
                è¥å…»è¯„ä¼° - ${statusText}
                ${analysis.score ? `<span style="font-size: 0.9rem; background: ${statusColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 8px;">${analysis.score}åˆ†</span>` : ''}
            </h4>
            
            ${analysis.recommendations && analysis.recommendations.length > 0 ? `
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #28a745;">âœ“ æ¨è:</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #28a745;">
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            ${analysis.warnings && analysis.warnings.length > 0 ? `
                <div>
                    <strong style="color: #dc3545;">âš  æ³¨æ„äº‹é¡¹:</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #dc3545;">
                        ${analysis.warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}

            <!-- å¦‚æœé’™ç£·æ¯”æœ‰é—®é¢˜ï¼Œæ·»åŠ åˆ°å»ºè®®ä¸­ -->
            ${calciumPhosphorusStatus === 'warning' || calciumPhosphorusStatus === 'danger' ? `
                <div style="margin-top: 1rem; padding: 0.75rem; background: ${calciumPhosphorusStatus === 'danger' ? '#fff5f5' : '#fffaf0'}; border-radius: 8px; border: 1px solid ${statusColors[calciumPhosphorusStatus]};">
                    <strong style="color: ${statusColors[calciumPhosphorusStatus]};">
                        <i class="fas fa-balance-scale"></i> é’™ç£·æ¯”å»ºè®®:
                    </strong>
                    <p style="margin: 0.5rem 0 0 0; color: ${statusColors[calciumPhosphorusStatus]}; font-size: 0.9rem;">
                        ${calciumPhosphorusNote}ã€‚é’™ç£·æ¯”å¯¹å® ç‰©éª¨éª¼å’Œç‰™é½¿å¥åº·è‡³å…³é‡è¦ã€‚
                    </p>
                </div>
            ` : ''}
        </div>
        
        <!-- é£Ÿæè¯¦æƒ…è¡¨æ ¼ -->
        <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid #A1B4B2;">
            <h4 style="color: #510B0B; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-table"></i>
                é£Ÿæè¥å…»è´¡çŒ®
            </h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">é£Ÿæ</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">é‡é‡(g)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">æ¯”ä¾‹(%)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">çƒ­é‡(kcal)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">è›‹ç™½è´¨(g)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">é’™(mg)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">ç£·(mg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.ingredient_details.map(detail => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">${detail.name}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.weight}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.percentage}%</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.calories.toFixed(1)}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.protein.toFixed(1)}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.calcium ? detail.contribution.calcium.toFixed(1) : '0.0'}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.phosphorus ? detail.contribution.phosphorus.toFixed(1) : '0.0'}</td>
                            </tr>
                        `).join('')}
                        <!-- æ·»åŠ æ€»è®¡è¡Œ -->
                        <tr style="background: #f8f9fa; font-weight: bold;">
                            <td style="padding: 0.75rem; border-top: 2px solid #dee2e6;">æ€»è®¡</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">${data.total_nutrition.total_weight.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">100%</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">${data.total_nutrition.calories.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">${data.total_nutrition.protein.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6; color: #5580AD;">${data.total_nutrition.calcium.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6; color: #5580AD;">${data.total_nutrition.phosphorus.toFixed(1)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æˆåŠŸæç¤º -->
        <div style="margin-top: 2rem; padding: 1rem; background: #d4edda; border-radius: 10px; border-left: 4px solid #28a745;">
            <p style="color: #155724; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-check-circle"></i>
                è¥å…»è®¡ç®—å®Œæˆï¼æ‚¨å¯ä»¥ç»§ç»­åˆ°ä¸‹ä¸€æ­¥ä¿å­˜é£Ÿè°±ã€‚
            </p>
        </div>
    `;
}

// ------- æ–°å¢ï¼šä¿å­˜é£Ÿè°±å‡½æ•° -------
async function saveRecipe(isDraft) {
    const recipeName = document.getElementById('recipeName').value.trim();
    const recipeDescription = document.getElementById('recipeDescription').value.trim();
    
    if (!recipeName) {
        showErrorMessage('Please enter a recipe name.');
        return;
    }
    
    if (!selectedPetId || selectedIngredients.length === 0 || !nutritionData) {
        showErrorMessage('Please complete all previous steps.');
        return;
    }
    
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,
        weight: parseFloat(ingredientWeights[ingredient.id] || 0)
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('Please set the ingredient weights.');
        return;
    }
    
    try {
        const response = await fetch('/api/recipe/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: recipeName,
                description: recipeDescription,
                pet_id: selectedPetId,
                ingredients: ingredientsWithWeights,
                nutrition_plan_id: selectedNutritionPlan ? selectedNutritionPlan.id : null,
                is_draft: isDraft,
                is_public: !isDraft
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showErrorMessage(data.error);
            return;
        }
        
        showSuccessMessage(data.message);
        
        // è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒæˆ–é£Ÿè°±è¯¦æƒ…é¡µ
        setTimeout(() => {
            window.location.href = '/user_center';
        }, 2000);
        
    } catch (error) {
        console.error('Failed to save recipe:', error);
        showErrorMessage('Failed to save recipe, please check your network connection.');
    }
}

// ------- æ–°å¢ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å‡½æ•° -------
function showSuccessMessage(message) {
    // ç§»é™¤ç°æœ‰æ¶ˆæ¯
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // åˆ›å»ºæ–°æ¶ˆæ¯
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 3000);
}

// ------- æ–°å¢ï¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å‡½æ•° -------
function showErrorMessage(message) {
    // ç§»é™¤ç°æœ‰æ¶ˆæ¯
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // åˆ›å»ºæ–°æ¶ˆæ¯
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show type-warning';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 5000);
}

// ------- æ–°å¢ï¼šé”®ç›˜å¿«æ·é”®æ”¯æŒ -------
document.addEventListener('keydown', function(e) {
    if (e.altKey) {
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (currentStep > 1) previousStep();
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (currentStep < 5 && !document.getElementById('nextBtn').disabled) nextStep();
                break;
        }
    }
});

// ------- æ–°å¢ï¼šé¡µé¢ç¦»å¼€æé†’ -------
window.addEventListener('beforeunload', function(e) {
    if (selectedIngredients.length > 0 || selectedPetId) {
        e.preventDefault();
        e.returnValue = 'You have unsaved recipe data. Are you sure you want to leave?';
    }
});
</script>

{% endblock %}