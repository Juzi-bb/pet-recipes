{% extends "base.html" %}

{% block title %}创建食谱 - Pet Recipe Website{% endblock %}

{% block content %}
<style>
    .create-recipe-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        color: white;
        border-radius: 15px;
    }

    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    /* 步骤进度条 */
    .progress-container {
        margin-bottom: 3rem;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 2rem;
    }

    .progress-line {
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 3px;
        background: #EDBF9D;
        z-index: 1;
    }

    .progress-line-active {
        height: 3px;
        background: #5580AD;
        transition: width 0.3s ease;
        z-index: 2;
        position: absolute;
        top: 0;
        left: 0;
    }

    .progress-step {
        background: white;
        border: 3px solid #EDBF9D;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #B82F0D;
        position: relative;
        z-index: 3;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .progress-step.completed {
        background: #EDBF9D;
        border-color: #EDBF9D;
        color: #510B0B;
    }

    .step-label {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.9rem;
        color: #510B0B;
        font-weight: 500;
    }

    /* 步骤内容 */
    .step-content {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 2px solid #A1B4B2;
        margin-bottom: 2rem;
    }

    .step-content.hidden {
        display: none;
    }

    .step-title {
        font-size: 1.8rem;
        color: #510B0B;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* 第一步：选择宠物 */
    .pet-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .pet-option {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .pet-option:hover {
        border-color: #5580AD;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(85, 128, 173, 0.2);
    }

    .pet-option.selected {
        border-color: #B82F0D;
        background: #fff5f5;
    }

    .pet-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #EDBF9D;
    }

    .pet-info h3 {
        color: #510B0B;
        margin-bottom: 0.5rem;
        font-size: 1.3rem;
    }

    .pet-stats {
        color: #B82F0D;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* 第二步：选择食材 */
    .category-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .category-tab {
        padding: 0.8rem 1.5rem;
        background: white;
        border: 2px solid #A1B4B2;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .category-tab:hover {
        border-color: #5580AD;
        transform: translateY(-1px);
    }

    .category-tab.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .category-count {
        background: rgba(0,0,0,0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }

    .category-tab.active .category-count {
        background: rgba(255,255,255,0.2);
    }

    .ingredients-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .ingredient-card {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        /* 确保卡片有足够高度 */
        min-height: 240px;
        display: flex;
        flex-direction: column;
    }

    .ingredient-card:hover {
        border-color: #5580AD;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(85, 128, 173, 0.15);
    }

    .ingredient-card.selected {
        border-color: #B82F0D;
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        box-shadow: 0 8px 25px rgba(184, 47, 13, 0.2);
    }

    .ingredient-seasonality {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #EDBF9D;
        color: #510B0B;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .allergen-warning {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #ff4444;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .ingredient-image {
        width: 50%;
        /* 使用aspect-ratio创建正方形容器 */
        aspect-ratio: 1 / 1;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 1rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        overflow: hidden;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
        /* 确保图片容器在flex布局中不会被压缩 */
        flex-shrink: 0;
    }

    .ingredient-card:hover .ingredient-image {
        border-color: #5580AD;
        box-shadow: 0 4px 12px rgba(85, 128, 173, 0.15);
    }

    /* 图片样式 - 保持完整显示 */
    .ingredient-image img {
        width: 100%;
        height: 100%;
        /* 使用contain确保图片完整显示，保持比例 */
        object-fit: contain;
        transition: transform 0.3s ease;
        /* 添加一些内边距，避免图片贴边 */
        padding: 8px;
        box-sizing: border-box;
    }

    .ingredient-card:hover .ingredient-image img {
        transform: scale(1.05);
    }

    /* 图片加载失败时的样式 */
    .ingredient-image div {
        font-style: italic;
        text-align: center;
        padding: 1rem;
        color: #999;
        font-size: 0.9rem;
    }

    /* 食材名称和营养信息 - 调整为flex布局底部对齐 */
    .ingredient-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #510B0B;
        margin-bottom: 0.5rem;
        text-align: center;
        /* 在flex容器中占据剩余空间 */
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ingredient-nutrition {
        font-size: 0.9rem;
        color: #B82F0D;
        text-align: center;
        line-height: 1.3;
        /* 固定在底部 */
        margin-top: auto;
    }

    /* 响应式优化 - 不同屏幕尺寸下的网格调整 */
    @media (max-width: 768px) {
        .ingredients-grid {
            /* 手机端：最小180px */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .ingredient-card {
            padding: 1rem;
            min-height: 220px;
        }
        
        .ingredient-image {
            margin: 0.8rem 0;
        }
        
        .ingredient-name {
            font-size: 1.1rem;
        }
        
        .ingredient-nutrition {
            font-size: 0.85rem;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .ingredients-grid {
            /* 平板端：最小190px */
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
        .ingredients-grid {
            /* 桌面端：最小200px */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }

    @media (min-width: 1441px) {
        .ingredients-grid {
            /* 大屏幕：最小210px，最多一行5个 */
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            max-width: 1800px;
            margin: 0 auto 2rem auto;
        }
    }

    /* 为不支持aspect-ratio的浏览器提供备选方案 */
    @supports not (aspect-ratio: 1 / 1) {
        .ingredient-image {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%; /* 创建正方形 */
        }
        
        .ingredient-image img,
        .ingredient-image div {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    }

    /* 已选食材显示 */
    .selected-ingredients-panel {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 2px solid #A1B4B2;
    }

    .selected-ingredients-panel h3 {
        color: #510B0B;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .selected-count {
        background: #B82F0D;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }

    .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
    }

    .selected-tag {
        background: #5580AD;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
    }

    /* 第三步：重量设置 */
    .weight-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .weight-table th {
        background: #5580AD;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    .weight-table td {
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }

    .weight-table tbody tr:hover {
        background: #f8f9fa;
    }

    .weight-input {
        width: 80px;
        padding: 0.5rem;
        border: 2px solid #A1B4B2;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        transition: border-color 0.3s ease;
    }

    .weight-input:focus {
        outline: none;
        border-color: #5580AD;
    }

    /* 导航按钮 */
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .nav-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .prev-btn {
        background: #A1B4B2;
        color: white;
    }

    .prev-btn:hover:not(:disabled) {
        background: #8a9b99;
        transform: translateX(-2px);
    }

    .prev-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .next-btn {
        background: #B82F0D;
        color: white;
    }

    .next-btn:hover:not(:disabled) {
        background: #a0280b;
        transform: translateX(2px);
    }

    .next-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .step-info {
        color: #510B0B;
        font-weight: 500;
    }

    /* 加载状态 */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #A1B4B2;
        border-top: 4px solid #5580AD;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ------- 新增：消息提示样式 ------- */
    .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .success-message.show {
        opacity: 1;
        transform: translateX(0);
    }

    .success-message.hide {
        opacity: 0;
        transform: translateX(100%);
    }

    .success-message.type-warning {
        background: #ff4444;
    }

    .success-message.type-info {
        background: #2196F3;
    }
</style>

<div class="create-recipe-container">
    <div class="page-header">
        <h1>🍽️ 创建宠物食谱</h1>
        <p>为您的爱宠定制营养均衡的美味食谱</p>
    </div>

    <!-- 进度条 -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-active" id="progressLineActive" style="width: 20%;"></div>
            </div>
            <div class="progress-step active" data-step="1">
                <span>1</span>
                <div class="step-label">选择宠物</div>
            </div>
            <div class="progress-step" data-step="2">
                <span>2</span>
                <div class="step-label">选择食材</div>
            </div>
            <div class="progress-step" data-step="3">
                <span>3</span>
                <div class="step-label">设置重量</div>
            </div>
            <div class="progress-step" data-step="4">
                <span>4</span>
                <div class="step-label">营养分析</div>
            </div>
            <div class="progress-step" data-step="5">
                <span>5</span>
                <div class="step-label">保存食谱</div>
            </div>
        </div>
    </div>

    <!-- 第一步：选择宠物 -->
    <div class="step-content" id="step1">
        <div class="step-title">
            <i class="fas fa-paw"></i>
            选择目标宠物
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">选择要为哪只宠物创建食谱，我们将根据其信息提供个性化营养建议。</p>
        
        <div class="pet-selector">
            {% for pet in pets %}
            <div class="pet-option" data-pet-id="{{ pet.id }}">
                <img src="{{ url_for('static', filename='images/avatars/' + pet.avatar) }}" alt="{{ pet.name }}" class="pet-avatar">
                <div class="pet-info">
                    <h3>{{ pet.name }}</h3>
                    <div class="pet-stats">
                        {{ pet.species }} | {{ pet.weight }}kg | {{ pet.age }}岁
                        {% if pet.breed %}
                        <br>{{ pet.breed }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 第二步：选择食材 -->
    <div class="step-content hidden" id="step2">
        <div class="step-title">
            <i class="fas fa-carrot"></i>
            选择食材
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">从不同分类中选择您想要的食材，建议搭配多种类型以确保营养均衡。</p>
        
        <!-- 分类标签 -->
        <div class="category-tabs" id="categoryTabs">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">加载食材分类中...</span>
            </div>
        </div>

        <!-- 食材网格 -->
        <div class="ingredients-grid" id="ingredientsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">加载食材中...</span>
            </div>
        </div>

        <!-- 已选食材显示 -->
        <div class="selected-ingredients-panel">
            <h3>
                <i class="fas fa-check-circle"></i>
                已选择食材
                <span class="selected-count" id="selectedCount">0</span>
            </h3>
            <div class="selected-list" id="selectedList">
                <div style="color: #666; font-style: italic;">还未选择任何食材</div>
            </div>
        </div>
    </div>

    <!-- 第三步：设置重量 -->
    <div class="step-content hidden" id="step3">
        <div class="step-title">
            <i class="fas fa-weight"></i>
            设置食材重量
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">为每种食材设置合适的重量(克)，系统将实时计算营养成分。</p>
        
        <table class="weight-table">
            <thead>
                <tr>
                    <th>食材名称</th>
                    <th>重量(克)</th>
                    <th>热量(卡)</th>
                    <th>蛋白质(克)</th>
                    <th>脂肪(克)</th>
                    <th>碳水(克)</th>
                </tr>
            </thead>
            <tbody id="weightTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; color: #666; font-style: italic;">请先选择食材</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 第四步：营养分析 -->
    <div class="step-content hidden" id="step4">
        <div class="step-title">
            <i class="fas fa-chart-bar"></i>
            营养成分分析
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">查看食谱的详细营养成分，确保符合您宠物的营养需求。</p>
        
        <div id="nutritionAnalysis">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">分析营养成分中...</span>
            </div>
        </div>
    </div>

    <!-- 第五步：保存食谱 -->
    <div class="step-content hidden" id="step5">
        <div class="step-title">
            <i class="fas fa-save"></i>
            保存食谱
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">为您的食谱起个名字，并添加描述信息。</p>
        
        <div style="max-width: 600px;">
            <div class="form-group">
                <label for="recipeName">食谱名称 *</label>
                <input type="text" id="recipeName" placeholder="例如：小可爱的营养大餐" maxlength="50">
            </div>
            <div class="form-group">
                <label for="recipeDescription">食谱描述</label>
                <textarea id="recipeDescription" rows="4" placeholder="描述这个食谱的特色、适用场景等..." maxlength="200"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="nav-btn" style="background: #A1B4B2;" onclick="saveRecipe(true)">
                    <i class="fas fa-edit"></i>
                    保存为草稿
                </button>
                <button class="nav-btn" style="background: #B82F0D;" onclick="saveRecipe(false)">
                    <i class="fas fa-check"></i>
                    发布食谱
                </button>
            </div>
        </div>
    </div>

    <!-- 导航按钮 -->
    <div class="navigation-buttons">
        <button class="nav-btn prev-btn" id="prevBtn" onclick="previousStep()" disabled>
            <i class="fas fa-chevron-left"></i>
            上一步
        </button>
        
        <div class="step-info">
            第 <span id="currentStepText">1</span> / 5 步
        </div>
        
        <button class="nav-btn next-btn" id="nextBtn" onclick="nextStep()" disabled>
            下一步
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 全局变量
let currentStep = 1;
let selectedPetId = null;
let selectedIngredients = [];
let ingredientWeights = {};
let nutritionData = null;
let categories = [];
let allIngredients = [];

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    // 为所有宠物选项添加点击事件监听器
    document.addEventListener('click', function(e) {
        const petOption = e.target.closest('.pet-option');
        if (petOption) {
            const petId = petOption.getAttribute('data-pet-id');
            selectPet(petId);
        }
    });
    
    loadCategories();
    updateStepVisibility();
    updateProgressBar();
    updatePrevButtonState();
});

// 选择宠物
function selectPet(petId) {
    selectedPetId = petId;
    
    // 更新UI
    document.querySelectorAll('.pet-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`[data-pet-id="${petId}"]`).classList.add('selected');
    
    // 启用下一步按钮
    updateNextButtonState();
    
    showSuccessMessage('已选择宠物，可以进入下一步');
}

// 加载食材分类
async function loadCategories() {
    try {
        const response = await fetch('/recipe/api/categories');
        if (!response.ok) {
            throw new Error('加载分类失败');
        }
        
        categories = await response.json();
        
        const tabsContainer = document.getElementById('categoryTabs');
        tabsContainer.innerHTML = '';
        
        // 添加"全部"选项
        const allTab = document.createElement('div');
        allTab.className = 'category-tab active';
        allTab.innerHTML = `
            <i class="fas fa-list"></i>
            全部食材
            <span class="category-count">${categories.reduce((sum, cat) => sum + cat.count, 0)}</span>
        `;
        allTab.onclick = () => selectCategory('all', allTab);
        tabsContainer.appendChild(allTab);
        
        // 添加分类选项
        categories.forEach(category => {
            const tab = document.createElement('div');
            tab.className = 'category-tab';
            tab.innerHTML = `
                <i class="${category.icon}"></i>
                ${category.name}
                <span class="category-count">${category.count}</span>
            `;
            tab.onclick = () => selectCategory(category.value, tab);
            tabsContainer.appendChild(tab);
        });
        
        // 默认加载全部食材
        loadIngredients();
        
    } catch (error) {
        console.error('加载分类失败:', error);
        showErrorMessage('加载食材分类失败，请刷新页面重试');
    }
}

// ------- 修改：修复selectCategory函数的事件处理 -------
function selectCategory(categoryValue, tabElement) {
    // 更新分类标签状态
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    tabElement.classList.add('active');
    
    // 加载该分类的食材
    loadIngredients(categoryValue === 'all' ? null : categoryValue);
}

// 加载食材
async function loadIngredients(category = null) {
    try {
        const url = new URL('/recipe/api/ingredients', window.location.origin);
        if (category) {
            url.searchParams.append('category', category);
        }
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('加载食材失败');
        }
        
        const ingredients = await response.json();
        
        const gridContainer = document.getElementById('ingredientsGrid');
        gridContainer.innerHTML = '';
        
        if (ingredients.length === 0) {
            gridContainer.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1/-1; padding: 2rem;">该分类暂无可用食材</div>';
            return;
        }
        
        ingredients.forEach(ingredient => {
            const card = document.createElement('div');
            card.className = 'ingredient-card';
            if (selectedIngredients.some(item => item.id === ingredient.id)) {
                card.classList.add('selected');
            }
            
            card.innerHTML = `
                ${ingredient.seasonality ? `<div class="ingredient-seasonality">${getSeasonalityText(ingredient.seasonality)}</div>` : ''}
                ${ingredient.is_common_allergen ? '<div class="allergen-warning">过敏原</div>' : ''}
                <div class="ingredient-image">
                    ${ingredient.image_filename ?
                        `<img src="/static/images/ingredients/${ingredient.image_filename}" alt="${ingredient.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        '暂无图片'
                    }
                </div>
                <div class="ingredient-name">${ingredient.name}</div>
                <div class="ingredient-nutrition">${ingredient.nutrition_summary}</div>
            `;
            
            card.onclick = () => toggleIngredient(ingredient);
            gridContainer.appendChild(card);
        });
        
    } catch (error) {
        console.error('加载食材失败:', error);
        showErrorMessage('加载食材失败，请检查网络连接');
    }
}

// 切换食材选择状态
function toggleIngredient(ingredient) {
    const existingIndex = selectedIngredients.findIndex(item => item.id === ingredient.id);
    
    if (existingIndex >= 0) {
        // 取消选择
        selectedIngredients.splice(existingIndex, 1);
        delete ingredientWeights[ingredient.id];
        showSuccessMessage(`已移除食材：${ingredient.name}`);
    } else {
        // 添加选择
        selectedIngredients.push(ingredient);
        showSuccessMessage(`已添加食材：${ingredient.name}`);
    }
    
    // 更新UI
    updateSelectedIngredientsDisplay();
    updateIngredientsGridSelection();
    updateNextButtonState();
}

// 更新已选食材显示
function updateSelectedIngredientsDisplay() {
    const countEl = document.getElementById('selectedCount');
    const listEl = document.getElementById('selectedList');
    
    countEl.textContent = selectedIngredients.length;
    
    if (selectedIngredients.length === 0) {
        listEl.innerHTML = '<div style="color: #666; font-style: italic;">还未选择任何食材</div>';
    } else {
        listEl.innerHTML = selectedIngredients.map(ingredient => `
            <div class="selected-tag">
                ${ingredient.name}
                <button class="remove-ingredient" onclick="removeIngredient(${ingredient.id})">×</button>
            </div>
        `).join('');
    }
}

// 移除食材
function removeIngredient(ingredientId) {
    const ingredient = selectedIngredients.find(item => item.id === ingredientId);
    const index = selectedIngredients.findIndex(item => item.id === ingredientId);
    if (index >= 0) {
        selectedIngredients.splice(index, 1);
        delete ingredientWeights[ingredientId];
        updateSelectedIngredientsDisplay();
        updateIngredientsGridSelection();
        updateNextButtonState();
        
        if (ingredient) {
            showSuccessMessage(`已移除食材：${ingredient.name}`);
        }
        
        // 如果在重量设置步骤，更新重量表格
        if (currentStep === 3) {
            updateWeightTable();
        }
    }
}

// 更新食材网格选择状态
function updateIngredientsGridSelection() {
    document.querySelectorAll('.ingredient-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    selectedIngredients.forEach(ingredient => {
        const cards = document.querySelectorAll('.ingredient-card');
        cards.forEach(card => {
            const nameEl = card.querySelector('.ingredient-name');
            if (nameEl && nameEl.textContent === ingredient.name) {
                card.classList.add('selected');
            }
        });
    });
}

// 获取季节性文本
function getSeasonalityText(seasonality) {
    const seasonMap = {
        'all_year': '全年',
        'spring': '春季',
        'summer': '夏季',
        'autumn': '秋季',
        'winter': '冬季',
        'spring,summer': '春夏',
        'autumn,winter': '秋冬'
    };
    return seasonMap[seasonality] || seasonality;
}

// ------- 修改：补全updateWeightTable函数 -------
function updateWeightTable() {
    const tbody = document.getElementById('weightTableBody');
    
    if (selectedIngredients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; font-style: italic;">请先选择食材</td></tr>';
        return;
    }
    
    tbody.innerHTML = selectedIngredients.map(ingredient => {
        const weight = ingredientWeights[ingredient.id] || 0;
        const calories = (ingredient.calories * weight / 100).toFixed(1);
        const protein = (ingredient.protein * weight / 100).toFixed(1);
        const fat = (ingredient.fat * weight / 100).toFixed(1);
        const carbs = (ingredient.carbohydrate * weight / 100).toFixed(1);
        
        return `
            <tr>
                <td><strong>${ingredient.name}</strong></td>
                <td>
                    <input type="number" class="weight-input"
                        value="${weight}"
                        min="0" max="1000" step="1"
                        onchange="updateIngredientWeight(${ingredient.id}, this.value)"
                        placeholder="0">
                </td>
                <td>${calories}</td>
                <td>${protein}</td>
                <td>${fat}</td>
                <td>${carbs}</td>
            </tr>
        `;
    }).join('');
}

// ------- 新增：更新食材重量函数 -------
function updateIngredientWeight(ingredientId, weight) {
    const numWeight = parseFloat(weight) || 0;
    
    if (numWeight < 0) {
        showErrorMessage('重量不能为负数');
        return;
    }
    
    if (numWeight > 1000) {
        showErrorMessage('单个食材重量不能超过1000克');
        return;
    }
    
    ingredientWeights[ingredientId] = numWeight;
    updateWeightTable(); // 重新计算营养成分
    updateNextButtonState();
    
    if (numWeight > 0) {
        const ingredient = selectedIngredients.find(item => item.id === ingredientId);
        if (ingredient) {
            showSuccessMessage(`已设置${ingredient.name}重量：${numWeight}克`);
        }
    }
}

// 更新下一步按钮状态
function updateNextButtonState() {
    const nextBtn = document.getElementById('nextBtn');
    
    switch(currentStep) {
        case 1:
            nextBtn.disabled = !selectedPetId;
            break;
        case 2:
            nextBtn.disabled = selectedIngredients.length === 0;
            break;
        case 3:
            // 检查是否所有食材都设置了重量
            const hasWeights = selectedIngredients.every(ingredient =>
                ingredientWeights[ingredient.id] && ingredientWeights[ingredient.id] > 0
            );
            nextBtn.disabled = !hasWeights;
            break;
        case 4:
            nextBtn.disabled = !nutritionData;
            break;
        default:
            nextBtn.disabled = false;
    }
}

// ------- 新增：更新上一步按钮状态函数 -------
function updatePrevButtonState() {
    const prevBtn = document.getElementById('prevBtn');
    prevBtn.disabled = currentStep === 1;
}

// 步骤导航
function nextStep() {
    if (currentStep < 5) {
        currentStep++;
        updateStepVisibility();
        updateProgressBar();
        
        // 特殊处理
        if (currentStep === 3) {
            updateWeightTable();
        } else if (currentStep === 4) {
            // 自动计算营养成分
            calculateNutrition();
        }
        
        updateNextButtonState();
        updatePrevButtonState();
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepVisibility();
        updateProgressBar();
        updateNextButtonState();
        updatePrevButtonState();
    }
}

// 更新步骤可见性
function updateStepVisibility() {
    for (let i = 1; i <= 5; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i === currentStep) {
            stepEl.classList.remove('hidden');
        } else {
            stepEl.classList.add('hidden');
        }
    }
    
    document.getElementById('currentStepText').textContent = currentStep;
    
    // 更新导航按钮
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 5) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'block';
    }
}

// 更新进度条
function updateProgressBar() {
    const progressPercentage = (currentStep / 5) * 100;
    document.getElementById('progressLineActive').style.width = `${progressPercentage}%`;
    
    // 更新步骤圆点状态
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
}

// ------- 新增：计算营养成分函数 -------
async function calculateNutrition() {
    try {
        const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
            ingredient_id: ingredient.id,
            weight: ingredientWeights[ingredient.id] || 0
        })).filter(item => item.weight > 0);
        
        if (ingredientsWithWeights.length === 0) {
            showErrorMessage('请先设置食材重量');
            return;
        }
        
        const response = await fetch('/recipe/api/calculate_nutrition', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ingredients: ingredientsWithWeights,
                pet_id: selectedPetId
            })
        });
        
        if (!response.ok) {
            throw new Error('计算营养成分失败');
        }
        
        nutritionData = await response.json();
        
        // 显示营养分析结果
        displayNutritionAnalysis(nutritionData);
        updateNextButtonState();
        
    } catch (error) {
        console.error('计算营养成分失败:', error);
        showErrorMessage('计算营养成分失败，请检查网络连接');
    }
}

// ------- 新增：显示营养分析结果函数 -------
function displayNutritionAnalysis(data) {
    const container = document.getElementById('nutritionAnalysis');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
            <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem;">基础营养信息</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <div>总重量: <strong>${data.total_weight.toFixed(1)}克</strong></div>
                    <div>总热量: <strong>${data.calories.toFixed(1)}卡</strong></div>
                    <div>蛋白质: <strong>${data.protein.toFixed(1)}克</strong></div>
                    <div>脂肪: <strong>${data.fat.toFixed(1)}克</strong></div>
                    <div>碳水化合物: <strong>${data.carbohydrate.toFixed(1)}克</strong></div>
                </div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem;">营养密度</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <div>每100克热量: <strong>${(data.calories / data.total_weight * 100).toFixed(1)}卡</strong></div>
                    <div>蛋白质占比: <strong>${(data.protein * 4 / data.calories * 100).toFixed(1)}%</strong></div>
                    <div>脂肪占比: <strong>${(data.fat * 9 / data.calories * 100).toFixed(1)}%</strong></div>
                    <div>碳水占比: <strong>${(data.carbohydrate * 4 / data.calories * 100).toFixed(1)}%</strong></div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 2rem; padding: 1rem; background: #e8f5e8; border-radius: 10px; border-left: 4px solid #4CAF50;">
            <p style="color: #2e7d32; margin: 0;">
                <i class="fas fa-check-circle"></i>
                营养成分计算完成！您的食谱看起来营养均衡。
            </p>
        </div>
    `;
}

// ------- 新增：保存食谱函数 -------
async function saveRecipe(isDraft) {
    const recipeName = document.getElementById('recipeName').value.trim();
    const recipeDescription = document.getElementById('recipeDescription').value.trim();
    
    if (!recipeName) {
        showErrorMessage('请输入食谱名称');
        return;
    }
    
    if (!selectedPetId || selectedIngredients.length === 0 || !nutritionData) {
        showErrorMessage('请完成所有步骤');
        return;
    }
    
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,
        weight: ingredientWeights[ingredient.id] || 0
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('请设置食材重量');
        return;
    }
    
    try {
        const response = await fetch('/recipe/api/save_recipe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: recipeName,
                description: recipeDescription,
                pet_id: selectedPetId,
                ingredients: ingredientsWithWeights,
                is_draft: isDraft
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showErrorMessage(data.error);
            return;
        }
        
        showSuccessMessage(data.message);
        
        // 跳转到用户中心或食谱详情页
        setTimeout(() => {
            window.location.href = '/user_center';
        }, 2000);
        
    } catch (error) {
        console.error('保存食谱失败:', error);
        showErrorMessage('保存食谱失败，请检查网络连接');
    }
}

// ------- 新增：显示成功消息函数 -------
function showSuccessMessage(message) {
    // 移除现有消息
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // 创建新消息
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 3秒后自动隐藏
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 3000);
}

// ------- 新增：显示错误消息函数 -------
function showErrorMessage(message) {
    // 移除现有消息
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // 创建新消息
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show type-warning';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 5秒后自动隐藏
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 5000);
}

// ------- 新增：键盘快捷键支持 -------
document.addEventListener('keydown', function(e) {
    if (e.altKey) {
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (currentStep > 1) previousStep();
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (currentStep < 5 && !document.getElementById('nextBtn').disabled) nextStep();
                break;
        }
    }
});

// ------- 新增：页面离开提醒 -------
window.addEventListener('beforeunload', function(e) {
    if (selectedIngredients.length > 0 || selectedPetId) {
        e.preventDefault();
        e.returnValue = '您有未保存的食谱数据，确定要离开吗？';
    }
});
</script>

{% endblock %}