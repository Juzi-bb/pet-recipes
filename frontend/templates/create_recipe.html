{% extends "base.html" %}

{% block title %}Create Recipe - Pet Recipe Website{% endblock %}

{% block content %}
<style>
    .create-recipe-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        color: white;
        border-radius: 15px;
    }

    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    /* Ê≠•È™§ËøõÂ∫¶Êù°Ê†∑Âºè */
    .progress-container {
        margin-bottom: 3rem;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 2rem;
    }

    .progress-line {
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 3px;
        background: #EDBF9D;
        z-index: 1;
    }

    .progress-line-active {
        height: 3px;
        background: #5580AD;
        transition: width 0.3s ease;
        z-index: 2;
        position: absolute;
        top: 0;
        left: 0;
    }

    .progress-step {
        background: white;
        border: 3px solid #EDBF9D;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #B82F0D;
        position: relative;
        z-index: 3;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .progress-step.completed {
        background: #EDBF9D;
        border-color: #EDBF9D;
        color: #510B0B;
    }

    .step-label {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.9rem;
        color: #510B0B;
        font-weight: 500;
    }

    /* Ê≠•È™§ÂÜÖÂÆπÊ†∑Âºè */
    .step-content {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 2px solid #A1B4B2;
        margin-bottom: 2rem;
    }

    .step-content.hidden {
        display: none;
    }

    .step-title {
        font-size: 1.8rem;
        color: #510B0B;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* Á¨¨‰∏ÄÊ≠•ÔºöÈÄâÊã©ÂÆ†Áâ©Ê†∑Âºè */
    .pet-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .pet-option {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .pet-option:hover {
        border-color: #5580AD;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(85, 128, 173, 0.2);
    }

    .pet-option.selected {
        border-color: #B82F0D;
        background: #fff5f5;
    }

    .pet-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #EDBF9D;
    }

    .pet-info h3 {
        color: #510B0B;
        margin-bottom: 0.5rem;
        font-size: 1.3rem;
    }

    .pet-stats {
        color: #B82F0D;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* Á¨¨‰∫åÊ≠•ÔºöÈÄâÊã©È£üÊùêÊ†∑Âºè */
    .category-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .category-tab {
        padding: 0.8rem 1.5rem;
        background: white;
        border: 2px solid #A1B4B2;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .category-tab:hover {
        border-color: #5580AD;
        transform: translateY(-1px);
    }

    .category-tab.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .category-count {
        background: rgba(0,0,0,0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }

    .category-tab.active .category-count {
        background: rgba(255,255,255,0.2);
    }

    .ingredients-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .ingredient-card {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-height: 240px;
        display: flex;
        flex-direction: column;
    }

    .ingredient-card:hover {
        border-color: #5580AD;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(85, 128, 173, 0.15);
    }

    .ingredient-card.selected {
        border-color: #B82F0D;
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        box-shadow: 0 8px 25px rgba(184, 47, 13, 0.2);
    }

    .ingredient-seasonality {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #EDBF9D;
        color: #510B0B;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .allergen-warning {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #ff4444;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .ingredient-image {
        width: 50%;
        aspect-ratio: 1 / 1;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 1rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        overflow: hidden;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
        flex-shrink: 0;
    }

    .ingredient-card:hover .ingredient-image {
        border-color: #5580AD;
        box-shadow: 0 4px 12px rgba(85, 128, 173, 0.15);
    }

    .ingredient-image img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: transform 0.3s ease;
        padding: 8px;
        box-sizing: border-box;
    }

    .ingredient-card:hover .ingredient-image img {
        transform: scale(1.05);
    }

    .ingredient-image div {
        font-style: italic;
        text-align: center;
        padding: 1rem;
        color: #999;
        font-size: 0.9rem;
    }

    .ingredient-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #510B0B;
        margin-bottom: 0.5rem;
        text-align: center;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ingredient-nutrition {
        font-size: 0.9rem;
        color: #B82F0D;
        text-align: center;
        line-height: 1.3;
        margin-top: auto;
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 768px) {
        .ingredients-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .ingredient-card {
            padding: 1rem;
            min-height: 220px;
        }
        
        .ingredient-image {
            margin: 0.8rem 0;
        }
        
        .ingredient-name {
            font-size: 1.1rem;
        }
        
        .ingredient-nutrition {
            font-size: 0.85rem;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .ingredients-grid {
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
        .ingredients-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }

    @media (min-width: 1441px) {
        .ingredients-grid {
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            max-width: 1800px;
            margin: 0 auto 2rem auto;
        }
    }

    /* ÂÖºÂÆπÊÄßÊîØÊåÅ */
    @supports not (aspect-ratio: 1 / 1) {
        .ingredient-image {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%;
        }
        
        .ingredient-image img,
        .ingredient-image div {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    }

    /* Â∑≤ÈÄâÈ£üÊùêÊòæÁ§∫Ê†∑Âºè */
    .selected-ingredients-panel {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 2px solid #A1B4B2;
    }

    .selected-ingredients-panel h3 {
        color: #510B0B;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .selected-count {
        background: #B82F0D;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }

    .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
    }

    .selected-tag {
        background: #5580AD;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
    }

    /* Á¨¨‰∏âÊ≠•ÔºöÈáçÈáèËÆæÁΩÆÊ†∑Âºè */
    .weight-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .weight-table th {
        background: #5580AD;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    .weight-table td {
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }

    .weight-table tbody tr:hover {
        background: #f8f9fa;
    }

    .weight-input {
        width: 80px;
        padding: 0.5rem;
        border: 2px solid #A1B4B2;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        transition: border-color 0.3s ease;
    }

    .weight-input:focus {
        outline: none;
        border-color: #5580AD;
    }

    /* ÂØºËà™ÊåâÈíÆÊ†∑Âºè */
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .nav-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .prev-btn {
        background: #A1B4B2;
        color: white;
    }

    .prev-btn:hover:not(:disabled) {
        background: #8a9b99;
        transform: translateX(-2px);
    }

    .prev-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .next-btn {
        background: #B82F0D;
        color: white;
    }

    .next-btn:hover:not(:disabled) {
        background: #a0280b;
        transform: translateX(2px);
    }

    .next-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .step-info {
        color: #510B0B;
        font-weight: 500;
    }

    /* Âä†ËΩΩÁä∂ÊÄÅÊ†∑Âºè */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #A1B4B2;
        border-top: 4px solid #5580AD;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Ê∂àÊÅØÊèêÁ§∫Ê†∑Âºè */
    .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .success-message.show {
        opacity: 1;
        transform: translateX(0);
    }

    .success-message.hide {
        opacity: 0;
        transform: translateX(100%);
    }

    .success-message.type-warning {
        background: #ff4444;
    }

    .success-message.type-info {
        background: #2196F3;
    }

    /* Ëê•ÂÖªÈÖçÊØîÊñπÊ°àÊ†∑Âºè */
    .nutrition-plan-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 2px solid #EDBF9D;
    }

    .nutrition-plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .nutrition-plan-card {
        background: white;
        border: 2px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .nutrition-plan-card:hover {
        border-color: #5580AD;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(85, 128, 173, 0.15);
    }

    .nutrition-plan-card.selected {
        border-color: #B82F0D;
        background: #fff8f8;
        box-shadow: 0 5px 20px rgba(184, 47, 13, 0.2);
    }

    .nutrition-plan-card.recommended {
        border-color: #28a745;
        position: relative;
    }

    .nutrition-plan-card.recommended::before {
        content: "Recommended";
        position: absolute;
        top: -8px;
        right: 15px;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .plan-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .plan-card-title {
        color: #510B0B;
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0;
    }

    .plan-card-icon {
        font-size: 1.5rem;
        color: #5580AD;
    }

    .plan-card-description {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
        margin-bottom: 1rem;
    }

    .plan-card-highlights {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .plan-highlight-tag {
        background: #f0f7ff;
        color: #5580AD;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        border: 1px solid #5580AD;
    }

    /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }

    .plan-detail-modal {
        background: white;
        border-radius: 15px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        color: #510B0B;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 2px solid #f0f0f0;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .ratio-chart {
        display: grid;
        gap: 0.75rem;
        margin: 1.5rem 0;
    }

    .ratio-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .ratio-label {
        min-width: 80px;
        font-weight: bold;
        color: #510B0B;
    }

    .ratio-bar {
        flex: 1;
        height: 25px;
        background: #f0f0f0;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    .ratio-fill {
        height: 100%;
        background: linear-gradient(90deg, #5580AD, #B82F0D);
        border-radius: 12px;
        transition: width 0.3s ease;
    }

    .ratio-percent {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.8rem;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #B82F0D;
        color: white;
    }

    .btn-primary:hover {
        background: #a02a0c;
    }

    .btn-secondary {
        background: #A1B4B2;
        color: white;
    }

    .btn-secondary:hover {
        background: #8a9a99;
    }

    /* Ë°®ÂçïÊ†∑Âºè */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #510B0B;
        font-weight: 600;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #A1B4B2;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #5580AD;
    }
</style>

<div class="create-recipe-container">
    <div class="page-header">
        <h1>üçΩÔ∏è Create a Pet Recipe</h1>
        <p>Customize a nutritious and delicious recipe for your beloved pet</p>
    </div>

    <!-- ËøõÂ∫¶Êù° -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-active" id="progressLineActive" style="width: 20%;"></div>
            </div>
            <div class="progress-step active" data-step="1">
                <span>1</span>
                <div class="step-label">Select Pet</div>
            </div>
            <div class="progress-step" data-step="2">
                <span>2</span>
                <div class="step-label">Select Ingredients</div>
            </div>
            <div class="progress-step" data-step="3">
                <span>3</span>
                <div class="step-label">Set Weights</div>
            </div>
            <div class="progress-step" data-step="4">
                <span>4</span>
                <div class="step-label">Nutrition Analysis</div>
            </div>
            <div class="progress-step" data-step="5">
                <span>5</span>
                <div class="step-label">Save Recipe</div>
            </div>
        </div>
    </div>

    <!-- Á¨¨‰∏ÄÊ≠•ÔºöÈÄâÊã©ÂÆ†Áâ© -->
    <div class="step-content" id="step1">
        <div class="step-title">
            <i class="fas fa-paw"></i>
            Select Target Pet
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Choose which pet you want to create a recipe for. We will provide personalized nutritional advice based on their information.</p>
        
        <div class="pet-selector">
            {% for pet in pets %}
            <div class="pet-option" data-pet-id="{{ pet.id }}">
                <img src="{{ url_for('static', filename='images/avatars/' + pet.avatar) }}" alt="{{ pet.name }}" class="pet-avatar">
                <div class="pet-info">
                    <h3>{{ pet.name }}</h3>
                    <div class="pet-stats">
                        {{ pet.species }} | {{ pet.weight }}kg | {{ pet.age }} years old
                        {% if pet.breed %}
                        <br>{{ pet.breed }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Ëê•ÂÖªÈÖçÊØîÊñπÊ°àÈÄâÊã© -->
        <div class="nutrition-plan-section" id="nutritionPlanSection" style="display: none;">
            <h3 style="color: #510B0B; margin: 2rem 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-chart-pie"></i>
                Select Nutrition Plan
            </h3>
            <p style="color: #B82F0D; margin-bottom: 1.5rem;">
                Based on your pet's characteristics, we recommend the following nutrition plans. Click on a card to view detailed ratios.
            </p>
            
            <!-- ÈÖçÊØîÊñπÊ°àÂä†ËΩΩÁä∂ÊÄÅ -->
            <div class="nutrition-plans-loading" id="nutritionPlansLoading">
                <div class="loading">
                    <div class="spinner"></div>
                    <span style="margin-left: 1rem;">Loading nutrition plans...</span>
                </div>
            </div>
            
            <!-- ÈÖçÊØîÊñπÊ°àÁΩëÊ†º -->
            <div class="nutrition-plans-grid" id="nutritionPlansGrid" style="display: none;">
                <!-- Âä®ÊÄÅÁîüÊàêÁöÑÈÖçÊØîÊñπÊ°àÂç°Áâá -->
            </div>
        </div>
    </div>

    <!-- Ëê•ÂÖªÊñπÊ°àËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="planDetailModal" style="display: none;">
        <div class="modal-content plan-detail-modal">
            <div class="modal-header">
                <h3 id="planDetailTitle">Nutrition Plan Details</h3>
                <button class="modal-close" onclick="closePlanDetail()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="planDetailContent">
                <!-- Âä®ÊÄÅÁîüÊàêÁöÑÊñπÊ°àËØ¶ÊÉÖ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePlanDetail()">Cancel</button>
                <button class="btn btn-primary" id="selectPlanBtn" onclick="selectNutritionPlan()">Select This Plan</button>
            </div>
        </div>
    </div>

    <!-- Á¨¨‰∫åÊ≠•ÔºöÈÄâÊã©È£üÊùê -->
    <div class="step-content hidden" id="step2">
        <div class="step-title">
            <i class="fas fa-carrot"></i>
            Select Ingredients
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Select your desired ingredients from various categories. It is recommended to combine multiple types to ensure a balanced diet.</p>
        
        <!-- ÂàÜÁ±ªÊ†áÁ≠æ -->
        <div class="category-tabs" id="categoryTabs">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading ingredient categories...</span>
            </div>
        </div>

        <!-- È£üÊùêÁΩëÊ†º -->
        <div class="ingredients-grid" id="ingredientsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading ingredients...</span>
            </div>
        </div>

        <!-- Â∑≤ÈÄâÈ£üÊùêÊòæÁ§∫ -->
        <div class="selected-ingredients-panel">
            <h3>
                <i class="fas fa-check-circle"></i>
                Selected Ingredients
                <span class="selected-count" id="selectedCount">0</span>
            </h3>
            <div class="selected-list" id="selectedList">
                <div style="color: #666; font-style: italic;">No ingredients selected yet</div>
            </div>
        </div>
    </div>

    <!-- Á¨¨‰∏âÊ≠•ÔºöËÆæÁΩÆÈáçÈáè -->
    <div class="step-content hidden" id="step3">
        <div class="step-title">
            <i class="fas fa-weight"></i>
            Set Ingredient Weights
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Set the appropriate weight (in grams) for each ingredient. The system will calculate the nutritional content in real-time.</p>
        
        <!-- Ë°®Ê†º‰∏äÊñπÁöÑÊìç‰ΩúÂå∫Âüü -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; border: 1px solid #A1B4B2;">
            <div style="color: #510B0B;">
                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                <strong>Weight Distribution</strong>
                <small style="display: block; color: #B82F0D; margin-top: 0.3rem;">
                    You can manually set weights or use auto-distribution based on your selected nutrition plan
                </small>
            </div>
            <button type="button"
                    id="autoDistributeBtn"
                    class="nav-btn"
                    style="background: #5580AD; margin: 0; padding: 0.8rem 1.5rem; font-size: 0.9rem;"
                    onclick="autoDistributeWeights()"
                    disabled>
                <i class="fas fa-magic" style="margin-right: 0.5rem;"></i>
                Auto-Distribute Weights
            </button>
        </div>
        
        <table class="weight-table">
            <thead>
                <tr>
                    <th>Ingredient Name</th>
                    <th>Weight (g)</th>
                    <th>Calories (kcal)</th>
                    <th>Protein (g)</th>
                    <th>Fat (g)</th>
                    <th>Carbs (g)</th>
                </tr>
            </thead>
            <tbody id="weightTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; color: #666; font-style: italic;">Please select ingredients first</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Á¨¨ÂõõÊ≠•ÔºöËê•ÂÖªÂàÜÊûê -->
    <div class="step-content hidden" id="step4">
        <div class="step-title">
            <i class="fas fa-chart-bar"></i>
            Nutritional Analysis
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Review the detailed nutritional information of the recipe to ensure it meets your pet's needs.</p>
        
        <div id="nutritionAnalysis">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Analyzing nutritional content...</span>
            </div>
        </div>
    </div>

    <!-- Á¨¨‰∫îÊ≠•Ôºö‰øùÂ≠òÈ£üË∞± -->
    <div class="step-content hidden" id="step5">
        <div class="step-title">
            <i class="fas fa-save"></i>
            Save Recipe
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">Give your recipe a name and add a description.</p>
        
        <div style="max-width: 600px;">
            <div class="form-group">
                <label for="recipeName">Recipe Name *</label>
                <input type="text" id="recipeName" placeholder="e.g., Fluffy's Nutritional Feast" maxlength="50">
            </div>
            <div class="form-group">
                <label for="recipeDescription">Recipe Description</label>
                <textarea id="recipeDescription" rows="4" placeholder="Describe the features of this recipe, suitable occasions, etc..." maxlength="200"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="nav-btn" style="background: #A1B4B2;" onclick="saveRecipe(true)">
                    <i class="fas fa-edit"></i>
                    Save as Draft
                </button>
                <button class="nav-btn" style="background: #B82F0D;" onclick="saveRecipe(false)">
                    <i class="fas fa-check"></i>
                    Publish Recipe
                </button>
            </div>
        </div>
    </div>

    <!-- ÂØºËà™ÊåâÈíÆ -->
    <div class="navigation-buttons">
        <button class="nav-btn prev-btn" id="prevBtn" onclick="previousStep()" disabled>
            <i class="fas fa-chevron-left"></i>
            Previous Step
        </button>
        
        <div class="step-info">
            Step <span id="currentStepText">1</span> of 5
        </div>
        
        <button class="nav-btn next-btn" id="nextBtn" onclick="nextStep()" disabled>
            Next Step
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ÂÖ®Â±ÄÂèòÈáè
let currentStep = 1;
let selectedPetId = null;
let selectedIngredients = [];
let ingredientWeights = {};
let nutritionData = null;
let categories = [];
let allIngredients = [];
let selectedNutritionPlan = null;
let nutritionPlans = [];
let currentPlanDetail = null;

// È°µÈù¢ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // ‰∏∫ÊâÄÊúâÂÆ†Áâ©ÈÄâÈ°πÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.addEventListener('click', function(e) {
        const petOption = e.target.closest('.pet-option');
        if (petOption) {
            const petId = petOption.getAttribute('data-pet-id');
            selectPet(petId);
        }
    });
    
    loadCategories();
    updateStepVisibility();
    updateProgressBar();
    updatePrevButtonState();

    // Ê£ÄÊü•Âπ∂ÊÅ¢Â§ç‰πãÂâçÁöÑËøõÂ∫¶
    setTimeout(() => {
        checkAndRestoreProgress();
    }, 1000); // Âª∂Ëøü1ÁßíÊâßË°åÔºåÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩ
});

// ÈÄâÊã©ÂÆ†Áâ©
function selectPet(petId) {
    selectedPetId = petId;
    
    // Êõ¥Êñ∞UI
    document.querySelectorAll('.pet-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`[data-pet-id="${petId}"]`).classList.add('selected');
    
    // ÊòæÁ§∫Ëê•ÂÖªÈÖçÊØîÊñπÊ°àÈÄâÊã©
    showNutritionPlanSection(petId);
    
    showSuccessMessage('Pet selected, please choose a nutrition plan');
}

// ÊòæÁ§∫Ëê•ÂÖªÈÖçÊØîÊñπÊ°àÈÄâÊã©
async function showNutritionPlanSection(petId) {
    const section = document.getElementById('nutritionPlanSection');
    const loading = document.getElementById('nutritionPlansLoading');
    const grid = document.getElementById('nutritionPlansGrid');
    
    section.style.display = 'block';
    loading.style.display = 'block';
    grid.style.display = 'none';
    
    try {
        const response = await fetch(`/api/nutrition/plans?pet_id=${petId}`);
        if (!response.ok) {
            throw new Error('Failed to load nutrition plans');
        }
        
        const data = await response.json();
        nutritionPlans = data.plans;
        
        renderNutritionPlans();
        
        loading.style.display = 'none';
        grid.style.display = 'grid';
        
    } catch (error) {
        console.error('Failed to load nutrition plans:', error);
        loading.innerHTML = '<div style="color: #dc3545; text-align: center;">Failed to load nutrition plans, please try again</div>';
    }
}

// Ê∏≤ÊüìËê•ÂÖªÈÖçÊØîÊñπÊ°à
function renderNutritionPlans() {
    const grid = document.getElementById('nutritionPlansGrid');
    
    const cardsHtml = nutritionPlans.map(plan => {
        const highlights = plan.special_notes.slice(0, 2); // Âè™ÊòæÁ§∫Ââç2‰∏™ÁâπÁÇπ
        
        return `
            <div class="nutrition-plan-card ${plan.is_recommended ? 'recommended' : ''}" 
                data-plan-id="${plan.id}" onclick="showPlanDetail('${plan.id}')">
                <div class="plan-card-header">
                    <h4 class="plan-card-title">${plan.name}</h4>
                    <i class="fas fa-chart-pie plan-card-icon"></i>
                </div>
                <div class="plan-card-description">${plan.description}</div>
                <div class="plan-card-highlights">
                    ${highlights.map(note => `<span class="plan-highlight-tag">${note}</span>`).join('')}
                </div>
                <div style="margin-top: 1rem; text-align: center; color: #5580AD; font-size: 0.9rem;">
                    <i class="fas fa-eye"></i> Click to view detailed ratios
                </div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = cardsHtml;
}

// ÊòæÁ§∫ÈÖçÊØîÊñπÊ°àËØ¶ÊÉÖ
function showPlanDetail(planId) {
    const plan = nutritionPlans.find(p => p.id === planId);
    if (!plan) return;
    
    currentPlanDetail = plan;
    
    // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ
    document.getElementById('planDetailTitle').textContent = plan.name;
    
    const ratioItems = [
        { label: 'Red Meat', key: 'red_meat', color: '#dc3545' },
        { label: 'White Meat', key: 'white_meat', color: '#28a745' },
        { label: 'Fish', key: 'fish', color: '#007bff' },
        { label: 'Organs', key: 'organs', color: '#6f42c1' },
        { label: 'Vegetables', key: 'vegetables', color: '#20c997' },
        { label: 'Fruits', key: 'fruits', color: '#fd7e14' },
        { label: 'Grains', key: 'grains', color: '#6c757d' }
    ].filter(item => plan.category_ratios[item.key] > 0);
    
    const ratioChartHtml = ratioItems.map(item => {
        const percent = Math.round(plan.category_ratios[item.key] * 100);
        return `
            <div class="ratio-item">
                <div class="ratio-label">${item.label}</div>
                <div class="ratio-bar">
                    <div class="ratio-fill" style="width: ${percent}%; background: ${item.color};"></div>
                    <div class="ratio-percent">${percent}%</div>
                </div>
            </div>
        `;
    }).join('');
    
    const contentHtml = `
        <div>
            <h4 style="color: #510B0B; margin-bottom: 1rem;">Plan Description</h4>
            <p style="color: #666; line-height: 1.6;">${plan.description}</p>
        </div>
        
        <div>
            <h4 style="color: #510B0B; margin-bottom: 1rem;">Ingredient Ratios</h4>
            <div class="ratio-chart">
                ${ratioChartHtml}
            </div>
        </div>
        
        <div>
            <h4 style="color: #510B0B; margin-bottom: 1rem;">Special Features</h4>
            <ul style="color: #666; line-height: 1.6;">
                ${plan.special_notes.map(note => `<li>${note}</li>`).join('')}
            </ul>
        </div>
    `;
    
    document.getElementById('planDetailContent').innerHTML = contentHtml;
    document.getElementById('planDetailModal').style.display = 'flex';
}

// ÂÖ≥Èó≠ÈÖçÊØîÊñπÊ°àËØ¶ÊÉÖ
function closePlanDetail() {
    document.getElementById('planDetailModal').style.display = 'none';
    currentPlanDetail = null;
}

// ÈÄâÊã©Ëê•ÂÖªÈÖçÊØîÊñπÊ°à
function selectNutritionPlan() {
    if (!currentPlanDetail) return;
    
    selectedNutritionPlan = currentPlanDetail;
    
    // Êõ¥Êñ∞UI
    document.querySelectorAll('.nutrition-plan-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-plan-id="${currentPlanDetail.id}"]`).classList.add('selected');
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    closePlanDetail();

    // ÂêØÁî®‰∏ã‰∏ÄÊ≠•ÊåâÈíÆ
    updateNextButtonState();
    
    showSuccessMessage(`Selected "${currentPlanDetail.name}" nutrition plan`);
}

// Âä†ËΩΩÈ£üÊùêÂàÜÁ±ª
async function loadCategories() {
    try {
        const response = await fetch('/recipe/api/categories');
        if (!response.ok) {
            throw new Error('Failed to load categories');
        }
        
        categories = await response.json();
        
        const tabsContainer = document.getElementById('categoryTabs');
        tabsContainer.innerHTML = '';
        
        // Ê∑ªÂä†"ÂÖ®ÈÉ®"ÈÄâÈ°π
        const allTab = document.createElement('div');
        allTab.className = 'category-tab active';
        allTab.innerHTML = `
            <i class="fas fa-list"></i>
            All Ingredients
            <span class="category-count">${categories.reduce((sum, cat) => sum + cat.count, 0)}</span>
        `;
        allTab.onclick = () => selectCategory('all', allTab);
        tabsContainer.appendChild(allTab);
        
        // Ê∑ªÂä†ÂàÜÁ±ªÈÄâÈ°π
        categories.forEach(category => {
            const tab = document.createElement('div');
            tab.className = 'category-tab';
            tab.innerHTML = `
                <i class="${category.icon}"></i>
                ${category.name}
                <span class="category-count">${category.count}</span>
            `;
            tab.onclick = () => selectCategory(category.value, tab);
            tabsContainer.appendChild(tab);
        });
        
        // ÈªòËÆ§Âä†ËΩΩÂÖ®ÈÉ®È£üÊùê
        loadIngredients();
        
    } catch (error) {
        console.error('Failed to load categories:', error);
        showErrorMessage('Failed to load ingredient categories, please refresh the page and try again.');
    }
}

// ÈÄâÊã©ÂàÜÁ±ª
function selectCategory(categoryValue, tabElement) {
    // Êõ¥Êñ∞ÂàÜÁ±ªÊ†áÁ≠æÁä∂ÊÄÅ
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    tabElement.classList.add('active');
    
    // Âä†ËΩΩËØ•ÂàÜÁ±ªÁöÑÈ£üÊùê
    loadIngredients(categoryValue === 'all' ? null : categoryValue);
}

// Âä†ËΩΩÈ£üÊùê
async function loadIngredients(category = null) {
    try {
        const url = new URL('/recipe/api/ingredients', window.location.origin);
        if (category) {
            url.searchParams.append('category', category);
        }
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Failed to load ingredients');
        }
        
        const ingredients = await response.json();
        
        const gridContainer = document.getElementById('ingredientsGrid');
        gridContainer.innerHTML = '';
        
        if (ingredients.length === 0) {
            gridContainer.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1/-1; padding: 2rem;">No ingredients available in this category</div>';
            return;
        }
        
        ingredients.forEach(ingredient => {
            const card = document.createElement('div');
            card.className = 'ingredient-card';
            if (selectedIngredients.some(item => item.id === ingredient.id)) {
                card.classList.add('selected');
            }
            
            card.innerHTML = `
                ${ingredient.seasonality ? `<div class="ingredient-seasonality">${getSeasonalityText(ingredient.seasonality)}</div>` : ''}
                ${ingredient.is_common_allergen ? '<div class="allergen-warning">Allergen</div>' : ''}
                <div class="ingredient-image">
                    ${ingredient.image_filename ?
                        `<img src="/static/images/ingredients/${ingredient.image_filename}" alt="${ingredient.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        'No Image'
                    }
                </div>
                <div class="ingredient-name">${ingredient.name}</div>
                <div class="ingredient-nutrition">${ingredient.nutrition_summary}</div>
            `;
            
            card.onclick = () => toggleIngredient(ingredient);
            gridContainer.appendChild(card);
        });
        
    } catch (error) {
        console.error('Failed to load ingredients:', error);
        showErrorMessage('Failed to load ingredients, please check your network connection.');
    }
}

// ÂàáÊç¢È£üÊùêÈÄâÊã©Áä∂ÊÄÅ
function toggleIngredient(ingredient) {
    const existingIndex = selectedIngredients.findIndex(item => item.id === ingredient.id);
    
    if (existingIndex >= 0) {
        // ÂèñÊ∂àÈÄâÊã©
        selectedIngredients.splice(existingIndex, 1);
        delete ingredientWeights[ingredient.id];
        showSuccessMessage(`Removed ingredient: ${ingredient.name}`);
    } else {
        // Ê∑ªÂä†ÈÄâÊã©
        selectedIngredients.push(ingredient);
        showSuccessMessage(`Added ingredient: ${ingredient.name}`);
    }
    
    // Êõ¥Êñ∞UI
    updateSelectedIngredientsDisplay();
    updateIngredientsGridSelection();
    updateNextButtonState();
}

// Êõ¥Êñ∞Â∑≤ÈÄâÈ£üÊùêÊòæÁ§∫
function updateSelectedIngredientsDisplay() {
    const countEl = document.getElementById('selectedCount');
    const listEl = document.getElementById('selectedList');
    
    countEl.textContent = selectedIngredients.length;
    
    if (selectedIngredients.length === 0) {
        listEl.innerHTML = '<div style="color: #666; font-style: italic;">No ingredients selected yet</div>';
    } else {
        listEl.innerHTML = selectedIngredients.map(ingredient => `
            <div class="selected-tag">
                ${ingredient.name}
                <button class="remove-ingredient" onclick="removeIngredient(${ingredient.id})">√ó</button>
            </div>
        `).join('');
    }
}

// ÁßªÈô§È£üÊùê
function removeIngredient(ingredientId) {
    const ingredient = selectedIngredients.find(item => item.id === ingredientId);
    const index = selectedIngredients.findIndex(item => item.id === ingredientId);
    if (index >= 0) {
        selectedIngredients.splice(index, 1);
        delete ingredientWeights[ingredientId];
        updateSelectedIngredientsDisplay();
        updateIngredientsGridSelection();
        updateNextButtonState();
        
        if (ingredient) {
            showSuccessMessage(`Removed ingredient: ${ingredient.name}`);
        }
        
        // Â¶ÇÊûúÂú®ÈáçÈáèËÆæÁΩÆÊ≠•È™§ÔºåÊõ¥Êñ∞ÈáçÈáèË°®Ê†º
        if (currentStep === 3) {
            updateWeightTable();
        }
    }
}

// Êõ¥Êñ∞È£üÊùêÁΩëÊ†ºÈÄâÊã©Áä∂ÊÄÅ
function updateIngredientsGridSelection() {
    document.querySelectorAll('.ingredient-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    selectedIngredients.forEach(ingredient => {
        const cards = document.querySelectorAll('.ingredient-card');
        cards.forEach(card => {
            const nameEl = card.querySelector('.ingredient-name');
            if (nameEl && nameEl.textContent === ingredient.name) {
                card.classList.add('selected');
            }
        });
    });
}

// Ëé∑ÂèñÂ≠£ËäÇÊÄßÊñáÊú¨
function getSeasonalityText(seasonality) {
    const seasonMap = {
        'all_year': 'All Year',
        'spring': 'Spring',
        'summer': 'Summer',
        'autumn': 'Autumn',
        'winter': 'Winter',
        'spring,summer': 'Spring, Summer',
        'autumn,winter': 'Autumn, Winter'
    };
    return seasonMap[seasonality] || seasonality;
}

// Êõ¥Êñ∞ÈáçÈáèË°®Ê†º
function updateWeightTable() {
    const tbody = document.getElementById('weightTableBody');
    
    if (selectedIngredients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; font-style: italic;">Please select ingredients first</td></tr>';
        return;
    }
    
    tbody.innerHTML = selectedIngredients.map(ingredient => {
        const weight = ingredientWeights[ingredient.id] || 0;
        const calories = (ingredient.calories * weight / 100).toFixed(1);
        const protein = (ingredient.protein * weight / 100).toFixed(1);
        const fat = (ingredient.fat * weight / 100).toFixed(1);
        const carbs = (ingredient.carbohydrate * weight / 100).toFixed(1);
        
        return `
            <tr>
                <td><strong>${ingredient.name}</strong></td>
                <td>
                    <input type="number" class="weight-input"
                        value="${weight}"
                        min="0" max="1000" step="1"
                        onchange="updateIngredientWeight(${ingredient.id}, this.value)"
                        placeholder="0">
                </td>
                <td>${calories}</td>
                <td>${protein}</td>
                <td>${fat}</td>
                <td>${carbs}</td>
            </tr>
        `;
    }).join('');
}

// Êõ¥Êñ∞È£üÊùêÈáçÈáè
function updateIngredientWeight(ingredientId, weight) {
    const numWeight = parseFloat(weight) || 0;
    
    if (numWeight < 0) {
        showErrorMessage('Weight cannot be negative.');
        return;
    }
    
    if (numWeight > 1000) {
        showErrorMessage('Weight for a single ingredient cannot exceed 1000g.');
        return;
    }
    
    ingredientWeights[ingredientId] = numWeight;
    updateWeightTable(); // ÈáçÊñ∞ËÆ°ÁÆóËê•ÂÖªÊàêÂàÜ
    updateNextButtonState();
    
    if (numWeight > 0) {
        const ingredient = selectedIngredients.find(item => item.id === ingredientId);
        if (ingredient) {
            showSuccessMessage(`Set weight for ${ingredient.name}: ${numWeight}g`);
        }
    }
}

// Êõ¥Êñ∞‰∏ã‰∏ÄÊ≠•ÊåâÈíÆÁä∂ÊÄÅÔºåÂêåÊó∂ÊéßÂà∂Ëá™Âä®ÂàÜÈÖçÊåâÈíÆ
function updateNextButtonState() {
    const nextBtn = document.getElementById('nextBtn');
    const autoDistributeBtn = document.getElementById('autoDistributeBtn');
    
    if (currentStep === 1) {
        // Á¨¨‰∏ÄÊ≠•ÈúÄË¶ÅÈÄâÊã©ÂÆ†Áâ©ÂíåËê•ÂÖªÊñπÊ°à
        if (selectedPetId && selectedNutritionPlan) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
    } else if (currentStep === 2) {
        // Á¨¨‰∫åÊ≠•ÈúÄË¶ÅÈÄâÊã©È£üÊùê
        if (selectedIngredients.length > 0) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
    } else if (currentStep === 3) {
        // Á¨¨‰∏âÊ≠•ÈúÄË¶ÅËÆæÁΩÆÈáçÈáè
        const hasWeights = selectedIngredients.some(ing =>
            ingredientWeights[ing.id] && parseFloat(ingredientWeights[ing.id]) > 0
        );
        if (hasWeights) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
        // ÊéßÂà∂Ëá™Âä®ÂàÜÈÖçÊåâÈíÆÁä∂ÊÄÅ
        if (autoDistributeBtn) {
            if (selectedIngredients.length > 0 && selectedNutritionPlan) {
                autoDistributeBtn.disabled = false;
                autoDistributeBtn.style.opacity = '1';
            } else {
                autoDistributeBtn.disabled = true;
                autoDistributeBtn.style.opacity = '0.5';
            }
        }
    } else if (currentStep === 4) {
        // Á¨¨ÂõõÊ≠•ÈúÄË¶ÅÂÆåÊàêËê•ÂÖªÂàÜÊûê
        if (nutritionData) {
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        } else {
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';
        }
    } else {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1';
    }
}

// Ëá™Âä®ÂàÜÈÖçÈáçÈáèÂäüËÉΩÔºå‰ΩøÁî®ÈÄâÊã©ÁöÑËê•ÂÖªÊñπÊ°à
async function autoDistributeWeights() {
    if (!selectedNutritionPlan || selectedIngredients.length === 0) {
        showErrorMessage('Please select nutrition plan and ingredients first');
        return;
    }
    
    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    const btn = document.getElementById('autoDistributeBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
    btn.disabled = true;

    try {
        const response = await fetch('/api/nutrition/suggest-weights', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ingredient_ids: selectedIngredients.map(ing => ing.id),
                nutrition_plan_id: selectedNutritionPlan.id,
                pet_id: selectedPetId,
                total_weight: 200 // ÈªòËÆ§200g
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to get weight suggestions');
        }
        
        const data = await response.json();
        
        // Â∫îÁî®Êé®ËçêÈáçÈáè
        data.suggested_weights.forEach(item => {
            ingredientWeights[item.ingredient_id] = item.suggested_weight;
        });
        
        // Êõ¥Êñ∞ÈáçÈáèË°®Ê†º
        updateWeightTable();
        updateNextButtonState();
        
        showSuccessMessage(`Auto-distributed weights based on "${selectedNutritionPlan.name}" plan`);
        
    } catch (error) {
        console.error('Failed to get weight suggestions:', error);
        showErrorMessage('Failed to get weight suggestions, please set manually');
    } finally {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        btn.innerHTML = originalText;
        if (selectedIngredients.length > 0 && selectedNutritionPlan) {
            btn.disabled = false;
        }
    }
}

// ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
document.getElementById('planDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePlanDetail();
    }
});

// Êõ¥Êñ∞‰∏ä‰∏ÄÊ≠•ÊåâÈíÆÁä∂ÊÄÅ
function updatePrevButtonState() {
    const prevBtn = document.getElementById('prevBtn');
    prevBtn.disabled = currentStep === 1;
}

// Ê≠•È™§ÂØºËà™
function nextStep() {
    if (currentStep < 5) {
        currentStep++;
        updateStepVisibility();
        updateProgressBar();
        
        // ÁâπÊÆäÂ§ÑÁêÜ
        if (currentStep === 3) {
            updateWeightTable();
        } else if (currentStep === 4) {
            // Ëá™Âä®ËÆ°ÁÆóËê•ÂÖªÊàêÂàÜ
            calculateNutrition();
        }
        
        updateNextButtonState();
        updatePrevButtonState();
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepVisibility();
        updateProgressBar();
        updateNextButtonState();
        updatePrevButtonState();
    }
}

// Êõ¥Êñ∞Ê≠•È™§ÂèØËßÅÊÄß
function updateStepVisibility() {
    for (let i = 1; i <= 5; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i === currentStep) {
            stepEl.classList.remove('hidden');
        } else {
            stepEl.classList.add('hidden');
        }
    }
    
    document.getElementById('currentStepText').textContent = currentStep;
    
    // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆ
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 5) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'block';
    }
}

// Êõ¥Êñ∞ËøõÂ∫¶Êù°
function updateProgressBar() {
    const progressPercentage = (currentStep / 5) * 100;
    document.getElementById('progressLineActive').style.width = `${progressPercentage}%`;
    
    // Êõ¥Êñ∞Ê≠•È™§ÂúÜÁÇπÁä∂ÊÄÅ
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
}

// ------- Êñ∞Â¢ûÔºöËÆ°ÁÆóËê•ÂÖªÊàêÂàÜÂáΩÊï∞ -------
async function calculateNutrition() {
    if (!selectedPetId) {
        showErrorMessage('Please select a pet first');
        return;
    }
    
    if (selectedIngredients.length === 0) {
        showErrorMessage('Please select ingredients first');
        return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÈ£üÊùêÈÉΩÊúâÈáçÈáè
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,  // ‰øùÊåÅÂéüÊúâÂ≠óÊÆµÂêç
        weight: parseFloat(ingredientWeights[ingredient.id] || 0)
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('Please set ingredient weights');
        return;
    }
    
    console.log('ÂèëÈÄÅËê•ÂÖªËÆ°ÁÆóËØ∑Ê±Ç:', {
        ingredients: ingredientsWithWeights,
        pet_id: selectedPetId
    });
    
    try {
        // ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑAPIË∑ØÂæÑ
        const response = await fetch('/api/nutrition/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ingredients: ingredientsWithWeights,
                pet_id: selectedPetId
            })
        });
        
        console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('APIÈîôËØØ:', errorData);
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        nutritionData = await response.json();
        console.log('Ëê•ÂÖªËÆ°ÁÆóÁªìÊûú:', nutritionData);
        
        if (nutritionData.error) {
            throw new Error(nutritionData.error);
        }
        
        // ÊòæÁ§∫Ëê•ÂÖªÂàÜÊûêÁªìÊûú
        displayNutritionAnalysis(nutritionData);
        updateNextButtonState();
        
    } catch (error) {
        console.error('Ëê•ÂÖªËÆ°ÁÆóÂ§±Ë¥•:', error);
        showErrorMessage(`Ëê•ÂÖªËÆ°ÁÆóÂ§±Ë¥•: ${error.message}`);
    }
}

// ------- Êñ∞Â¢ûÔºöÊòæÁ§∫Ëê•ÂÖªÂàÜÊûêÁªìÊûúÂáΩÊï∞ -------
function displayNutritionAnalysis(data) {
    const container = document.getElementById('nutritionAnalysis');
    
    // Ëê•ÂÖªÁä∂ÊÄÅÈ¢úËâ≤Êò†Â∞Ñ
    const statusColors = {
        'excellent': '#28a745',
        'good': '#17a2b8',
        'calculated': '#ffc107',
        'needs_improvement': '#dc3545',
        'insufficient_data': '#6c757d'
    };
    
    const statusTexts = {
        'excellent': '‰ºòÁßÄ',
        'good': 'ËâØÂ•Ω',
        'calculated': 'Â∑≤ËÆ°ÁÆó',
        'needs_improvement': 'ÈúÄË¶ÅÊîπÂñÑ',
        'insufficient_data': 'Êï∞ÊçÆ‰∏çË∂≥'
    };

    const analysis = data.nutrition_analysis || {};
    const statusColor = statusColors[analysis.status] || '#6c757d';
    const statusText = statusTexts[analysis.status] || 'Êú™Áü•';

    // ËÆ°ÁÆóÈíôÁ£∑ÊØî
    let calciumPhosphorusRatio = 0;
    let calciumPhosphorusStatus = 'unknown';
    let calciumPhosphorusNote = '';
    
    if (data.total_nutrition.calcium > 0 && data.total_nutrition.phosphorus > 0) {
        calciumPhosphorusRatio = data.total_nutrition.calcium / data.total_nutrition.phosphorus;
        
        // ËØÑ‰º∞ÈíôÁ£∑ÊØîÁä∂ÊÄÅÔºàÁêÜÊÉ≥ËåÉÂõ¥ 1.0-2.0Ôºâ
        if (calciumPhosphorusRatio >= 1.0 && calciumPhosphorusRatio <= 2.0) {
            calciumPhosphorusStatus = 'excellent';
            calciumPhosphorusNote = 'ÁêÜÊÉ≥ËåÉÂõ¥';
        } else if (calciumPhosphorusRatio >= 0.8 && calciumPhosphorusRatio < 1.0) {
            calciumPhosphorusStatus = 'warning';
            calciumPhosphorusNote = 'Áï•‰ΩéÔºåÂª∫ËÆÆÂ¢ûÂä†Âê´ÈíôÈ£üÊùê';
        } else if (calciumPhosphorusRatio > 2.0 && calciumPhosphorusRatio <= 2.5) {
            calciumPhosphorusStatus = 'warning';
            calciumPhosphorusNote = 'Áï•È´òÔºåÂª∫ËÆÆÂπ≥Ë°°ÈíôÁ£∑ÊëÑÂÖ•';
        } else if (calciumPhosphorusRatio < 0.8) {
            calciumPhosphorusStatus = 'danger';
            calciumPhosphorusNote = 'ÂÅè‰ΩéÔºåÈúÄË¶ÅÂ¢ûÂä†ÈíôË¥®';
        } else {
            calciumPhosphorusStatus = 'danger';
            calciumPhosphorusNote = 'ÂÅèÈ´òÔºåÂª∫ËÆÆÂáèÂ∞ëÈíôË¥®ÊàñÂ¢ûÂä†Á£∑';
        }
    } else {
        calciumPhosphorusNote = 'Êï∞ÊçÆ‰∏çË∂≥';
    }

    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
            <!-- Âü∫Á°ÄËê•ÂÖª‰ø°ÊÅØ -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-info-circle"></i>
                    Âü∫Á°ÄËê•ÂÖª‰ø°ÊÅØ
                </h4>
                <div style="display: grid; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>ÊÄªÈáçÈáè:</span>
                        <strong style="color: #5580AD;">${data.total_nutrition.total_weight.toFixed(1)} g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ÊÄªÁÉ≠Èáè:</span>
                        <strong style="color: #B82F0D;">${data.total_nutrition.calories.toFixed(1)} kcal</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ËõãÁôΩË¥®:</span>
                        <strong style="color: #28a745;">${data.total_nutrition.protein.toFixed(1)} g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ËÑÇËÇ™:</span>
                        <strong style="color: #fd7e14;">${data.total_nutrition.fat.toFixed(1)} g</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Á¢≥Ê∞¥ÂåñÂêàÁâ©:</span>
                        <strong style="color: #20c997;">${data.total_nutrition.carbohydrate.toFixed(1)} g</strong>
                    </div>
                </div>
            </div>
            
            <!-- Ëê•ÂÖªÊØî‰æã -->
            <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-pie"></i>
                    Ëê•ÂÖªÊØî‰æã
                </h4>
                <div style="display: grid; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>ËõãÁôΩË¥®ÊØî‰æã:</span>
                        <strong style="color: #28a745;">${data.nutrition_ratios.protein_percent || 0}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ËÑÇËÇ™ÊØî‰æã:</span>
                        <strong style="color: #fd7e14;">${data.nutrition_ratios.fat_percent || 0}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Á¢≥Ê∞¥ÊØî‰æã:</span>
                        <strong style="color: #20c997;">${data.nutrition_ratios.carbohydrate_percent || 0}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ÁÉ≠ÈáèÂØÜÂ∫¶:</span>
                        <strong style="color: #5580AD;">${data.nutrition_ratios.calories_per_100g || 0} kcal/100g</strong>
                    </div>
                    <!-- Êñ∞Â¢ûÔºöÈíôÁ£∑ÊØîÊòæÁ§∫ -->
                    <div style="border-top: 1px solid #eee; padding-top: 0.75rem; margin-top: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                ÈíôÁ£∑ÊØî:
                                <i class="fas fa-info-circle"
                                    style="color: #666; font-size: 0.8rem; cursor: help;" 
                                    title="ÁêÜÊÉ≥ÈíôÁ£∑ÊØî‰∏∫ 1.0-2.0:1ÔºåÂØπÈ™®È™ºÂÅ•Â∫∑ÂæàÈáçË¶Å"></i>
                            </span>
                            <div style="text-align: right;">
                                <strong style="color: ${statusColors[calciumPhosphorusStatus] || '#6c757d'};">
                                    ${calciumPhosphorusRatio > 0 ? calciumPhosphorusRatio.toFixed(2) + ':1' : 'Êó†Êï∞ÊçÆ'}
                                </strong>
                                ${calciumPhosphorusNote ? `<br><small style="color: ${statusColors[calciumPhosphorusStatus] || '#6c757d'}; font-size: 0.8rem;">${calciumPhosphorusNote}</small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ëê•ÂÖªËØÑ‰º∞ -->
        <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid ${statusColor}; margin-bottom: 2rem;">
            <h4 style="color: ${statusColor}; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-clipboard-check"></i>
                Ëê•ÂÖªËØÑ‰º∞ - ${statusText}
                ${analysis.score ? `<span style="font-size: 0.9rem; background: ${statusColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 8px;">${analysis.score}ÂàÜ</span>` : ''}
            </h4>
            
            ${analysis.recommendations && analysis.recommendations.length > 0 ? `
                <div style="margin-bottom: 1rem;">
                    <strong style="color: #28a745;">‚úì Êé®Ëçê:</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #28a745;">
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            ${analysis.warnings && analysis.warnings.length > 0 ? `
                <div>
                    <strong style="color: #dc3545;">‚ö† Ê≥®ÊÑè‰∫ãÈ°π:</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #dc3545;">
                        ${analysis.warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}

            <!-- Â¶ÇÊûúÈíôÁ£∑ÊØîÊúâÈóÆÈ¢òÔºåÊ∑ªÂä†Âà∞Âª∫ËÆÆ‰∏≠ -->
            ${calciumPhosphorusStatus === 'warning' || calciumPhosphorusStatus === 'danger' ? `
                <div style="margin-top: 1rem; padding: 0.75rem; background: ${calciumPhosphorusStatus === 'danger' ? '#fff5f5' : '#fffaf0'}; border-radius: 8px; border: 1px solid ${statusColors[calciumPhosphorusStatus]};">
                    <strong style="color: ${statusColors[calciumPhosphorusStatus]};">
                        <i class="fas fa-balance-scale"></i> ÈíôÁ£∑ÊØîÂª∫ËÆÆ:
                    </strong>
                    <p style="margin: 0.5rem 0 0 0; color: ${statusColors[calciumPhosphorusStatus]}; font-size: 0.9rem;">
                        ${calciumPhosphorusNote}„ÄÇÈíôÁ£∑ÊØîÂØπÂÆ†Áâ©È™®È™ºÂíåÁâôÈΩøÂÅ•Â∫∑Ëá≥ÂÖ≥ÈáçË¶Å„ÄÇ
                    </p>
                </div>
            ` : ''}
        </div>
        
        <!-- È£üÊùêËØ¶ÊÉÖË°®Ê†º -->
        <div style="background: white; padding: 1.5rem; border-radius: 15px; border: 2px solid #A1B4B2;">
            <h4 style="color: #510B0B; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-table"></i>
                È£üÊùêËê•ÂÖªË¥°ÁåÆ
            </h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">È£üÊùê</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">ÈáçÈáè(g)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">ÊØî‰æã(%)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">ÁÉ≠Èáè(kcal)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">ËõãÁôΩË¥®(g)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">Èíô(mg)</th>
                            <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid #dee2e6;">Á£∑(mg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.ingredient_details.map(detail => `
                            <tr>
                                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">${detail.name}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.weight}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.percentage}%</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.calories.toFixed(1)}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.protein.toFixed(1)}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.calcium ? detail.contribution.calcium.toFixed(1) : '0.0'}</td>
                                <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid #dee2e6;">${detail.contribution.phosphorus ? detail.contribution.phosphorus.toFixed(1) : '0.0'}</td>
                            </tr>
                        `).join('')}
                        <!-- Ê∑ªÂä†ÊÄªËÆ°Ë°å -->
                        <tr style="background: #f8f9fa; font-weight: bold;">
                            <td style="padding: 0.75rem; border-top: 2px solid #dee2e6;">ÊÄªËÆ°</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">${data.total_nutrition.total_weight.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">100%</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">${data.total_nutrition.calories.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6;">${data.total_nutrition.protein.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6; color: #5580AD;">${data.total_nutrition.calcium.toFixed(1)}</td>
                            <td style="padding: 0.75rem; text-align: right; border-top: 2px solid #dee2e6; color: #5580AD;">${data.total_nutrition.phosphorus.toFixed(1)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ------------Êñ∞Â¢ûÔºöÊé®ËçêÂäüËÉΩÂÖ•Âè£------------ -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 2rem; border-radius: 15px; border: 2px solid #A1B4B2; margin-top: 2rem;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h4 style="color: #510B0B; margin-bottom: 0.5rem;">
                    <i class="fas fa-lightbulb" style="color: #5580AD;"></i>
                    ÊÉ≥Ë¶ÅÊõ¥Â§öÁÅµÊÑüÔºü
                </h4>
                <p style="color: #666; margin: 0; line-height: 1.5;">
                    Âü∫‰∫éÊÇ®ÈÄâÊã©ÁöÑÈ£üÊùêÔºåÊàë‰ª¨ÂèØ‰ª•‰∏∫ÊÇ®Êé®ËçêÁ§æÂå∫‰∏≠ÁöÑÁõ∏‰ººÈ£üË∞±Ôºå<br>
                    Â∏ÆÂä©ÊÇ®ÂèëÁé∞Êõ¥Â§öËê•ÂÖªÊê≠ÈÖçÁöÑÂèØËÉΩÊÄßÔºÅ
                </p>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                <button type="button" 
                        class="recommendation-action-btn primary" 
                        onclick="goToRecommendations()" 
                        style="background: #5580AD; color: white; border: none; border-radius: 25px; padding: 1rem 2rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(85, 128, 173, 0.3);">
                    <i class="fas fa-magic"></i>
                    Get Recipe Recommendations
                </button>
                
                <button type="button" 
                        class="recommendation-action-btn secondary" 
                        onclick="showRecommendationHelp()" 
                        style="background: transparent; color: #5580AD; border: 2px solid #5580AD; border-radius: 25px; padding: 1rem 2rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-question-circle"></i>
                    How It Works
                </button>
            </div>
            
            <div style="margin-top: 1.5rem; text-align: center;">
                <small style="color: #666; font-style: italic;">
                    <i class="fas fa-info-circle" style="margin-right: 0.3rem;"></i>
                    Don't worry - your current recipe progress will be saved and you can return anytime!
                </small>
            </div>
        </div>
        
        <!-- ÊàêÂäüÊèêÁ§∫ -->
        <div style="margin-top: 2rem; padding: 1rem; background: #d4edda; border-radius: 10px; border-left: 4px solid #28a745;">
            <p style="color: #155724; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-check-circle"></i>
                Ëê•ÂÖªËÆ°ÁÆóÂÆåÊàêÔºÅÊÇ®ÂèØ‰ª•ÁªßÁª≠Âà∞‰∏ã‰∏ÄÊ≠•‰øùÂ≠òÈ£üË∞±„ÄÇ
            </p>
        </div>
    `;

    // ------------Êñ∞Â¢ûÔºö‰∏∫Êé®ËçêÊåâÈíÆÊ∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú------------
    addRecommendationButtonEffects();
}

// ------------Êñ∞Â¢ûÔºöÊ∑ªÂä†Êé®ËçêÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú------------
function addRecommendationButtonEffects() {
    const primaryBtn = document.querySelector('.recommendation-action-btn.primary');
    const secondaryBtn = document.querySelector('.recommendation-action-btn.secondary');
    
    if (primaryBtn) {
        primaryBtn.addEventListener('mouseenter', function() {
            this.style.background = '#4a73a0';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 6px 20px rgba(85, 128, 173, 0.4)';
        });
        
        primaryBtn.addEventListener('mouseleave', function() {
            this.style.background = '#5580AD';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 12px rgba(85, 128, 173, 0.3)';
        });
    }
    
    if (secondaryBtn) {
        secondaryBtn.addEventListener('mouseenter', function() {
            this.style.background = '#5580AD';
            this.style.color = 'white';
            this.style.transform = 'translateY(-2px)';
        });
        
        secondaryBtn.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
            this.style.color = '#5580AD';
            this.style.transform = 'translateY(0)';
        });
    }
}

// ------------Êñ∞Â¢ûÔºöË∑≥ËΩ¨Âà∞Êé®ËçêÈ°µÈù¢ÂáΩÊï∞------------
function goToRecommendations() {
    // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑÈ£üÊùêID
    const ingredientIds = selectedIngredients.map(ing => ing.id);
    
    if (ingredientIds.length === 0) {
        showErrorMessage('Êé®ËçêÂ§±Ë¥•', 'ËØ∑ÂÖàÈÄâÊã©È£üÊùê');
        return;
    }
    
    // ‰øùÂ≠òÂΩìÂâçËøõÂ∫¶Âà∞sessionStorageÔºà‰ª•‰æøÁî®Êà∑ËøîÂõûÊó∂ÊÅ¢Â§çÔºâ
    const recipeProgress = {
        step: currentStep,
        selectedPetId: selectedPetId,
        selectedNutritionPlan: selectedNutritionPlan,
        selectedIngredients: selectedIngredients,
        ingredientWeights: ingredientWeights,
        nutritionData: nutritionData,
        timestamp: Date.now()
    };
    
    try {
        sessionStorage.setItem('recipeCreateProgress', JSON.stringify(recipeProgress));
        console.log('Recipe progress saved:', recipeProgress);
    } catch (error) {
        console.warn('Failed to save recipe progress:', error);
    }
    
    // ÊûÑÂª∫Êé®ËçêÈ°µÈù¢URL
    const params = new URLSearchParams({
        ingredients: ingredientIds.join(','),
        from: 'create_recipe',
        pet_id: selectedPetId || ''
    });
    
    // ÊòæÁ§∫Ë∑≥ËΩ¨ÊèêÁ§∫
    showSuccessMessage(
        'Redirecting to recommendations...', 
        'Your recipe progress has been saved and you can return anytime!'
    );
    
    // Âª∂ËøüË∑≥ËΩ¨‰ª•ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
    setTimeout(() => {
        window.location.href = `/recipe/recommendations?${params.toString()}`;
    }, 1500);
}

// ------------Êñ∞Â¢ûÔºöÊòæÁ§∫Êé®ËçêÂäüËÉΩËØ¥Êòé------------
function showRecommendationHelp() {
    const helpModal = document.createElement('div');
    helpModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    helpModal.innerHTML = `
        <div style="background: white; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 2rem; position: relative;">
            <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">√ó</button>
            
            <div style="text-align: center; margin-bottom: 2rem;">
                <h3 style="color: #510B0B; margin-bottom: 0.5rem;">
                    <i class="fas fa-lightbulb" style="color: #5580AD; margin-right: 0.5rem;"></i>
                    Recipe Recommendations
                </h3>
                <p style="color: #666; margin: 0;">Discover similar recipes from our community</p>
            </div>
            
            <div style="display: grid; gap: 1.5rem;">
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <div style="background: #5580AD; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                    <div>
                        <h6 style="color: #510B0B; margin-bottom: 0.5rem;">Intelligent Matching</h6>
                        <p style="color: #666; margin: 0; line-height: 1.5;">Our AI analyzes your selected ingredients and finds recipes with similar nutritional profiles and ingredient combinations.</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <div style="background: #B82F0D; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                    <div>
                        <h6 style="color: #510B0B; margin-bottom: 0.5rem;">Personalized for Your Pet</h6>
                        <p style="color: #666; margin: 0; line-height: 1.5;">Recommendations are tailored based on your pet's species, age, and special dietary needs.</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <div style="background: #28a745; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                    <div>
                        <h6 style="color: #510B0B; margin-bottom: 0.5rem;">Community-Proven</h6>
                        <p style="color: #666; margin: 0; line-height: 1.5;">All recommendations come from recipes created and tested by fellow pet owners in our community.</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <div style="background: #A1B4B2; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                    <div>
                        <h6 style="color: #510B0B; margin-bottom: 0.5rem;">Easy to Use</h6>
                        <p style="color: #666; margin: 0; line-height: 1.5;">You can view recipe details, copy them to your account, or return to continue creating your original recipe.</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; text-align: center;">
                <p style="color: #666; margin: 0; font-style: italic;">
                    <i class="fas fa-shield-alt" style="color: #28a745; margin-right: 0.5rem;"></i>
                    Your current recipe progress is automatically saved and you can return anytime!
                </p>
            </div>
        </div>
    `;
    
    document.body.appendChild(helpModal);
    
    // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
    helpModal.addEventListener('click', function(e) {
        if (e.target === helpModal) {
            helpModal.remove();
        }
    });
}

// ------------Êñ∞Â¢ûÔºöÈ°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§ç‰πãÂâçÁöÑËøõÂ∫¶------------
function checkAndRestoreProgress() {
    try {
        const savedProgress = sessionStorage.getItem('recipeCreateProgress');
        if (savedProgress) {
            const progress = JSON.parse(savedProgress);
            
            // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ËøáÊúüÔºà24Â∞èÊó∂Ôºâ
            const isExpired = (Date.now() - progress.timestamp) > 24 * 60 * 60 * 1000;
            
            if (!isExpired && progress.selectedIngredients && progress.selectedIngredients.length > 0) {
                // ÊòæÁ§∫ÊÅ¢Â§çËøõÂ∫¶ÁöÑÊèêÁ§∫
                showRestoreProgressPrompt(progress);
            } else if (isExpired) {
                // Ê∏ÖÈô§ËøáÊúüÊï∞ÊçÆ
                sessionStorage.removeItem('recipeCreateProgress');
            }
        }
    } catch (error) {
        console.warn('Failed to restore progress:', error);
        sessionStorage.removeItem('recipeCreateProgress');
    }
}

// ------------Êñ∞Â¢ûÔºöÊòæÁ§∫ÊÅ¢Â§çËøõÂ∫¶ÊèêÁ§∫------------
function showRestoreProgressPrompt(progress) {
    const promptModal = document.createElement('div');
    promptModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    promptModal.innerHTML = `
        <div style="background: white; border-radius: 15px; max-width: 500px; width: 90%; padding: 2rem; text-align: center;">
            <div style="margin-bottom: 1.5rem;">
                <i class="fas fa-history" style="font-size: 3rem; color: #5580AD; margin-bottom: 1rem;"></i>
                <h4 style="color: #510B0B; margin-bottom: 0.5rem;">Welcome Back!</h4>
                <p style="color: #666; margin: 0;">We found your previous recipe creation progress. Would you like to continue where you left off?</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                <small style="color: #666;">
                    <strong>Saved progress:</strong> ${progress.selectedIngredients.length} ingredients selected
                    ${progress.selectedPetId ? '‚Ä¢ Pet selected' : ''}
                    ${progress.nutritionData ? '‚Ä¢ Nutrition analyzed' : ''}
                </small>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="restoreProgress(); this.parentElement.parentElement.parentElement.remove();" style="background: #5580AD; color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-play" style="margin-right: 0.5rem;"></i>
                    Continue Previous Recipe
                </button>
                <button onclick="clearProgress(); this.parentElement.parentElement.parentElement.remove();" style="background: #A1B4B2; color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer;">
                    <i class="fas fa-plus" style="margin-right: 0.5rem;"></i>
                    Start New Recipe
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(promptModal);
}

// ------------Êñ∞Â¢ûÔºöÊÅ¢Â§çËøõÂ∫¶ÂáΩÊï∞------------
function restoreProgress() {
    try {
        const savedProgress = JSON.parse(sessionStorage.getItem('recipeCreateProgress'));
        
        if (savedProgress) {
            // ÊÅ¢Â§çÂÖ®Â±ÄÂèòÈáè
            selectedPetId = savedProgress.selectedPetId;
            selectedNutritionPlan = savedProgress.selectedNutritionPlan;
            selectedIngredients = savedProgress.selectedIngredients || [];
            ingredientWeights = savedProgress.ingredientWeights || {};
            nutritionData = savedProgress.nutritionData;
            
            // ÊÅ¢Â§çÂà∞ÂØπÂ∫îÊ≠•È™§
            currentStep = Math.max(savedProgress.step || 1, 1);
            
            // Êõ¥Êñ∞UI
            updateStepVisibility();
            updateProgressBar();
            updatePrevButtonState();
            updateNextButtonState();
            
            // ÊÅ¢Â§çÂÆ†Áâ©ÈÄâÊã©UI
            if (selectedPetId) {
                document.querySelectorAll('.pet-option').forEach(option => {
                    option.classList.remove('selected');
                });
                const petOption = document.querySelector(`[data-pet-id="${selectedPetId}"]`);
                if (petOption) {
                    petOption.classList.add('selected');
                }
            }
            
            // ÊÅ¢Â§çËê•ÂÖªÊñπÊ°àUI
            if (selectedNutritionPlan && selectedPetId) {
                showNutritionPlanSection(selectedPetId);
            }
            
            // Â¶ÇÊûúÂú®Ê≠•È™§3Êàñ4ÔºåÊÅ¢Â§çÁõ∏ÂÖ≥UI
            if (currentStep >= 3) {
                updateWeightTable();
            }
            
            if (currentStep >= 4 && nutritionData) {
                displayNutritionAnalysis(nutritionData);
            }
            
            showSuccessMessage('Progress restored!', 'Welcome back! Your recipe creation progress has been restored.');
        }
    } catch (error) {
        console.error('Failed to restore progress:', error);
        clearProgress();
    }
}

// ------------Êñ∞Â¢ûÔºöÊ∏ÖÈô§ËøõÂ∫¶ÂáΩÊï∞------------
function clearProgress() {
    sessionStorage.removeItem('recipeCreateProgress');
    showSuccessMessage('Starting fresh!', 'Ready to create a new recipe from scratch.');
}

// ------- Êñ∞Â¢ûÔºö‰øùÂ≠òÈ£üË∞±ÂáΩÊï∞ -------
async function saveRecipe(isDraft) {
    const recipeName = document.getElementById('recipeName').value.trim();
    const recipeDescription = document.getElementById('recipeDescription').value.trim();
    
    if (!recipeName) {
        showErrorMessage('Please enter a recipe name.');
        return;
    }
    
    if (!selectedPetId || selectedIngredients.length === 0 || !nutritionData) {
        showErrorMessage('Please complete all previous steps.');
        return;
    }
    
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,
        weight: parseFloat(ingredientWeights[ingredient.id] || 0)
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('Please set the ingredient weights.');
        return;
    }
    
    try {
        const response = await fetch('/api/recipe/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: recipeName,
                description: recipeDescription,
                pet_id: selectedPetId,
                ingredients: ingredientsWithWeights,
                nutrition_plan_id: selectedNutritionPlan ? selectedNutritionPlan.id : null,
                is_draft: isDraft,
                is_public: !isDraft
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showErrorMessage(data.error);
            return;
        }
        
        showSuccessMessage(data.message);
        
        // Ë∑≥ËΩ¨Âà∞Áî®Êà∑‰∏≠ÂøÉÊàñÈ£üË∞±ËØ¶ÊÉÖÈ°µ
        setTimeout(() => {
            window.location.href = '/user_center';
        }, 2000);
        
    } catch (error) {
        console.error('Failed to save recipe:', error);
        showErrorMessage('Failed to save recipe, please check your network connection.');
    }
}

// ------- Êñ∞Â¢ûÔºöÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØÂáΩÊï∞ -------
function showSuccessMessage(message) {
    // ÁßªÈô§Áé∞ÊúâÊ∂àÊÅØ
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // ÂàõÂª∫Êñ∞Ê∂àÊÅØ
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 3ÁßíÂêéËá™Âä®ÈöêËóè
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 3000);
}

// ------- Êñ∞Â¢ûÔºöÊòæÁ§∫ÈîôËØØÊ∂àÊÅØÂáΩÊï∞ -------
function showErrorMessage(message) {
    // ÁßªÈô§Áé∞ÊúâÊ∂àÊÅØ
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // ÂàõÂª∫Êñ∞Ê∂àÊÅØ
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show type-warning';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 5ÁßíÂêéËá™Âä®ÈöêËóè
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 5000);
}

// ------- Êñ∞Â¢ûÔºöÈîÆÁõòÂø´Êç∑ÈîÆÊîØÊåÅ -------
document.addEventListener('keydown', function(e) {
    if (e.altKey) {
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (currentStep > 1) previousStep();
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (currentStep < 5 && !document.getElementById('nextBtn').disabled) nextStep();
                break;
        }
    }
});

// ------- Êñ∞Â¢ûÔºöÈ°µÈù¢Á¶ªÂºÄÊèêÈÜí -------
window.addEventListener('beforeunload', function(e) {
    if (selectedIngredients.length > 0 || selectedPetId) {
        e.preventDefault();
        e.returnValue = 'You have unsaved recipe data. Are you sure you want to leave?';
    }
});
</script>

{% endblock %}