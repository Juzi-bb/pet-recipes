{% extends "base.html" %}

{% block title %}åˆ›å»ºé£Ÿè°± - Pet Recipe Website{% endblock %}

{% block content %}
<style>
    .create-recipe-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        color: white;
        border-radius: 15px;
    }

    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    /* æ­¥éª¤è¿›åº¦æ¡ */
    .progress-container {
        margin-bottom: 3rem;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 2rem;
    }

    .progress-line {
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 3px;
        background: #EDBF9D;
        z-index: 1;
    }

    .progress-line-active {
        height: 3px;
        background: #5580AD;
        transition: width 0.3s ease;
        z-index: 2;
        position: absolute;
        top: 0;
        left: 0;
    }

    .progress-step {
        background: white;
        border: 3px solid #EDBF9D;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #B82F0D;
        position: relative;
        z-index: 3;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .progress-step.completed {
        background: #EDBF9D;
        border-color: #EDBF9D;
        color: #510B0B;
    }

    .step-label {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.9rem;
        color: #510B0B;
        font-weight: 500;
    }

    /* æ­¥éª¤å†…å®¹ */
    .step-content {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 2px solid #A1B4B2;
        margin-bottom: 2rem;
    }

    .step-content.hidden {
        display: none;
    }

    .step-title {
        font-size: 1.8rem;
        color: #510B0B;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å® ç‰© */
    .pet-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .pet-option {
        border: 2px solid #A1B4B2;
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .pet-option:hover {
        border-color: #5580AD;
        transform: translateY(-2px);
    }

    .pet-option.selected {
        border-color: #510B0B;
        background: linear-gradient(135deg, #EDBF9D 0%, #A1B4B2 30%);
    }

    .pet-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto 1rem;
        border: 3px solid #EDBF9D;
    }

    .pet-info h3 {
        color: #510B0B;
        margin-bottom: 0.5rem;
    }

    .pet-stats {
        font-size: 0.9rem;
        color: #B82F0D;
    }

    /* ç¬¬äºŒæ­¥ï¼šé£Ÿæåˆ†ç±» */
    .category-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #EDBF9D;
        padding-bottom: 1rem;
    }

    .category-tab {
        padding: 0.8rem 1.5rem;
        border: 2px solid #A1B4B2;
        background: white;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }

    .category-tab:hover {
        border-color: #5580AD;
        background: #f8f9fa;
    }

    .category-tab.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .category-count {
        background: rgba(255,255,255,0.3);
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }

    /* é£Ÿæç½‘æ ¼ */
    .ingredients-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        max-height: 500px;
        overflow-y: auto;
        padding: 1rem;
        border: 1px solid #EDBF9D;
        border-radius: 10px;
    }

    .ingredient-card {
        border: 2px solid #A1B4B2;
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        background: white;
    }

    .ingredient-card:hover {
        border-color: #5580AD;
        transform: translateY(-2px);
    }

    .ingredient-card.selected {
        border-color: #510B0B;
        background: linear-gradient(135deg, #EDBF9D 0%, rgba(161, 180, 178, 0.3) 100%);
    }

    .ingredient-image {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 0.8rem;
    }

    .ingredient-name {
        font-weight: bold;
        color: #510B0B;
        margin-bottom: 0.3rem;
    }

    .ingredient-nutrition {
        font-size: 0.8rem;
        color: #B82F0D;
        line-height: 1.3;
    }

    .ingredient-seasonality {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: #5580AD;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    .allergen-warning {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        background: #B82F0D;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    /* å·²é€‰é£Ÿæ */
    .selected-ingredients {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 2px solid #EDBF9D;
    }

    .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .selected-tag {
        background: #5580AD;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .remove-ingredient {
        background: rgba(255,255,255,0.3);
        border: none;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ç¬¬ä¸‰æ­¥ï¼šé‡é‡è®¾ç½® */
    .weight-table {
        overflow-x: auto;
        margin-bottom: 2rem;
    }

    .weight-table table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .weight-table th,
    .weight-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #EDBF9D;
    }

    .weight-table th {
        background: #5580AD;
        color: white;
        font-weight: 600;
    }

    .weight-input {
        width: 80px;
        padding: 0.5rem;
        border: 2px solid #A1B4B2;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
    }

    .weight-input:focus {
        border-color: #5580AD;
        outline: none;
    }

    .suggest-btn {
        background: #EDBF9D;
        color: #510B0B;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .suggest-btn:hover {
        background: #A1B4B2;
    }

    /* ç¬¬å››æ­¥ï¼šè¥å…»åˆ†æ */
    .nutrition-analysis {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .nutrition-chart {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border: 2px solid #A1B4B2;
    }

    .chart-title {
        font-size: 1.2rem;
        color: #510B0B;
        margin-bottom: 1rem;
        text-align: center;
    }

    .nutrition-bars {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .nutrition-bar {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .bar-label {
        width: 60px;
        font-size: 0.9rem;
        font-weight: bold;
        color: #510B0B;
    }

    .bar-container {
        flex: 1;
        height: 25px;
        background: #EDBF9D;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    .bar-fill {
        height: 100%;
        border-radius: 12px;
        transition: width 0.3s ease;
        position: relative;
    }

    .bar-fill.protein { background: #4caf50; }
    .bar-fill.fat { background: #ff9800; }
    .bar-fill.carbs { background: #2196f3; }
    .bar-fill.fiber { background: #9c27b0; }

    .bar-fill.warning { background: #f44336; }
    .bar-fill.good { background: #4caf50; }

    .bar-value {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .nutrition-status {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid;
    }

    .nutrition-status.good {
        background: #e8f5e8;
        border-color: #4caf50;
        color: #2e7d32;
    }

    .nutrition-status.warning {
        background: #fff3e0;
        border-color: #ff9800;
        color: #ef6c00;
    }

    .nutrition-status.poor {
        background: #ffebee;
        border-color: #f44336;
        color: #c62828;
    }

    .warning-list, .recommendation-list {
        margin-top: 0.5rem;
    }

    .warning-list li, .recommendation-list li {
        margin-bottom: 0.3rem;
    }

    /* ç¬¬äº”æ­¥ï¼šä¿å­˜é£Ÿè°± */
    .recipe-form {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border: 2px solid #A1B4B2;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: #510B0B;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #A1B4B2;
        border-radius: 8px;
        font-size: 1rem;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        border-color: #5580AD;
        outline: none;
    }

    /* æ­¥éª¤å¯¼èˆªæŒ‰é’® */
    .step-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
    }

    .nav-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-prev {
        background: #A1B4B2;
        color: white;
    }

    .btn-prev:hover:not(:disabled) {
        background: #5580AD;
    }

    .btn-next {
        background: #5580AD;
        color: white;
    }

    .btn-next:hover:not(:disabled) {
        background: #510B0B;
    }

    .btn-save {
        background: #EDBF9D;
        color: #510B0B;
    }

    .btn-save:hover:not(:disabled) {
        background: #B82F0D;
        color: white;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
        text-align: center;
        padding: 2rem;
        color: #5580AD;
    }

    .spinner {
        border: 3px solid #EDBF9D;
        border-top: 3px solid #5580AD;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .nutrition-analysis {
            grid-template-columns: 1fr;
        }
        
        .step-navigation {
            flex-direction: column;
            gap: 1rem;
        }
        
        .nav-btn {
            width: 100%;
        }
        
        .ingredients-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
        
        .category-tabs {
            justify-content: center;
        }
    }
</style>

<div class="create-recipe-container">
    <div class="page-header">
        <h1>ğŸ½ï¸ åˆ›å»ºå® ç‰©é£Ÿè°±</h1>
        <p>ä¸ºæ‚¨çš„çˆ±å® å®šåˆ¶è¥å…»å‡è¡¡çš„ç¾å‘³é£Ÿè°±</p>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-active" id="progressLineActive" style="width: 20%;"></div>
            </div>
            <div class="progress-step active" data-step="1">
                <span>1</span>
                <div class="step-label">é€‰æ‹©å® ç‰©</div>
            </div>
            <div class="progress-step" data-step="2">
                <span>2</span>
                <div class="step-label">é€‰æ‹©é£Ÿæ</div>
            </div>
            <div class="progress-step" data-step="3">
                <span>3</span>
                <div class="step-label">è®¾ç½®é‡é‡</div>
            </div>
            <div class="progress-step" data-step="4">
                <span>4</span>
                <div class="step-label">è¥å…»åˆ†æ</div>
            </div>
            <div class="progress-step" data-step="5">
                <span>5</span>
                <div class="step-label">ä¿å­˜é£Ÿè°±</div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å® ç‰© -->
    <div class="step-content" id="step1">
        <div class="step-title">
            <i class="fas fa-paw"></i>
            é€‰æ‹©ç›®æ ‡å® ç‰©
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">é€‰æ‹©è¦ä¸ºå“ªåªå® ç‰©åˆ›å»ºé£Ÿè°±ï¼Œæˆ‘ä»¬å°†æ ¹æ®å…¶ä¿¡æ¯æä¾›ä¸ªæ€§åŒ–è¥å…»å»ºè®®ã€‚</p>
        
        <div class="pet-selector">
            {% for pet in pets %}
            <div class="pet-option" data-pet-id="{{ pet.id }}">
                <img src="{{ url_for('static', filename='images/avatars/' + pet.avatar) }}" alt="{{ pet.name }}" class="pet-avatar">
                <div class="pet-info">
                    <h3>{{ pet.name }}</h3>
                    <div class="pet-stats">
                        {{ pet.species }} | {{ pet.weight }}kg | {{ pet.age }}å²
                        {% if pet.breed %}
                        <br>{{ pet.breed }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šé€‰æ‹©é£Ÿæ -->
    <div class="step-content hidden" id="step2">
        <div class="step-title">
            <i class="fas fa-carrot"></i>
            é€‰æ‹©é£Ÿæ
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">ä»ä¸åŒåˆ†ç±»ä¸­é€‰æ‹©æ‚¨æƒ³è¦çš„é£Ÿæï¼Œå»ºè®®æ­é…å¤šç§ç±»å‹ä»¥ç¡®ä¿è¥å…»å‡è¡¡ã€‚</p>
        
        <!-- åˆ†ç±»æ ‡ç­¾ -->
        <div class="category-tabs" id="categoryTabs">
            <div class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½é£Ÿæåˆ†ç±»...
            </div>
        </div>
        
        <!-- é£Ÿæç½‘æ ¼ -->
        <div class="ingredients-grid" id="ingredientsGrid">
            <div class="loading">
                <div class="spinner"></div>
                æ­£åœ¨åŠ è½½é£Ÿæ...
            </div>
        </div>
        
        <!-- å·²é€‰é£Ÿæ -->
        <div class="selected-ingredients">
            <h3 style="color: #510B0B; margin-bottom: 1rem;">
                <i class="fas fa-check-circle"></i>
                å·²é€‰æ‹©çš„é£Ÿæ (<span id="selectedCount">0</span>)
            </h3>
            <div class="selected-list" id="selectedList">
                <div style="color: #666; font-style: italic;">è¿˜æœªé€‰æ‹©ä»»ä½•é£Ÿæ</div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®é‡é‡ -->
    <div class="step-content hidden" id="step3">
        <div class="step-title">
            <i class="fas fa-balance-scale"></i>
            è®¾ç½®é£Ÿæé‡é‡
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">æ ¹æ®å® ç‰©éœ€æ±‚è°ƒæ•´å„é£Ÿæçš„é‡é‡ï¼Œæˆ‘ä»¬å·²ä¸ºæ‚¨æä¾›æ¨èç”¨é‡ã€‚</p>
        
        <button class="suggest-btn" onclick="suggestWeights()">
            <i class="fas fa-magic"></i>
            è·å–æ¨èé‡é‡
        </button>
        
        <div class="weight-table">
            <table>
                <thead>
                    <tr>
                        <th>é£Ÿæ</th>
                        <th>é‡é‡ (g)</th>
                        <th>çƒ­é‡ (kcal)</th>
                        <th>è›‹ç™½è´¨ (g)</th>
                        <th>è„‚è‚ª (g)</th>
                        <th>ç¢³æ°´ (g)</th>
                    </tr>
                </thead>
                <tbody id="weightTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; font-style: italic;">
                            è¯·å…ˆé€‰æ‹©é£Ÿæ
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span><strong>æ€»é‡é‡:</strong> <span id="totalWeight">0</span> g</span>
                <span><strong>æ€»çƒ­é‡:</strong> <span id="totalCalories">0</span> kcal</span>
                <button class="btn btn-primary" onclick="calculateNutrition()" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-calculator"></i>
                    é‡æ–°è®¡ç®—
                </button>
            </div>
        </div>
    </div>

    <!-- ç¬¬å››æ­¥ï¼šè¥å…»åˆ†æ -->
    <div class="step-content hidden" id="step4">
        <div class="step-title">
            <i class="fas fa-chart-pie"></i>
            è¥å…»æˆåˆ†åˆ†æ
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">æŸ¥çœ‹é£Ÿè°±çš„è¥å…»é…æ¯”ï¼Œç¡®ä¿æ»¡è¶³å® ç‰©çš„è¥å…»éœ€æ±‚ã€‚</p>
        
        <div class="nutrition-analysis">
            <!-- è¥å…»æ¯”ä¾‹å›¾è¡¨ -->
            <div class="nutrition-chart">
                <div class="chart-title">è¥å…»æˆåˆ†æ¯”ä¾‹</div>
                <div class="nutrition-bars" id="nutritionBars">
                    <div class="nutrition-bar">
                        <div class="bar-label">è›‹ç™½è´¨</div>
                        <div class="bar-container">
                            <div class="bar-fill protein" style="width: 0%;">
                                <div class="bar-value">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="nutrition-bar">
                        <div class="bar-label">è„‚è‚ª</div>
                        <div class="bar-container">
                            <div class="bar-fill fat" style="width: 0%;">
                                <div class="bar-value">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="nutrition-bar">
                        <div class="bar-label">ç¢³æ°´</div>
                        <div class="bar-container">
                            <div class="bar-fill carbs" style="width: 0%;">
                                <div class="bar-value">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="nutrition-bar">
                        <div class="bar-label">çº¤ç»´</div>
                        <div class="bar-container">
                            <div class="bar-fill fiber" style="width: 0%;">
                                <div class="bar-value">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¥å…»çŠ¶æ€è¯„ä¼° -->
            <div class="nutrition-chart">
                <div class="chart-title">è¥å…»çŠ¶æ€è¯„ä¼°</div>
                <div class="nutrition-status good" id="nutritionStatus">
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: bold; margin-bottom: 0.5rem;">
                        <i class="fas fa-check-circle"></i>
                        è¥å…»é…æ¯”è‰¯å¥½
                    </div>
                    <div id="nutritionDetails">
                        è¯·å…ˆè®¡ç®—è¥å…»æˆåˆ†
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¯¦ç»†è¥å…»ä¿¡æ¯ -->
        <div class="nutrition-chart" style="margin-top: 2rem;">
            <div class="chart-title">è¯¦ç»†è¥å…»ä¿¡æ¯</div>
            <div id="detailedNutrition" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="text-align: center; color: #666;">è¯·å…ˆè®¡ç®—è¥å…»æˆåˆ†</div>
            </div>
        </div>
    </div>

    <!-- ç¬¬äº”æ­¥ï¼šä¿å­˜é£Ÿè°± -->
    <div class="step-content hidden" id="step5">
        <div class="step-title">
            <i class="fas fa-save"></i>
            ä¿å­˜é£Ÿè°±
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">ä¸ºæ‚¨çš„é£Ÿè°±æ·»åŠ åç§°å’Œæè¿°ï¼Œé€‰æ‹©ä¿å­˜ä¸ºè‰ç¨¿æˆ–ç›´æ¥å‘å¸ƒã€‚</p>
        
        <div class="recipe-form">
            <form id="recipeForm">
                <div class="form-group">
                    <label for="recipeName">
                        <i class="fas fa-utensils"></i>
                        é£Ÿè°±åç§° *
                    </label>
                    <input type="text" id="recipeName" name="recipeName" required 
                           placeholder="ä¾‹å¦‚ï¼šé‡‘æ¯›è¥å…»å¤§é¤ã€çŒ«å’ªå¥åº·é£Ÿè°±" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="recipeDescription">
                        <i class="fas fa-file-alt"></i>
                        é£Ÿè°±æè¿° (å¯é€‰)
                    </label>
                    <textarea id="recipeDescription" name="recipeDescription" rows="4" 
                            placeholder="æè¿°è¿™ä¸ªé£Ÿè°±çš„ç‰¹ç‚¹ã€é€‚ç”¨åœºæ™¯ã€åˆ¶ä½œè¦ç‚¹ç­‰..." maxlength="500"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="nav-btn btn-save" onclick="saveRecipe(true)" style="flex: 1;">
                        <i class="fas fa-file"></i>
                        ä¿å­˜ä¸ºè‰ç¨¿
                    </button>
                    <button type="button" class="nav-btn btn-save" onclick="saveRecipe(false)" style="flex: 1;">
                        <i class="fas fa-share"></i>
                        å‘å¸ƒé£Ÿè°±
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ­¥éª¤å¯¼èˆª -->
    <div class="step-navigation">
        <button class="nav-btn btn-prev" id="prevBtn" onclick="previousStep()" disabled>
            <i class="fas fa-chevron-left"></i>
            ä¸Šä¸€æ­¥
        </button>
        
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span style="color: #510B0B; font-weight: bold;">
                ç¬¬ <span id="currentStepText">1</span> æ­¥ï¼Œå…± 5 æ­¥
            </span>
        </div>
        
        <button class="nav-btn btn-next" id="nextBtn" onclick="nextStep()" disabled>
            ä¸‹ä¸€æ­¥
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// å…¨å±€å˜é‡
let currentStep = 1;
let selectedPetId = null;
let selectedIngredients = [];
let ingredientWeights = {};
let nutritionData = null;
let categories = [];
let allIngredients = [];

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // -------- æ·»åŠ è¿™ä¸€æ®µï¼šç»‘å®šå® ç‰©é€‰æ‹©äº‹ä»¶ --------
    bindPetSelectionEvents();

    loadCategories();
    updateStepVisibility();
    updateProgressBar();
});

// -------- æ·»åŠ è¿™ä¸ªæ–°å‡½æ•°ï¼šç»‘å®šå® ç‰©é€‰æ‹©äº‹ä»¶ --------
function bindPetSelectionEvents() {
    const petOptions = document.querySelectorAll('.pet-option');
    petOptions.forEach(function(petOption) {
        petOption.addEventListener('click', function() {
            const petId = parseInt(this.getAttribute('data-pet-id'));
            selectPet(petId);
        });
    });
}

// é€‰æ‹©å® ç‰©
function selectPet(petId) {
    selectedPetId = petId;
    
    // æ›´æ–°UI
    document.querySelectorAll('.pet-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`[data-pet-id="${petId}"]`).classList.add('selected');
    
    // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
    document.getElementById('nextBtn').disabled = false;
    
    showSuccessMessage('å·²é€‰æ‹©å® ç‰©ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥');
}

// åŠ è½½é£Ÿæåˆ†ç±»
async function loadCategories() {
    try {
        const response = await fetch('/recipe/api/categories');
        categories = await response.json();
        
        const tabsContainer = document.getElementById('categoryTabs');
        tabsContainer.innerHTML = '';
        
        // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
        const allTab = document.createElement('div');
        allTab.className = 'category-tab active';
        allTab.innerHTML = `
            <i class="fas fa-list"></i>
            å…¨éƒ¨é£Ÿæ
            <span class="category-count">${categories.reduce((sum, cat) => sum + cat.count, 0)}</span>
        `;
        allTab.onclick = () => selectCategory('all');
        tabsContainer.appendChild(allTab);
        
        // æ·»åŠ åˆ†ç±»é€‰é¡¹
        categories.forEach(category => {
            const tab = document.createElement('div');
            tab.className = 'category-tab';
            tab.innerHTML = `
                <i class="${category.icon}"></i>
                ${category.name}
                <span class="category-count">${category.count}</span>
            `;
            tab.onclick = () => selectCategory(category.value);
            tabsContainer.appendChild(tab);
        });
        
        // é»˜è®¤åŠ è½½å…¨éƒ¨é£Ÿæ
        loadIngredients();
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        showErrorMessage('åŠ è½½é£Ÿæåˆ†ç±»å¤±è´¥');
    }
}

// é€‰æ‹©åˆ†ç±»
function selectCategory(categoryValue) {
    // æ›´æ–°åˆ†ç±»æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.closest('.category-tab').classList.add('active');
    
    // åŠ è½½è¯¥åˆ†ç±»çš„é£Ÿæ
    loadIngredients(categoryValue === 'all' ? null : categoryValue);
}

// åŠ è½½é£Ÿæ
async function loadIngredients(category = null) {
    try {
        const url = new URL('/recipe/api/ingredients', window.location.origin);
        if (category) {
            url.searchParams.append('category', category);
        }
        
        const response = await fetch(url);
        const ingredients = await response.json();
        
        const gridContainer = document.getElementById('ingredientsGrid');
        gridContainer.innerHTML = '';
        
        if (ingredients.length === 0) {
            gridContainer.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1/-1;">è¯¥åˆ†ç±»æš‚æ— å¯ç”¨é£Ÿæ</div>';
            return;
        }
        
        ingredients.forEach(ingredient => {
            const card = document.createElement('div');
            card.className = 'ingredient-card';
            if (selectedIngredients.some(item => item.id === ingredient.id)) {
                card.classList.add('selected');
            }
            
            card.innerHTML = `
                ${ingredient.seasonality ? `<div class="ingredient-seasonality">${getSeasonalityText(ingredient.seasonality)}</div>` : ''}
                ${ingredient.is_common_allergen ? '<div class="allergen-warning">è¿‡æ•åŸ</div>' : ''}
                <div class="ingredient-image">
                    ${ingredient.image_filename ? 
                        `<img src="/static/images/ingredients/${ingredient.image_filename}" alt="${ingredient.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        'æš‚æ— å›¾ç‰‡'
                    }
                </div>
                <div class="ingredient-name">${ingredient.name}</div>
                <div class="ingredient-nutrition">${ingredient.nutrition_summary}</div>
            `;
            
            card.onclick = () => toggleIngredient(ingredient);
            gridContainer.appendChild(card);
        });
        
    } catch (error) {
        console.error('åŠ è½½é£Ÿæå¤±è´¥:', error);
        showErrorMessage('åŠ è½½é£Ÿæå¤±è´¥');
    }
}

// åˆ‡æ¢é£Ÿæé€‰æ‹©çŠ¶æ€
function toggleIngredient(ingredient) {
    const existingIndex = selectedIngredients.findIndex(item => item.id === ingredient.id);
    
    if (existingIndex >= 0) {
        // å–æ¶ˆé€‰æ‹©
        selectedIngredients.splice(existingIndex, 1);
        delete ingredientWeights[ingredient.id];
    } else {
        // æ·»åŠ é€‰æ‹©
        selectedIngredients.push(ingredient);
    }
    
    // æ›´æ–°UI
    updateSelectedIngredientsDisplay();
    updateIngredientsGridSelection();
    updateNextButtonState();
}

// æ›´æ–°å·²é€‰é£Ÿææ˜¾ç¤º
function updateSelectedIngredientsDisplay() {
    const countEl = document.getElementById('selectedCount');
    const listEl = document.getElementById('selectedList');
    
    countEl.textContent = selectedIngredients.length;
    
    if (selectedIngredients.length === 0) {
        listEl.innerHTML = '<div style="color: #666; font-style: italic;">è¿˜æœªé€‰æ‹©ä»»ä½•é£Ÿæ</div>';
    } else {
        listEl.innerHTML = selectedIngredients.map(ingredient => `
            <div class="selected-tag">
                ${ingredient.name}
                <button class="remove-ingredient" onclick="removeIngredient(${ingredient.id})">Ã—</button>
            </div>
        `).join('');
    }
}

// ç§»é™¤é£Ÿæ
function removeIngredient(ingredientId) {
    const index = selectedIngredients.findIndex(item => item.id === ingredientId);
    if (index >= 0) {
        selectedIngredients.splice(index, 1);
        delete ingredientWeights[ingredientId];
        updateSelectedIngredientsDisplay();
        updateIngredientsGridSelection();
        updateNextButtonState();
        
        // å¦‚æœåœ¨é‡é‡è®¾ç½®æ­¥éª¤ï¼Œæ›´æ–°é‡é‡è¡¨æ ¼
        if (currentStep === 3) {
            updateWeightTable();
        }
    }
}

// æ›´æ–°é£Ÿæç½‘æ ¼é€‰æ‹©çŠ¶æ€
function updateIngredientsGridSelection() {
    document.querySelectorAll('.ingredient-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    selectedIngredients.forEach(ingredient => {
        const cards = document.querySelectorAll('.ingredient-card');
        cards.forEach(card => {
            if (card.querySelector('.ingredient-name').textContent === ingredient.name) {
                card.classList.add('selected');
            }
        });
    });
}

// è·å–å­£èŠ‚æ€§æ–‡æœ¬
function getSeasonalityText(seasonality) {
    const seasonMap = {
        'all_year': 'å…¨å¹´',
        'spring': 'æ˜¥å­£',
        'summer': 'å¤å­£',
        'autumn': 'ç§‹å­£',
        'winter': 'å†¬å­£',
        'spring,summer': 'æ˜¥å¤',
        'autumn,winter': 'ç§‹å†¬'
    };
    return seasonMap[seasonality] || seasonality;
}

// æ›´æ–°ä¸‹ä¸€æ­¥æŒ‰é’®çŠ¶æ€
function updateNextButtonState() {
    const nextBtn = document.getElementById('nextBtn');
    
    switch(currentStep) {
        case 1:
            nextBtn.disabled = !selectedPetId;
            break;
        case 2:
            nextBtn.disabled = selectedIngredients.length === 0;
            break;
        case 3:
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é£Ÿæéƒ½è®¾ç½®äº†é‡é‡
            const hasWeights = selectedIngredients.every(ingredient => 
                ingredientWeights[ingredient.id] && ingredientWeights[ingredient.id] > 0
            );
            nextBtn.disabled = !hasWeights;
            break;
        case 4:
            nextBtn.disabled = !nutritionData;
            break;
        default:
            nextBtn.disabled = false;
    }
}

// æ­¥éª¤å¯¼èˆª
function nextStep() {
    if (currentStep < 5) {
        currentStep++;
        updateStepVisibility();
        updateProgressBar();
        
        // ç‰¹æ®Šå¤„ç†
        if (currentStep === 3) {
            updateWeightTable();
        } else if (currentStep === 4) {
            // è‡ªåŠ¨è®¡ç®—è¥å…»æˆåˆ†
            calculateNutrition();
        }
        
        updateNextButtonState();
        updatePrevButtonState();
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepVisibility();
        updateProgressBar();
        updateNextButtonState();
        updatePrevButtonState();
    }
}

function updatePrevButtonState() {
    document.getElementById('prevBtn').disabled = currentStep === 1;
}

// æ›´æ–°æ­¥éª¤å¯è§æ€§
function updateStepVisibility() {
    for (let i = 1; i <= 5; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i === currentStep) {
            stepEl.classList.remove('hidden');
        } else {
            stepEl.classList.add('hidden');
        }
    }
    
    document.getElementById('currentStepText').textContent = currentStep;
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 5) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'block';
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgressBar() {
    const progressPercentage = (currentStep / 5) * 100;
    document.getElementById('progressLineActive').style.width = `${progressPercentage}%`;
    
    // æ›´æ–°æ­¥éª¤åœ†ç‚¹çŠ¶æ€
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
}

// æ›´æ–°é‡é‡è¡¨æ ¼
function updateWeightTable() {
    const tbody = document.getElementById('weightTableBody');
    
    if (selectedIngredients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; font-style: italic;">è¯·å…ˆé€‰æ‹©é£Ÿæ</td></tr>';
        return;
    }
    
    tbody.innerHTML = selectedIngredients.map(ingredient => {
        const weight = ingredientWeights[ingredient.id] || 0;
        const calories = (ingredient.calories * weight / 100).toFixed(1);
        const protein = (ingredient.protein * weight / 100).toFixed(1);
        const fat = (ingredient.fat * weight / 100).toFixed(1);
        const carbs = (ingredient.carbohydrate * weight / 100).toFixed(1);
        
        return `
            <tr>
                <td><strong>${ingredient.name}</strong></td>
                <td>
                    <input type="number" class="weight-input"
                        value="${weight}"
                        min="0" max="1000" step="1"
                        onchange="updateIngredientWeight(${ingredient.id}, this.value)"
                        onblur="updateTotals()">
                </td>
                <td>${calories}</td>
                <td>${protein}</td>
                <td>${fat}</td>
                <td>${carbs}</td>
            </tr>
        `;
    }).join('');
    
    updateTotals();
}

// æ›´æ–°é£Ÿæé‡é‡
function updateIngredientWeight(ingredientId, weight) {
    ingredientWeights[ingredientId] = parseFloat(weight) || 0;
    updateTotals();
    updateNextButtonState();
}

// æ›´æ–°æ€»è®¡
function updateTotals() {
    let totalWeight = 0;
    let totalCalories = 0;
    
    selectedIngredients.forEach(ingredient => {
        const weight = ingredientWeights[ingredient.id] || 0;
        totalWeight += weight;
        totalCalories += (ingredient.calories * weight / 100);
    });
    
    document.getElementById('totalWeight').textContent = totalWeight.toFixed(0);
    document.getElementById('totalCalories').textContent = totalCalories.toFixed(0);
}

// è·å–æ¨èé‡é‡
async function suggestWeights() {
    if (!selectedPetId || selectedIngredients.length === 0) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©å® ç‰©å’Œé£Ÿæ');
        return;
    }
    
    try {
        const response = await fetch('/recipe/api/suggest_weights', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pet_id: selectedPetId,
                ingredient_ids: selectedIngredients.map(ing => ing.id)
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showErrorMessage(data.error);
            return;
        }
        
        // åº”ç”¨æ¨èé‡é‡
        data.suggestions.forEach(suggestion => {
            ingredientWeights[suggestion.ingredient_id] = suggestion.suggested_weight;
        });
        
        updateWeightTable();
        showSuccessMessage('å·²åº”ç”¨æ¨èé‡é‡');
        
    } catch (error) {
        console.error('è·å–æ¨èé‡é‡å¤±è´¥:', error);
        showErrorMessage('è·å–æ¨èé‡é‡å¤±è´¥');
    }
}

// è®¡ç®—è¥å…»æˆåˆ†
async function calculateNutrition() {
    if (!selectedPetId || selectedIngredients.length === 0) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©å® ç‰©å’Œé£Ÿæ');
        return;
    }
    
    // æ£€æŸ¥é‡é‡è®¾ç½®
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,
        weight: ingredientWeights[ingredient.id] || 0
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('è¯·è®¾ç½®é£Ÿæé‡é‡');
        return;
    }
    
    try {
        const response = await fetch('/recipe/api/calculate_nutrition', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pet_id: selectedPetId,
                ingredients: ingredientsWithWeights
            })
        });
        
        nutritionData = await response.json();
        
        if (nutritionData.error) {
            showErrorMessage(nutritionData.error);
            return;
        }
        
        updateNutritionDisplay();
        updateNextButtonState();
        showSuccessMessage('è¥å…»æˆåˆ†è®¡ç®—å®Œæˆ');
        
    } catch (error) {
        console.error('è®¡ç®—è¥å…»æˆåˆ†å¤±è´¥:', error);
        showErrorMessage('è®¡ç®—è¥å…»æˆåˆ†å¤±è´¥');
    }
}

// æ›´æ–°è¥å…»æ˜¾ç¤º
function updateNutritionDisplay() {
    if (!nutritionData) return;
    
    const ratios = nutritionData.nutrition_ratios;
    const analysis = nutritionData.nutrition_analysis;
    
    // æ›´æ–°è¥å…»æ¯”ä¾‹æ¡å½¢å›¾
    updateNutritionBars(ratios);
    
    // æ›´æ–°è¥å…»çŠ¶æ€
    updateNutritionStatus(analysis);
    
    // æ›´æ–°è¯¦ç»†è¥å…»ä¿¡æ¯
    updateDetailedNutrition(nutritionData.total_nutrition);
}

// æ›´æ–°è¥å…»æ¡å½¢å›¾
function updateNutritionBars(ratios) {
    const bars = document.querySelectorAll('.nutrition-bar');
    
    const nutrients = [
        { name: 'protein', value: ratios.protein_percent, min: 18, max: 35 },
        { name: 'fat', value: ratios.fat_percent, min: 5, max: 25 },
        { name: 'carbs', value: ratios.carbohydrate_percent, min: 0, max: 50 },
        { name: 'fiber', value: ratios.fiber_percent, min: 1, max: 10 }
    ];
    
    nutrients.forEach((nutrient, index) => {
        const bar = bars[index];
        const fillEl = bar.querySelector('.bar-fill');
        const valueEl = bar.querySelector('.bar-value');
        
        const percentage = Math.min(100, (nutrient.value / 50) * 100); // æœ€å¤§æ˜¾ç¤º50%
        const isInRange = nutrient.value >= nutrient.min && (nutrient.max ? nutrient.value <= nutrient.max : true);
        
        fillEl.style.width = `${percentage}%`;
        fillEl.className = `bar-fill ${nutrient.name} ${isInRange ? 'good' : 'warning'}`;
        valueEl.textContent = `${nutrient.value.toFixed(1)}%`;
    });
}

// æ›´æ–°è¥å…»çŠ¶æ€
function updateNutritionStatus(analysis) {
    const statusEl = document.getElementById('nutritionStatus');
    const detailsEl = document.getElementById('nutritionDetails');
    
    // è®¾ç½®çŠ¶æ€æ ·å¼
    statusEl.className = `nutrition-status ${analysis.status}`;
    
    // è®¾ç½®çŠ¶æ€å›¾æ ‡å’Œæ–‡æœ¬
    const statusConfig = {
        good: { icon: 'fa-check-circle', text: 'è¥å…»é…æ¯”è‰¯å¥½', color: '#4caf50' },
        warning: { icon: 'fa-exclamation-triangle', text: 'è¥å…»é…æ¯”éœ€è¦è°ƒæ•´', color: '#ff9800' },
        poor: { icon: 'fa-times-circle', text: 'è¥å…»é…æ¯”ä¸åˆæ ¼', color: '#f44336' }
    };
    
    const config = statusConfig[analysis.status] || statusConfig.good;
    
    statusEl.querySelector('div').innerHTML = `
        <i class="fas ${config.icon}"></i>
        ${config.text}
    `;
    
    // è®¾ç½®è¯¦ç»†ä¿¡æ¯
    let detailsHTML = '';
    
    if (analysis.warnings && analysis.warnings.length > 0) {
        detailsHTML += `
            <div style="margin-bottom: 1rem;">
                <strong style="color: #f44336;">âš ï¸ è¥å…»è­¦å‘Š:</strong>
                <ul class="warning-list" style="margin-left: 1rem; margin-top: 0.5rem;">
                    ${analysis.warnings.map(warning => `<li>${warning}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        detailsHTML += `
            <div>
                <strong style="color: #2196f3;">ğŸ’¡ å»ºè®®:</strong>
                <ul class="recommendation-list" style="margin-left: 1rem; margin-top: 0.5rem;">
                    ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    detailsEl.innerHTML = detailsHTML || '<div style="color: #4caf50;">âœ… è¥å…»é…æ¯”åˆç†ï¼Œå¯ä»¥æ”¾å¿ƒç»™å® ç‰©é£Ÿç”¨</div>';
}

// æ›´æ–°è¯¦ç»†è¥å…»ä¿¡æ¯
function updateDetailedNutrition(nutrition) {
    const detailsEl = document.getElementById('detailedNutrition');
    
    const nutrients = [
        { label: 'æ€»é‡é‡', value: nutrition.total_weight.toFixed(0), unit: 'g' },
        { label: 'æ€»çƒ­é‡', value: nutrition.calories.toFixed(0), unit: 'kcal' },
        { label: 'è›‹ç™½è´¨', value: nutrition.protein.toFixed(1), unit: 'g' },
        { label: 'è„‚è‚ª', value: nutrition.fat.toFixed(1), unit: 'g' },
        { label: 'ç¢³æ°´åŒ–åˆç‰©', value: nutrition.carbohydrate.toFixed(1), unit: 'g' },
        { label: 'é’™', value: nutrition.calcium.toFixed(1), unit: 'mg' },
        { label: 'ç£·', value: nutrition.phosphorus.toFixed(1), unit: 'mg' },
        { label: 'ç»´ç”Ÿç´ A', value: nutrition.vitamin_a.toFixed(0), unit: 'IU' },
        { label: 'ç»´ç”Ÿç´ D', value: nutrition.vitamin_d.toFixed(0), unit: 'IU' },
        { label: 'ç‰›ç£ºé…¸', value: nutrition.taurine.toFixed(1), unit: 'mg' },
        { label: 'Omega-3', value: nutrition.omega_3.toFixed(2), unit: 'g' },
        { label: 'Omega-6', value: nutrition.omega_6.toFixed(2), unit: 'g' }
    ];
    
    detailsEl.innerHTML = nutrients.map(nutrient => `
        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #EDBF9D;">
            <div style="font-weight: bold; color: #510B0B; margin-bottom: 0.3rem;">${nutrient.label}</div>
            <div style="font-size: 1.2rem; color: #5580AD;">${nutrient.value} ${nutrient.unit}</div>
        </div>
    `).join('');
}

// ä¿å­˜é£Ÿè°±
async function saveRecipe(isDraft) {
    const recipeName = document.getElementById('recipeName').value.trim();
    const recipeDescription = document.getElementById('recipeDescription').value.trim();
    
    if (!recipeName) {
        showErrorMessage('è¯·è¾“å…¥é£Ÿè°±åç§°');
        return;
    }
    
    if (!selectedPetId || selectedIngredients.length === 0 || !nutritionData) {
        showErrorMessage('è¯·å®Œæˆæ‰€æœ‰æ­¥éª¤');
        return;
    }
    
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,
        weight: ingredientWeights[ingredient.id] || 0
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('è¯·è®¾ç½®é£Ÿæé‡é‡');
        return;
    }
    
    try {
        const response = await fetch('/recipe/api/save_recipe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: recipeName,
                description: recipeDescription,
                pet_id: selectedPetId,
                ingredients: ingredientsWithWeights,
                is_draft: isDraft
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showErrorMessage(data.error);
            return;
        }
        
        showSuccessMessage(data.message);
        
        // è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒæˆ–é£Ÿè°±è¯¦æƒ…é¡µ
        setTimeout(() => {
            window.location.href = '/user_center';
        }, 2000);
        
    } catch (error) {
        console.error('ä¿å­˜é£Ÿè°±å¤±è´¥:', error);
        showErrorMessage('ä¿å­˜é£Ÿè°±å¤±è´¥');
    }
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccessMessage(message) {
    // ç§»é™¤ç°æœ‰æ¶ˆæ¯
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // åˆ›å»ºæ–°æ¶ˆæ¯
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 3000);
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showErrorMessage(message) {
    // ç§»é™¤ç°æœ‰æ¶ˆæ¯
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // åˆ›å»ºæ–°æ¶ˆæ¯
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show type-warning';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 5000);
}

// é”®ç›˜å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
    if (e.altKey) {
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (currentStep > 1) previousStep();
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (currentStep < 5 && !document.getElementById('nextBtn').disabled) nextStep();
                break;
        }
    }
});

// é¡µé¢ç¦»å¼€æé†’
window.addEventListener('beforeunload', function(e) {
    if (selectedIngredients.length > 0 || selectedPetId) {
        e.preventDefault();
        e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„é£Ÿè°±æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
    }
});
</script>
{% endblock %}