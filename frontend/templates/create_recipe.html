{% extends "base.html" %}

{% block title %}åˆ›å»ºé£Ÿè°± - Pet Recipe Website{% endblock %}

{% block content %}
<style>
    .create-recipe-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #5580AD 0%, #A1B4B2 100%);
        color: white;
        border-radius: 15px;
    }

    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    /* æ­¥éª¤è¿›åº¦æ¡ */
    .progress-container {
        margin-bottom: 3rem;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 2rem;
    }

    .progress-line {
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 3px;
        background: #EDBF9D;
        z-index: 1;
    }

    .progress-line-active {
        height: 3px;
        background: #5580AD;
        transition: width 0.3s ease;
        z-index: 2;
        position: absolute;
        top: 0;
        left: 0;
    }

    .progress-step {
        background: white;
        border: 3px solid #EDBF9D;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #B82F0D;
        position: relative;
        z-index: 3;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .progress-step.completed {
        background: #EDBF9D;
        border-color: #EDBF9D;
        color: #510B0B;
    }

    .step-label {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.9rem;
        color: #510B0B;
        font-weight: 500;
    }

    /* æ­¥éª¤å†…å®¹ */
    .step-content {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 2px solid #A1B4B2;
        margin-bottom: 2rem;
    }

    .step-content.hidden {
        display: none;
    }

    .step-title {
        font-size: 1.8rem;
        color: #510B0B;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    /* ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å® ç‰© */
    .pet-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .pet-option {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .pet-option:hover {
        border-color: #5580AD;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(85, 128, 173, 0.2);
    }

    .pet-option.selected {
        border-color: #B82F0D;
        background: #fff5f5;
    }

    .pet-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #EDBF9D;
    }

    .pet-info h3 {
        color: #510B0B;
        margin-bottom: 0.5rem;
        font-size: 1.3rem;
    }

    .pet-stats {
        color: #B82F0D;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* ç¬¬äºŒæ­¥ï¼šé€‰æ‹©é£Ÿæ */
    .category-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .category-tab {
        padding: 0.8rem 1.5rem;
        background: white;
        border: 2px solid #A1B4B2;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .category-tab:hover {
        border-color: #5580AD;
        transform: translateY(-1px);
    }

    .category-tab.active {
        background: #5580AD;
        border-color: #5580AD;
        color: white;
    }

    .category-count {
        background: rgba(0,0,0,0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
    }

    .category-tab.active .category-count {
        background: rgba(255,255,255,0.2);
    }

    .ingredients-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .ingredient-card {
        background: white;
        border: 3px solid #A1B4B2;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        /* ç¡®ä¿å¡ç‰‡æœ‰è¶³å¤Ÿé«˜åº¦ */
        min-height: 240px;
        display: flex;
        flex-direction: column;
    }

    .ingredient-card:hover {
        border-color: #5580AD;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(85, 128, 173, 0.15);
    }

    .ingredient-card.selected {
        border-color: #B82F0D;
        background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        box-shadow: 0 8px 25px rgba(184, 47, 13, 0.2);
    }

    .ingredient-seasonality {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #EDBF9D;
        color: #510B0B;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .allergen-warning {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #ff4444;
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .ingredient-image {
        width: 50%;
        /* ä½¿ç”¨aspect-ratioåˆ›å»ºæ­£æ–¹å½¢å®¹å™¨ */
        aspect-ratio: 1 / 1;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 1rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        overflow: hidden;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
        /* ç¡®ä¿å›¾ç‰‡å®¹å™¨åœ¨flexå¸ƒå±€ä¸­ä¸ä¼šè¢«å‹ç¼© */
        flex-shrink: 0;
    }

    .ingredient-card:hover .ingredient-image {
        border-color: #5580AD;
        box-shadow: 0 4px 12px rgba(85, 128, 173, 0.15);
    }

    /* å›¾ç‰‡æ ·å¼ - ä¿æŒå®Œæ•´æ˜¾ç¤º */
    .ingredient-image img {
        width: 100%;
        height: 100%;
        /* ä½¿ç”¨containç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼Œä¿æŒæ¯”ä¾‹ */
        object-fit: contain;
        transition: transform 0.3s ease;
        /* æ·»åŠ ä¸€äº›å†…è¾¹è·ï¼Œé¿å…å›¾ç‰‡è´´è¾¹ */
        padding: 8px;
        box-sizing: border-box;
    }

    .ingredient-card:hover .ingredient-image img {
        transform: scale(1.05);
    }

    /* å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„æ ·å¼ */
    .ingredient-image div {
        font-style: italic;
        text-align: center;
        padding: 1rem;
        color: #999;
        font-size: 0.9rem;
    }

    /* é£Ÿæåç§°å’Œè¥å…»ä¿¡æ¯ - è°ƒæ•´ä¸ºflexå¸ƒå±€åº•éƒ¨å¯¹é½ */
    .ingredient-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #510B0B;
        margin-bottom: 0.5rem;
        text-align: center;
        /* åœ¨flexå®¹å™¨ä¸­å æ®å‰©ä½™ç©ºé—´ */
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ingredient-nutrition {
        font-size: 0.9rem;
        color: #B82F0D;
        text-align: center;
        line-height: 1.3;
        /* å›ºå®šåœ¨åº•éƒ¨ */
        margin-top: auto;
    }

    /* å“åº”å¼ä¼˜åŒ– - ä¸åŒå±å¹•å°ºå¯¸ä¸‹çš„ç½‘æ ¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .ingredients-grid {
            /* æ‰‹æœºç«¯ï¼šæœ€å°180px */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .ingredient-card {
            padding: 1rem;
            min-height: 220px;
        }
        
        .ingredient-image {
            margin: 0.8rem 0;
        }
        
        .ingredient-name {
            font-size: 1.1rem;
        }
        
        .ingredient-nutrition {
            font-size: 0.85rem;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .ingredients-grid {
            /* å¹³æ¿ç«¯ï¼šæœ€å°190px */
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
        .ingredients-grid {
            /* æ¡Œé¢ç«¯ï¼šæœ€å°200px */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }

    @media (min-width: 1441px) {
        .ingredients-grid {
            /* å¤§å±å¹•ï¼šæœ€å°210pxï¼Œæœ€å¤šä¸€è¡Œ5ä¸ª */
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            max-width: 1800px;
            margin: 0 auto 2rem auto;
        }
    }

    /* ä¸ºä¸æ”¯æŒaspect-ratioçš„æµè§ˆå™¨æä¾›å¤‡é€‰æ–¹æ¡ˆ */
    @supports not (aspect-ratio: 1 / 1) {
        .ingredient-image {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%; /* åˆ›å»ºæ­£æ–¹å½¢ */
        }
        
        .ingredient-image img,
        .ingredient-image div {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    }

    /* å·²é€‰é£Ÿææ˜¾ç¤º */
    .selected-ingredients-panel {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 2px solid #A1B4B2;
    }

    .selected-ingredients-panel h3 {
        color: #510B0B;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .selected-count {
        background: #B82F0D;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
    }

    .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
    }

    .selected-tag {
        background: #5580AD;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .remove-ingredient:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
    }

    /* ç¬¬ä¸‰æ­¥ï¼šé‡é‡è®¾ç½® */
    .weight-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .weight-table th {
        background: #5580AD;
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
    }

    .weight-table td {
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }

    .weight-table tbody tr:hover {
        background: #f8f9fa;
    }

    .weight-input {
        width: 80px;
        padding: 0.5rem;
        border: 2px solid #A1B4B2;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        transition: border-color 0.3s ease;
    }

    .weight-input:focus {
        outline: none;
        border-color: #5580AD;
    }

    /* å¯¼èˆªæŒ‰é’® */
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .nav-btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .prev-btn {
        background: #A1B4B2;
        color: white;
    }

    .prev-btn:hover:not(:disabled) {
        background: #8a9b99;
        transform: translateX(-2px);
    }

    .prev-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .next-btn {
        background: #B82F0D;
        color: white;
    }

    .next-btn:hover:not(:disabled) {
        background: #a0280b;
        transform: translateX(2px);
    }

    .next-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .step-info {
        color: #510B0B;
        font-weight: 500;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #A1B4B2;
        border-top: 4px solid #5580AD;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ------- æ–°å¢ï¼šæ¶ˆæ¯æç¤ºæ ·å¼ ------- */
    .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .success-message.show {
        opacity: 1;
        transform: translateX(0);
    }

    .success-message.hide {
        opacity: 0;
        transform: translateX(100%);
    }

    .success-message.type-warning {
        background: #ff4444;
    }

    .success-message.type-info {
        background: #2196F3;
    }
</style>

<div class="create-recipe-container">
    <div class="page-header">
        <h1>ğŸ½ï¸ åˆ›å»ºå® ç‰©é£Ÿè°±</h1>
        <p>ä¸ºæ‚¨çš„çˆ±å® å®šåˆ¶è¥å…»å‡è¡¡çš„ç¾å‘³é£Ÿè°±</p>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-container">
        <div class="progress-steps">
            <div class="progress-line">
                <div class="progress-line-active" id="progressLineActive" style="width: 20%;"></div>
            </div>
            <div class="progress-step active" data-step="1">
                <span>1</span>
                <div class="step-label">é€‰æ‹©å® ç‰©</div>
            </div>
            <div class="progress-step" data-step="2">
                <span>2</span>
                <div class="step-label">é€‰æ‹©é£Ÿæ</div>
            </div>
            <div class="progress-step" data-step="3">
                <span>3</span>
                <div class="step-label">è®¾ç½®é‡é‡</div>
            </div>
            <div class="progress-step" data-step="4">
                <span>4</span>
                <div class="step-label">è¥å…»åˆ†æ</div>
            </div>
            <div class="progress-step" data-step="5">
                <span>5</span>
                <div class="step-label">ä¿å­˜é£Ÿè°±</div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å® ç‰© -->
    <div class="step-content" id="step1">
        <div class="step-title">
            <i class="fas fa-paw"></i>
            é€‰æ‹©ç›®æ ‡å® ç‰©
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">é€‰æ‹©è¦ä¸ºå“ªåªå® ç‰©åˆ›å»ºé£Ÿè°±ï¼Œæˆ‘ä»¬å°†æ ¹æ®å…¶ä¿¡æ¯æä¾›ä¸ªæ€§åŒ–è¥å…»å»ºè®®ã€‚</p>
        
        <div class="pet-selector">
            {% for pet in pets %}
            <div class="pet-option" data-pet-id="{{ pet.id }}">
                <img src="{{ url_for('static', filename='images/avatars/' + pet.avatar) }}" alt="{{ pet.name }}" class="pet-avatar">
                <div class="pet-info">
                    <h3>{{ pet.name }}</h3>
                    <div class="pet-stats">
                        {{ pet.species }} | {{ pet.weight }}kg | {{ pet.age }}å²
                        {% if pet.breed %}
                        <br>{{ pet.breed }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šé€‰æ‹©é£Ÿæ -->
    <div class="step-content hidden" id="step2">
        <div class="step-title">
            <i class="fas fa-carrot"></i>
            é€‰æ‹©é£Ÿæ
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">ä»ä¸åŒåˆ†ç±»ä¸­é€‰æ‹©æ‚¨æƒ³è¦çš„é£Ÿæï¼Œå»ºè®®æ­é…å¤šç§ç±»å‹ä»¥ç¡®ä¿è¥å…»å‡è¡¡ã€‚</p>
        
        <!-- åˆ†ç±»æ ‡ç­¾ -->
        <div class="category-tabs" id="categoryTabs">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">åŠ è½½é£Ÿæåˆ†ç±»ä¸­...</span>
            </div>
        </div>

        <!-- é£Ÿæç½‘æ ¼ -->
        <div class="ingredients-grid" id="ingredientsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">åŠ è½½é£Ÿæä¸­...</span>
            </div>
        </div>

        <!-- å·²é€‰é£Ÿææ˜¾ç¤º -->
        <div class="selected-ingredients-panel">
            <h3>
                <i class="fas fa-check-circle"></i>
                å·²é€‰æ‹©é£Ÿæ
                <span class="selected-count" id="selectedCount">0</span>
            </h3>
            <div class="selected-list" id="selectedList">
                <div style="color: #666; font-style: italic;">è¿˜æœªé€‰æ‹©ä»»ä½•é£Ÿæ</div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®é‡é‡ -->
    <div class="step-content hidden" id="step3">
        <div class="step-title">
            <i class="fas fa-weight"></i>
            è®¾ç½®é£Ÿæé‡é‡
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">ä¸ºæ¯ç§é£Ÿæè®¾ç½®åˆé€‚çš„é‡é‡(å…‹)ï¼Œç³»ç»Ÿå°†å®æ—¶è®¡ç®—è¥å…»æˆåˆ†ã€‚</p>
        
        <table class="weight-table">
            <thead>
                <tr>
                    <th>é£Ÿæåç§°</th>
                    <th>é‡é‡(å…‹)</th>
                    <th>çƒ­é‡(å¡)</th>
                    <th>è›‹ç™½è´¨(å…‹)</th>
                    <th>è„‚è‚ª(å…‹)</th>
                    <th>ç¢³æ°´(å…‹)</th>
                </tr>
            </thead>
            <tbody id="weightTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; color: #666; font-style: italic;">è¯·å…ˆé€‰æ‹©é£Ÿæ</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- ç¬¬å››æ­¥ï¼šè¥å…»åˆ†æ -->
    <div class="step-content hidden" id="step4">
        <div class="step-title">
            <i class="fas fa-chart-bar"></i>
            è¥å…»æˆåˆ†åˆ†æ
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">æŸ¥çœ‹é£Ÿè°±çš„è¯¦ç»†è¥å…»æˆåˆ†ï¼Œç¡®ä¿ç¬¦åˆæ‚¨å® ç‰©çš„è¥å…»éœ€æ±‚ã€‚</p>
        
        <div id="nutritionAnalysis">
            <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">åˆ†æè¥å…»æˆåˆ†ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- ç¬¬äº”æ­¥ï¼šä¿å­˜é£Ÿè°± -->
    <div class="step-content hidden" id="step5">
        <div class="step-title">
            <i class="fas fa-save"></i>
            ä¿å­˜é£Ÿè°±
        </div>
        <p style="color: #B82F0D; margin-bottom: 2rem;">ä¸ºæ‚¨çš„é£Ÿè°±èµ·ä¸ªåå­—ï¼Œå¹¶æ·»åŠ æè¿°ä¿¡æ¯ã€‚</p>
        
        <div style="max-width: 600px;">
            <div class="form-group">
                <label for="recipeName">é£Ÿè°±åç§° *</label>
                <input type="text" id="recipeName" placeholder="ä¾‹å¦‚ï¼šå°å¯çˆ±çš„è¥å…»å¤§é¤" maxlength="50">
            </div>
            <div class="form-group">
                <label for="recipeDescription">é£Ÿè°±æè¿°</label>
                <textarea id="recipeDescription" rows="4" placeholder="æè¿°è¿™ä¸ªé£Ÿè°±çš„ç‰¹è‰²ã€é€‚ç”¨åœºæ™¯ç­‰..." maxlength="200"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="nav-btn" style="background: #A1B4B2;" onclick="saveRecipe(true)">
                    <i class="fas fa-edit"></i>
                    ä¿å­˜ä¸ºè‰ç¨¿
                </button>
                <button class="nav-btn" style="background: #B82F0D;" onclick="saveRecipe(false)">
                    <i class="fas fa-check"></i>
                    å‘å¸ƒé£Ÿè°±
                </button>
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªæŒ‰é’® -->
    <div class="navigation-buttons">
        <button class="nav-btn prev-btn" id="prevBtn" onclick="previousStep()" disabled>
            <i class="fas fa-chevron-left"></i>
            ä¸Šä¸€æ­¥
        </button>
        
        <div class="step-info">
            ç¬¬ <span id="currentStepText">1</span> / 5 æ­¥
        </div>
        
        <button class="nav-btn next-btn" id="nextBtn" onclick="nextStep()" disabled>
            ä¸‹ä¸€æ­¥
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// å…¨å±€å˜é‡
let currentStep = 1;
let selectedPetId = null;
let selectedIngredients = [];
let ingredientWeights = {};
let nutritionData = null;
let categories = [];
let allIngredients = [];

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ä¸ºæ‰€æœ‰å® ç‰©é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('click', function(e) {
        const petOption = e.target.closest('.pet-option');
        if (petOption) {
            const petId = petOption.getAttribute('data-pet-id');
            selectPet(petId);
        }
    });
    
    loadCategories();
    updateStepVisibility();
    updateProgressBar();
    updatePrevButtonState();
});

// é€‰æ‹©å® ç‰©
function selectPet(petId) {
    selectedPetId = petId;
    
    // æ›´æ–°UI
    document.querySelectorAll('.pet-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`[data-pet-id="${petId}"]`).classList.add('selected');
    
    // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
    updateNextButtonState();
    
    showSuccessMessage('å·²é€‰æ‹©å® ç‰©ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥');
}

// åŠ è½½é£Ÿæåˆ†ç±»
async function loadCategories() {
    try {
        const response = await fetch('/recipe/api/categories');
        if (!response.ok) {
            throw new Error('åŠ è½½åˆ†ç±»å¤±è´¥');
        }
        
        categories = await response.json();
        
        const tabsContainer = document.getElementById('categoryTabs');
        tabsContainer.innerHTML = '';
        
        // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
        const allTab = document.createElement('div');
        allTab.className = 'category-tab active';
        allTab.innerHTML = `
            <i class="fas fa-list"></i>
            å…¨éƒ¨é£Ÿæ
            <span class="category-count">${categories.reduce((sum, cat) => sum + cat.count, 0)}</span>
        `;
        allTab.onclick = () => selectCategory('all', allTab);
        tabsContainer.appendChild(allTab);
        
        // æ·»åŠ åˆ†ç±»é€‰é¡¹
        categories.forEach(category => {
            const tab = document.createElement('div');
            tab.className = 'category-tab';
            tab.innerHTML = `
                <i class="${category.icon}"></i>
                ${category.name}
                <span class="category-count">${category.count}</span>
            `;
            tab.onclick = () => selectCategory(category.value, tab);
            tabsContainer.appendChild(tab);
        });
        
        // é»˜è®¤åŠ è½½å…¨éƒ¨é£Ÿæ
        loadIngredients();
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        showErrorMessage('åŠ è½½é£Ÿæåˆ†ç±»å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
}

// ------- ä¿®æ”¹ï¼šä¿®å¤selectCategoryå‡½æ•°çš„äº‹ä»¶å¤„ç† -------
function selectCategory(categoryValue, tabElement) {
    // æ›´æ–°åˆ†ç±»æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    tabElement.classList.add('active');
    
    // åŠ è½½è¯¥åˆ†ç±»çš„é£Ÿæ
    loadIngredients(categoryValue === 'all' ? null : categoryValue);
}

// åŠ è½½é£Ÿæ
async function loadIngredients(category = null) {
    try {
        const url = new URL('/recipe/api/ingredients', window.location.origin);
        if (category) {
            url.searchParams.append('category', category);
        }
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('åŠ è½½é£Ÿæå¤±è´¥');
        }
        
        const ingredients = await response.json();
        
        const gridContainer = document.getElementById('ingredientsGrid');
        gridContainer.innerHTML = '';
        
        if (ingredients.length === 0) {
            gridContainer.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1/-1; padding: 2rem;">è¯¥åˆ†ç±»æš‚æ— å¯ç”¨é£Ÿæ</div>';
            return;
        }
        
        ingredients.forEach(ingredient => {
            const card = document.createElement('div');
            card.className = 'ingredient-card';
            if (selectedIngredients.some(item => item.id === ingredient.id)) {
                card.classList.add('selected');
            }
            
            card.innerHTML = `
                ${ingredient.seasonality ? `<div class="ingredient-seasonality">${getSeasonalityText(ingredient.seasonality)}</div>` : ''}
                ${ingredient.is_common_allergen ? '<div class="allergen-warning">è¿‡æ•åŸ</div>' : ''}
                <div class="ingredient-image">
                    ${ingredient.image_filename ?
                        `<img src="/static/images/ingredients/${ingredient.image_filename}" alt="${ingredient.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        'æš‚æ— å›¾ç‰‡'
                    }
                </div>
                <div class="ingredient-name">${ingredient.name}</div>
                <div class="ingredient-nutrition">${ingredient.nutrition_summary}</div>
            `;
            
            card.onclick = () => toggleIngredient(ingredient);
            gridContainer.appendChild(card);
        });
        
    } catch (error) {
        console.error('åŠ è½½é£Ÿæå¤±è´¥:', error);
        showErrorMessage('åŠ è½½é£Ÿæå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// åˆ‡æ¢é£Ÿæé€‰æ‹©çŠ¶æ€
function toggleIngredient(ingredient) {
    const existingIndex = selectedIngredients.findIndex(item => item.id === ingredient.id);
    
    if (existingIndex >= 0) {
        // å–æ¶ˆé€‰æ‹©
        selectedIngredients.splice(existingIndex, 1);
        delete ingredientWeights[ingredient.id];
        showSuccessMessage(`å·²ç§»é™¤é£Ÿæï¼š${ingredient.name}`);
    } else {
        // æ·»åŠ é€‰æ‹©
        selectedIngredients.push(ingredient);
        showSuccessMessage(`å·²æ·»åŠ é£Ÿæï¼š${ingredient.name}`);
    }
    
    // æ›´æ–°UI
    updateSelectedIngredientsDisplay();
    updateIngredientsGridSelection();
    updateNextButtonState();
}

// æ›´æ–°å·²é€‰é£Ÿææ˜¾ç¤º
function updateSelectedIngredientsDisplay() {
    const countEl = document.getElementById('selectedCount');
    const listEl = document.getElementById('selectedList');
    
    countEl.textContent = selectedIngredients.length;
    
    if (selectedIngredients.length === 0) {
        listEl.innerHTML = '<div style="color: #666; font-style: italic;">è¿˜æœªé€‰æ‹©ä»»ä½•é£Ÿæ</div>';
    } else {
        listEl.innerHTML = selectedIngredients.map(ingredient => `
            <div class="selected-tag">
                ${ingredient.name}
                <button class="remove-ingredient" onclick="removeIngredient(${ingredient.id})">Ã—</button>
            </div>
        `).join('');
    }
}

// ç§»é™¤é£Ÿæ
function removeIngredient(ingredientId) {
    const ingredient = selectedIngredients.find(item => item.id === ingredientId);
    const index = selectedIngredients.findIndex(item => item.id === ingredientId);
    if (index >= 0) {
        selectedIngredients.splice(index, 1);
        delete ingredientWeights[ingredientId];
        updateSelectedIngredientsDisplay();
        updateIngredientsGridSelection();
        updateNextButtonState();
        
        if (ingredient) {
            showSuccessMessage(`å·²ç§»é™¤é£Ÿæï¼š${ingredient.name}`);
        }
        
        // å¦‚æœåœ¨é‡é‡è®¾ç½®æ­¥éª¤ï¼Œæ›´æ–°é‡é‡è¡¨æ ¼
        if (currentStep === 3) {
            updateWeightTable();
        }
    }
}

// æ›´æ–°é£Ÿæç½‘æ ¼é€‰æ‹©çŠ¶æ€
function updateIngredientsGridSelection() {
    document.querySelectorAll('.ingredient-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    selectedIngredients.forEach(ingredient => {
        const cards = document.querySelectorAll('.ingredient-card');
        cards.forEach(card => {
            const nameEl = card.querySelector('.ingredient-name');
            if (nameEl && nameEl.textContent === ingredient.name) {
                card.classList.add('selected');
            }
        });
    });
}

// è·å–å­£èŠ‚æ€§æ–‡æœ¬
function getSeasonalityText(seasonality) {
    const seasonMap = {
        'all_year': 'å…¨å¹´',
        'spring': 'æ˜¥å­£',
        'summer': 'å¤å­£',
        'autumn': 'ç§‹å­£',
        'winter': 'å†¬å­£',
        'spring,summer': 'æ˜¥å¤',
        'autumn,winter': 'ç§‹å†¬'
    };
    return seasonMap[seasonality] || seasonality;
}

// ------- ä¿®æ”¹ï¼šè¡¥å…¨updateWeightTableå‡½æ•° -------
function updateWeightTable() {
    const tbody = document.getElementById('weightTableBody');
    
    if (selectedIngredients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; font-style: italic;">è¯·å…ˆé€‰æ‹©é£Ÿæ</td></tr>';
        return;
    }
    
    tbody.innerHTML = selectedIngredients.map(ingredient => {
        const weight = ingredientWeights[ingredient.id] || 0;
        const calories = (ingredient.calories * weight / 100).toFixed(1);
        const protein = (ingredient.protein * weight / 100).toFixed(1);
        const fat = (ingredient.fat * weight / 100).toFixed(1);
        const carbs = (ingredient.carbohydrate * weight / 100).toFixed(1);
        
        return `
            <tr>
                <td><strong>${ingredient.name}</strong></td>
                <td>
                    <input type="number" class="weight-input"
                        value="${weight}"
                        min="0" max="1000" step="1"
                        onchange="updateIngredientWeight(${ingredient.id}, this.value)"
                        placeholder="0">
                </td>
                <td>${calories}</td>
                <td>${protein}</td>
                <td>${fat}</td>
                <td>${carbs}</td>
            </tr>
        `;
    }).join('');
}

// ------- æ–°å¢ï¼šæ›´æ–°é£Ÿæé‡é‡å‡½æ•° -------
function updateIngredientWeight(ingredientId, weight) {
    const numWeight = parseFloat(weight) || 0;
    
    if (numWeight < 0) {
        showErrorMessage('é‡é‡ä¸èƒ½ä¸ºè´Ÿæ•°');
        return;
    }
    
    if (numWeight > 1000) {
        showErrorMessage('å•ä¸ªé£Ÿæé‡é‡ä¸èƒ½è¶…è¿‡1000å…‹');
        return;
    }
    
    ingredientWeights[ingredientId] = numWeight;
    updateWeightTable(); // é‡æ–°è®¡ç®—è¥å…»æˆåˆ†
    updateNextButtonState();
    
    if (numWeight > 0) {
        const ingredient = selectedIngredients.find(item => item.id === ingredientId);
        if (ingredient) {
            showSuccessMessage(`å·²è®¾ç½®${ingredient.name}é‡é‡ï¼š${numWeight}å…‹`);
        }
    }
}

// æ›´æ–°ä¸‹ä¸€æ­¥æŒ‰é’®çŠ¶æ€
function updateNextButtonState() {
    const nextBtn = document.getElementById('nextBtn');
    
    switch(currentStep) {
        case 1:
            nextBtn.disabled = !selectedPetId;
            break;
        case 2:
            nextBtn.disabled = selectedIngredients.length === 0;
            break;
        case 3:
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é£Ÿæéƒ½è®¾ç½®äº†é‡é‡
            const hasWeights = selectedIngredients.every(ingredient =>
                ingredientWeights[ingredient.id] && ingredientWeights[ingredient.id] > 0
            );
            nextBtn.disabled = !hasWeights;
            break;
        case 4:
            nextBtn.disabled = !nutritionData;
            break;
        default:
            nextBtn.disabled = false;
    }
}

// ------- æ–°å¢ï¼šæ›´æ–°ä¸Šä¸€æ­¥æŒ‰é’®çŠ¶æ€å‡½æ•° -------
function updatePrevButtonState() {
    const prevBtn = document.getElementById('prevBtn');
    prevBtn.disabled = currentStep === 1;
}

// æ­¥éª¤å¯¼èˆª
function nextStep() {
    if (currentStep < 5) {
        currentStep++;
        updateStepVisibility();
        updateProgressBar();
        
        // ç‰¹æ®Šå¤„ç†
        if (currentStep === 3) {
            updateWeightTable();
        } else if (currentStep === 4) {
            // è‡ªåŠ¨è®¡ç®—è¥å…»æˆåˆ†
            calculateNutrition();
        }
        
        updateNextButtonState();
        updatePrevButtonState();
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepVisibility();
        updateProgressBar();
        updateNextButtonState();
        updatePrevButtonState();
    }
}

// æ›´æ–°æ­¥éª¤å¯è§æ€§
function updateStepVisibility() {
    for (let i = 1; i <= 5; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i === currentStep) {
            stepEl.classList.remove('hidden');
        } else {
            stepEl.classList.add('hidden');
        }
    }
    
    document.getElementById('currentStepText').textContent = currentStep;
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    const nextBtn = document.getElementById('nextBtn');
    if (currentStep === 5) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'block';
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgressBar() {
    const progressPercentage = (currentStep / 5) * 100;
    document.getElementById('progressLineActive').style.width = `${progressPercentage}%`;
    
    // æ›´æ–°æ­¥éª¤åœ†ç‚¹çŠ¶æ€
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
}

// ------- æ–°å¢ï¼šè®¡ç®—è¥å…»æˆåˆ†å‡½æ•° -------
async function calculateNutrition() {
    try {
        const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
            ingredient_id: ingredient.id,
            weight: ingredientWeights[ingredient.id] || 0
        })).filter(item => item.weight > 0);
        
        if (ingredientsWithWeights.length === 0) {
            showErrorMessage('è¯·å…ˆè®¾ç½®é£Ÿæé‡é‡');
            return;
        }
        
        const response = await fetch('/recipe/api/calculate_nutrition', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ingredients: ingredientsWithWeights,
                pet_id: selectedPetId
            })
        });
        
        if (!response.ok) {
            throw new Error('è®¡ç®—è¥å…»æˆåˆ†å¤±è´¥');
        }
        
        nutritionData = await response.json();
        
        // æ˜¾ç¤ºè¥å…»åˆ†æç»“æœ
        displayNutritionAnalysis(nutritionData);
        updateNextButtonState();
        
    } catch (error) {
        console.error('è®¡ç®—è¥å…»æˆåˆ†å¤±è´¥:', error);
        showErrorMessage('è®¡ç®—è¥å…»æˆåˆ†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// ------- æ–°å¢ï¼šæ˜¾ç¤ºè¥å…»åˆ†æç»“æœå‡½æ•° -------
function displayNutritionAnalysis(data) {
    const container = document.getElementById('nutritionAnalysis');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
            <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem;">åŸºç¡€è¥å…»ä¿¡æ¯</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <div>æ€»é‡é‡: <strong>${data.total_weight.toFixed(1)}å…‹</strong></div>
                    <div>æ€»çƒ­é‡: <strong>${data.calories.toFixed(1)}å¡</strong></div>
                    <div>è›‹ç™½è´¨: <strong>${data.protein.toFixed(1)}å…‹</strong></div>
                    <div>è„‚è‚ª: <strong>${data.fat.toFixed(1)}å…‹</strong></div>
                    <div>ç¢³æ°´åŒ–åˆç‰©: <strong>${data.carbohydrate.toFixed(1)}å…‹</strong></div>
                </div>
            </div>
            <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 2px solid #A1B4B2;">
                <h4 style="color: #510B0B; margin-bottom: 1rem;">è¥å…»å¯†åº¦</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <div>æ¯100å…‹çƒ­é‡: <strong>${(data.calories / data.total_weight * 100).toFixed(1)}å¡</strong></div>
                    <div>è›‹ç™½è´¨å æ¯”: <strong>${(data.protein * 4 / data.calories * 100).toFixed(1)}%</strong></div>
                    <div>è„‚è‚ªå æ¯”: <strong>${(data.fat * 9 / data.calories * 100).toFixed(1)}%</strong></div>
                    <div>ç¢³æ°´å æ¯”: <strong>${(data.carbohydrate * 4 / data.calories * 100).toFixed(1)}%</strong></div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 2rem; padding: 1rem; background: #e8f5e8; border-radius: 10px; border-left: 4px solid #4CAF50;">
            <p style="color: #2e7d32; margin: 0;">
                <i class="fas fa-check-circle"></i>
                è¥å…»æˆåˆ†è®¡ç®—å®Œæˆï¼æ‚¨çš„é£Ÿè°±çœ‹èµ·æ¥è¥å…»å‡è¡¡ã€‚
            </p>
        </div>
    `;
}

// ------- æ–°å¢ï¼šä¿å­˜é£Ÿè°±å‡½æ•° -------
async function saveRecipe(isDraft) {
    const recipeName = document.getElementById('recipeName').value.trim();
    const recipeDescription = document.getElementById('recipeDescription').value.trim();
    
    if (!recipeName) {
        showErrorMessage('è¯·è¾“å…¥é£Ÿè°±åç§°');
        return;
    }
    
    if (!selectedPetId || selectedIngredients.length === 0 || !nutritionData) {
        showErrorMessage('è¯·å®Œæˆæ‰€æœ‰æ­¥éª¤');
        return;
    }
    
    const ingredientsWithWeights = selectedIngredients.map(ingredient => ({
        ingredient_id: ingredient.id,
        weight: ingredientWeights[ingredient.id] || 0
    })).filter(item => item.weight > 0);
    
    if (ingredientsWithWeights.length === 0) {
        showErrorMessage('è¯·è®¾ç½®é£Ÿæé‡é‡');
        return;
    }
    
    try {
        const response = await fetch('/recipe/api/save_recipe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: recipeName,
                description: recipeDescription,
                pet_id: selectedPetId,
                ingredients: ingredientsWithWeights,
                is_draft: isDraft
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showErrorMessage(data.error);
            return;
        }
        
        showSuccessMessage(data.message);
        
        // è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒæˆ–é£Ÿè°±è¯¦æƒ…é¡µ
        setTimeout(() => {
            window.location.href = '/user_center';
        }, 2000);
        
    } catch (error) {
        console.error('ä¿å­˜é£Ÿè°±å¤±è´¥:', error);
        showErrorMessage('ä¿å­˜é£Ÿè°±å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// ------- æ–°å¢ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å‡½æ•° -------
function showSuccessMessage(message) {
    // ç§»é™¤ç°æœ‰æ¶ˆæ¯
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // åˆ›å»ºæ–°æ¶ˆæ¯
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 3000);
}

// ------- æ–°å¢ï¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å‡½æ•° -------
function showErrorMessage(message) {
    // ç§»é™¤ç°æœ‰æ¶ˆæ¯
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // åˆ›å»ºæ–°æ¶ˆæ¯
    const msgEl = document.createElement('div');
    msgEl.className = 'success-message show type-warning';
    msgEl.textContent = message;
    document.body.appendChild(msgEl);
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        msgEl.classList.add('hide');
        setTimeout(() => msgEl.remove(), 500);
    }, 5000);
}

// ------- æ–°å¢ï¼šé”®ç›˜å¿«æ·é”®æ”¯æŒ -------
document.addEventListener('keydown', function(e) {
    if (e.altKey) {
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (currentStep > 1) previousStep();
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (currentStep < 5 && !document.getElementById('nextBtn').disabled) nextStep();
                break;
        }
    }
});

// ------- æ–°å¢ï¼šé¡µé¢ç¦»å¼€æé†’ -------
window.addEventListener('beforeunload', function(e) {
    if (selectedIngredients.length > 0 || selectedPetId) {
        e.preventDefault();
        e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„é£Ÿè°±æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
    }
});
</script>

{% endblock %}